<!DOCTYPE html>
<html lang="zh-CN,en,zh-TW,default">
    <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/#5.8.0'>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="Volantis" content="5.8.0">
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
  <link rel="canonical" href="http://example.com/2023/07/31/nginx/"/>
  <!-- 渲染优化 -->
    <meta http-equiv='x-dns-prefetch-control' content='on' />
      <link rel='dns-prefetch' href='https://unpkg.com'>
      <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Content-Security-Policy" content=" default-src 'self' https:; block-all-mixed-content; base-uri 'self' https:; form-action 'self' https:; worker-src 'self' https:; connect-src 'self' https: *; img-src 'self' data: https: *; media-src 'self' https: *; font-src 'self' data: https: *; frame-src 'self' https: *; manifest-src 'self' https: *; child-src https:; script-src 'self' https: 'unsafe-inline' *; style-src 'self' https: 'unsafe-inline' *; ">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <!-- import head_begin begin -->
  <!-- import head_begin end -->
  <!-- Custom Files headBegin begin-->
  
  <!-- Custom Files headBegin end-->
  <!-- front-matter head_begin begin -->
  <!-- front-matter head_begin end -->
    <link rel="shortcut icon" type='image/x-icon' href="https://gcore.jsdelivr.net/gh/xaoxuu/assets@master/favicon/favicon.ico">
  <link rel="preload" href="/css/style.css" as="style">
  <link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <!-- feed -->
  <!-- 页面元数据 -->
  <title>Nginx - 天天</title>
  <meta name="keywords" content="null">
  <meta desc name="description" content="blog - Luhumu - 天天">
  
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="http://example.com/2023/07/31/Nginx/index.html">
<meta property="og:site_name" content="天天">
<meta property="og:description" content="NginxNginx简介背景介绍Nginx（“engine x”）一个具有高性能的【HTTP】和【反向代理】的【WEB服务器】，同时也是一个【POP3&#x2F;SMTP&#x2F;IMAP代理服务器】，是由伊戈尔·赛索耶夫(俄罗斯人)使用C语言编写的，Nginx的第一个版本是2004年10月4号发布的0.1.0版本。另外值得一提的是伊戈尔·赛索耶夫将Nginx的源码进行了开源，这也为Nginx的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
<meta property="article:published_time" content="2023-07-31T09:31:12.711Z">
<meta property="article:modified_time" content="2023-07-31T09:58:44.362Z">
<meta property="article:author" content="Luhumu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
  <style>
    /* 首屏样式 */
    #safearea {
  display: none;
}
:root {
  --color-site-body: #f4f4f4;
  --color-site-bg: #f4f4f4;
  --color-site-inner: #fff;
  --color-site-footer: #666;
  --color-card: #fff;
  --color-text: #444;
  --color-block: #f6f6f6;
  --color-inlinecode: #c74f00;
  --color-codeblock: #fff7ea;
  --color-h1: #3a3a3a;
  --color-h2: #3a3a3a;
  --color-h3: #333;
  --color-h4: #444;
  --color-h5: #555;
  --color-h6: #666;
  --color-p: #444;
  --color-list: #666;
  --color-list-hl: #30ad91;
  --color-meta: #888;
  --color-read-bkg: #e0d8c8;
  --color-read-post: #f8f1e2;
  --color-copyright-bkg: #f5f5f5;
}
* {
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  outline: none;
  margin: 0;
  padding: 0;
}
*::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
*::-webkit-scrollbar-track-piece {
  background: transparent;
}
*::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
*::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
html {
  color: var(--color-text);
  width: 100%;
  height: 100%;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  font-size: 16px;
}
html >::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
html >::-webkit-scrollbar-track-piece {
  background: transparent;
}
html >::-webkit-scrollbar-thumb {
  background: #54b5a0 linear-gradient(45deg, rgba(255,255,255,0.4) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.4) 75%, transparent 75%, transparent);
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
html >::-webkit-scrollbar-thumb:hover {
  background: #54b5a0 linear-gradient(45deg, rgba(255,255,255,0.4) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.4) 75%, transparent 75%, transparent);
}
body {
  background-color: var(--color-site-body);
  text-rendering: optimizelegibility;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  line-height: 1.6;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}
body.modal-active {
  overflow: hidden;
}
@media screen and (max-width: 680px) {
  body.modal-active {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
}
a {
  color: #2092ec;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
a:hover {
  color: #ff5722;
}
a:active,
a:hover {
  outline: 0;
}
ul,
ol {
  padding-left: 0;
}
ul li,
ol li {
  list-style: none;
}
header {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
img {
  border: 0;
  background: none;
  max-width: 100%;
}
svg:not(:root) {
  overflow: hidden;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  height: 0;
  border: 0;
  border-radius: 1px;
  -webkit-border-radius: 1px;
  border-bottom: 1px solid rgba(68,68,68,0.1);
}
button,
input {
  color: inherit;
  font: inherit;
  margin: 0;
}
button {
  overflow: visible;
  text-transform: none;
  -webkit-appearance: button;
  cursor: pointer;
}
@supports (backdrop-filter: blur(20px)) {
  .blur {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(200%) blur(20px);
  }
}
.shadow {
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.shadow.floatable {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.shadow.floatable:hover {
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
}
#l_cover {
  min-height: 64px;
}
.cover-wrapper {
  top: 0;
  left: 0;
  max-width: 100%;
  height: 100vh;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  align-self: center;
  align-content: center;
  color: var(--color-site-inner);
  padding: 0 16px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  position: relative;
  overflow: hidden;
  margin-bottom: -100px;
}
.cover-wrapper .cover-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  background-position: center;
  background-size: cover;
  -webkit-background-size: cover;
  -moz-background-size: cover;
}
.cover-wrapper .cover-bg.lazyload:not(.loaded) {
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
}
.cover-wrapper .cover-bg.lazyload.loaded {
  animation-delay: 0s;
  animation-duration: 0.5s;
  animation-fill-mode: forwards;
  animation-timing-function: ease-out;
  animation-name: fadeIn;
}
@-moz-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  z-index: 1;
  position: relative;
  width: 100%;
  height: 100%;
}
.cover-wrapper#full {
  height: calc(100vh + 100px);
  padding-bottom: 100px;
}
.cover-wrapper#half {
  max-height: 640px;
  min-height: 400px;
  height: calc(36vh - 64px + 200px);
}
.cover-wrapper #scroll-down {
  width: 100%;
  height: 64px;
  position: absolute;
  bottom: 100px;
  text-align: center;
  cursor: pointer;
}
.cover-wrapper #scroll-down .scroll-down-effects {
  color: #fff;
  font-size: 24px;
  line-height: 64px;
  position: absolute;
  width: 24px;
  left: calc(50% - 12px);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  animation: scroll-down-effect 1.5s infinite;
  -webkit-animation: scroll-down-effect 1.5s infinite;
  -khtml-animation: scroll-down-effect 1.5s infinite;
  -moz-animation: scroll-down-effect 1.5s infinite;
  -o-animation: scroll-down-effect 1.5s infinite;
  -ms-animation: scroll-down-effect 1.5s infinite;
}
@-moz-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  margin-top: 64px;
  margin-bottom: 100px;
}
.cover-wrapper .cover-body,
.cover-wrapper .cover-body .top,
.cover-wrapper .cover-body .bottom {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  max-width: 100%;
}
.cover-wrapper .cover-body .bottom {
  margin-top: 32px;
}
.cover-wrapper .cover-body .title {
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
  font-size: 3.125rem;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.cover-wrapper .cover-body .subtitle {
  font-size: 20px;
}
.cover-wrapper .cover-body .logo {
  max-height: 120px;
  max-width: calc(100% - 4 * 16px);
}
@media screen and (min-height: 1024px) {
  .cover-wrapper .cover-body .title {
    font-size: 3rem;
  }
  .cover-wrapper .cover-body .subtitle {
    font-size: 1.05rem;
  }
  .cover-wrapper .cover-body .logo {
    max-height: 150px;
  }
}
.cover-wrapper .cover-body .m_search {
  position: relative;
  max-width: calc(100% - 16px);
  width: 320px;
  vertical-align: middle;
}
.cover-wrapper .cover-body .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  width: 100%;
}
.cover-wrapper .cover-body .m_search .icon,
.cover-wrapper .cover-body .m_search .input {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.cover-wrapper .cover-body .m_search .icon {
  position: absolute;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  line-height: 2.5rem;
  width: 32px;
  top: 0;
  left: 5px;
  color: rgba(68,68,68,0.75);
}
.cover-wrapper .cover-body .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  height: 2.5rem;
  width: 100%;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  font-size: 0.875rem;
  -webkit-appearance: none;
  padding-left: 36px;
  border-radius: 1.4rem;
  -webkit-border-radius: 1.4rem;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(10px);
  border: none;
  color: var(--color-text);
}
@media screen and (max-width: 500px) {
  .cover-wrapper .cover-body .m_search .input {
    padding-left: 36px;
  }
}
.cover-wrapper .cover-body .m_search .input:hover {
  background: rgba(255,255,255,0.8);
}
.cover-wrapper .cover-body .m_search .input:focus {
  background: #fff;
}
.cover-wrapper .list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  flex-wrap: wrap;
  -webkit-flex-wrap: wrap;
  -khtml-flex-wrap: wrap;
  -moz-flex-wrap: wrap;
  -o-flex-wrap: wrap;
  -ms-flex-wrap: wrap;
  align-items: stretch;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.cover-wrapper .list-h a {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 0;
  -ms-flex: 1 0;
  flex: 1 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  font-weight: 600;
}
.cover-wrapper .list-h a img {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  border-radius: 2px;
  -webkit-border-radius: 2px;
  margin: 4px;
  min-width: 40px;
  max-width: 44px;
}
@media screen and (max-width: 768px) {
  .cover-wrapper .list-h a img {
    min-width: 36px;
    max-width: 40px;
  }
}
@media screen and (max-width: 500px) {
  .cover-wrapper .list-h a img {
    margin: 2px 4px;
    min-width: 32px;
    max-width: 36px;
  }
}
@media screen and (max-width: 375px) {
  .cover-wrapper .list-h a img {
    min-width: 28px;
    max-width: 32px;
  }
}
.cover-wrapper {
  max-width: 100%;
}
.cover-wrapper.search .bottom .menu {
  margin-top: 16px;
}
.cover-wrapper.search .bottom .menu .list-h a {
  white-space: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  align-items: baseline;
  padding: 2px;
  margin: 4px;
  color: var(--color-site-inner);
  opacity: 0.75;
  -webkit-opacity: 0.75;
  -moz-opacity: 0.75;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  border-bottom: 2px solid transparent;
}
.cover-wrapper.search .bottom .menu .list-h a i {
  margin-right: 4px;
}
.cover-wrapper.search .bottom .menu .list-h a p {
  font-size: 0.9375rem;
}
.cover-wrapper.search .bottom .menu .list-h a:hover,
.cover-wrapper.search .bottom .menu .list-h a.active,
.cover-wrapper.search .bottom .menu .list-h a:active {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
  border-bottom: 2px solid var(--color-site-inner);
}
@font-face {
  font-family: 'UbuntuMono';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
@font-face {
  font-family: 'Varela Round';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
.l_header {
  position: fixed;
  z-index: 1000;
  top: 0;
  width: 100%;
  height: 64px;
  background: var(--color-card);
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.l_header.auto {
  transition: opacity 0.4s ease;
  -webkit-transition: opacity 0.4s ease;
  -khtml-transition: opacity 0.4s ease;
  -moz-transition: opacity 0.4s ease;
  -o-transition: opacity 0.4s ease;
  -ms-transition: opacity 0.4s ease;
  visibility: hidden;
}
.l_header.auto.show {
  opacity: 1 !important;
  -webkit-opacity: 1 !important;
  -moz-opacity: 1 !important;
  visibility: visible;
}
.l_header .container {
  margin-left: 16px;
  margin-right: 16px;
}
.l_header #wrapper {
  height: 100%;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.l_header #wrapper .nav-main,
.l_header #wrapper .nav-sub {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  justify-content: space-between;
  -webkit-justify-content: space-between;
  -khtml-justify-content: space-between;
  -moz-justify-content: space-between;
  -o-justify-content: space-between;
  -ms-justify-content: space-between;
  align-items: center;
}
.l_header #wrapper .nav-main {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.l_header #wrapper.sub .nav-main {
  transform: translateY(-64px);
  -webkit-transform: translateY(-64px);
  -khtml-transform: translateY(-64px);
  -moz-transform: translateY(-64px);
  -o-transform: translateY(-64px);
  -ms-transform: translateY(-64px);
}
.l_header #wrapper .nav-sub {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
  height: 64px;
  width: calc(100% - 2 * 16px);
  position: absolute;
}
.l_header #wrapper .nav-sub ::-webkit-scrollbar {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (min-width: 2048px) {
  .l_header #wrapper .nav-sub {
    max-width: 55vw;
    margin: auto;
  }
}
.l_header #wrapper.sub .nav-sub {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
}
.l_header #wrapper .title {
  position: relative;
  color: var(--color-text);
  padding-left: 24px;
  max-height: 64px;
}
.l_header #wrapper .nav-main .title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
  line-height: 64px;
  padding: 0 24px;
  font-size: 1.25rem;
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
}
.l_header #wrapper .nav-main .title img {
  height: 64px;
}
.l_header .nav-sub {
  max-width: 1080px;
  margin: auto;
}
.l_header .nav-sub .title {
  font-weight: bold;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  line-height: 1.2;
  max-height: 64px;
  white-space: normal;
  flex-shrink: 1;
}
.l_header .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  line-height: 64px;
  align-items: center;
}
.l_header .switcher .s-toc {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (max-width: 768px) {
  .l_header .switcher .s-toc {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
  }
}
.l_header .switcher >li {
  height: 48px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  margin: 2px;
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li {
    margin: 0 1px;
    height: 48px;
  }
}
.l_header .switcher >li >a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  align-items: center;
  width: 48px;
  height: 48px;
  padding: 0.85em 1.1em;
  border-radius: 100px;
  -webkit-border-radius: 100px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  color: #3dd9b6;
}
.l_header .switcher >li >a:hover {
  border: none;
}
.l_header .switcher >li >a.active,
.l_header .switcher >li >a:active {
  border: none;
  background: var(--color-site-bg);
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li >a {
    width: 36px;
    height: 48px;
  }
}
.l_header .nav-sub .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
}
.l_header .m_search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  height: 64px;
  width: 240px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (max-width: 1024px) {
  .l_header .m_search {
    width: 44px;
    min-width: 44px;
  }
  .l_header .m_search input::placeholder {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
  }
  .l_header .m_search:hover {
    width: 240px;
  }
  .l_header .m_search:hover input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (min-width: 500px) {
  .l_header .m_search:hover .input {
    width: 100%;
  }
  .l_header .m_search:hover .input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search {
    min-width: 0;
  }
  .l_header .m_search input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.l_header .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  width: 100%;
  align-items: center;
}
.l_header .m_search .icon {
  position: absolute;
  width: 36px;
  left: 5px;
  color: var(--color-meta);
}
@media screen and (max-width: 500px) {
  .l_header .m_search .icon {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
.l_header .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.3;
  width: 100%;
  color: var(--color-text);
  background: #fafafa;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  padding-left: 40px;
  font-size: 0.875rem;
  border-radius: 8px;
  -webkit-border-radius: 8px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (min-width: 500px) {
  .l_header .m_search .input:focus {
    box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
    -webkit-box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search .input {
    background: var(--color-block);
    padding-left: 8px;
    border: none;
  }
  .l_header .m_search .input:hover,
  .l_header .m_search .input:focus {
    border: none;
  }
}
@media (max-width: 500px) {
  .l_header .m_search {
    left: 0;
    width: 0;
    overflow: hidden;
    position: absolute;
    background: #fff;
    transition: all 0.28s ease;
    -webkit-transition: all 0.28s ease;
    -khtml-transition: all 0.28s ease;
    -moz-transition: all 0.28s ease;
    -o-transition: all 0.28s ease;
    -ms-transition: all 0.28s ease;
  }
  .l_header .m_search .input {
    border-radius: 32px;
    -webkit-border-radius: 32px;
    margin-left: 16px;
    padding-left: 16px;
  }
  .l_header.z_search-open .m_search {
    width: 100%;
  }
  .l_header.z_search-open .m_search .input {
    width: calc(100% - 120px);
  }
}
ul.m-pc >li>a {
  color: inherit;
  border-bottom: 2px solid transparent;
}
ul.m-pc >li>a:active,
ul.m-pc >li>a.active {
  border-bottom: 2px solid #3dd9b6;
}
ul.m-pc li:hover >ul.list-v,
ul.list-v li:hover >ul.list-v {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.nav-list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  align-items: stretch;
}
ul.nav-list-h>li {
  position: relative;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  height: 100%;
  line-height: 2.4;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
ul.nav-list-h>li >a {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-weight: 600;
}
ul.list-v {
  z-index: 1;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: absolute;
  background: var(--color-card);
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  margin-top: -6px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  padding: 8px 0;
}
ul.list-v.show {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.list-v hr {
  margin-top: 8px;
  margin-bottom: 8px;
}
ul.list-v >li {
  white-space: nowrap;
  word-break: keep-all;
}
ul.list-v >li.header {
  font-size: 0.78125rem;
  font-weight: bold;
  line-height: 2em;
  color: var(--color-meta);
  margin: 8px 16px 4px;
}
ul.list-v >li.header i {
  margin-right: 8px;
}
ul.list-v >li ul {
  margin-left: 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: -40px;
}
ul.list-v .aplayer-container {
  min-height: 64px;
  padding: 6px 16px;
}
ul.list-v >li>a {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  color: var(--color-list);
  font-size: 0.875rem;
  font-weight: bold;
  line-height: 36px;
  padding: 0 20px 0 16px;
  text-overflow: ellipsis;
  margin: 0 4px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
@media screen and (max-width: 1024px) {
  ul.list-v >li>a {
    line-height: 40px;
  }
}
ul.list-v >li>a >i {
  margin-right: 8px;
}
ul.list-v >li>a:active,
ul.list-v >li>a.active {
  color: var(--color-list-hl);
}
ul.list-v >li>a:hover {
  color: var(--color-list-hl);
  background: var(--color-site-bg);
}
.l_header .menu >ul>li>a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding: 0 8px;
}
.l_header .menu >ul>li>a >i {
  margin-right: 4px;
}
.l_header ul.nav-list-h>li {
  color: var(--color-list);
  line-height: 64px;
}
.l_header ul.nav-list-h>li >a {
  max-height: 64px;
  overflow: hidden;
  color: inherit;
}
.l_header ul.nav-list-h>li >a:active,
.l_header ul.nav-list-h>li >a.active {
  color: #3dd9b6;
}
.l_header ul.nav-list-h>li:hover>a {
  color: var(--color-list-hl);
}
.l_header ul.nav-list-h>li i.music {
  animation: rotate-effect 1.5s linear infinite;
  -webkit-animation: rotate-effect 1.5s linear infinite;
  -khtml-animation: rotate-effect 1.5s linear infinite;
  -moz-animation: rotate-effect 1.5s linear infinite;
  -o-animation: rotate-effect 1.5s linear infinite;
  -ms-animation: rotate-effect 1.5s linear infinite;
}
@-moz-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-webkit-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-o-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
.menu-phone li ul.list-v {
  right: calc(100% - 0.5 * 16px);
}
.menu-phone li ul.list-v ul {
  right: calc(100% - 0.5 * 16px);
}
#wrapper {
  max-width: 1080px;
  margin: auto;
}
@media screen and (min-width: 2048px) {
  #wrapper {
    max-width: 55vw;
  }
}
#wrapper .menu {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 1;
  -ms-flex: 1 1;
  flex: 1 1;
  margin: 0 16px 0 0;
}
#wrapper .menu .list-v ul {
  left: calc(100% - 0.5 * 16px);
}
.menu-phone {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: 16px;
  right: 8px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.menu-phone ul {
  right: calc(100% - 0.5 * 16px);
}
@media screen and (max-width: 500px) {
  .menu-phone {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: block;
  }
}
.l_header {
  max-width: 65vw;
  left: calc((100% - 65vw) * 0.5);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
@media screen and (max-width: 2048px) {
  .l_header {
    max-width: 1112px;
    left: calc((100% - 1112px) * 0.5);
  }
}
@media screen and (max-width: 1112px) {
  .l_header {
    left: 0;
    border-radius: 0;
    -webkit-border-radius: 0;
    max-width: 100%;
  }
}
@media screen and (max-width: 500px) {
  .l_header .container {
    margin-left: 0;
    margin-right: 0;
  }
  .l_header #wrapper .nav-main .title {
    padding-left: 16px;
    padding-right: 16px;
  }
  .l_header #wrapper .nav-sub {
    width: 100%;
  }
  .l_header #wrapper .nav-sub .title {
    overflow-y: scroll;
    margin-top: 2px;
    padding: 8px 16px;
  }
  .l_header #wrapper .switcher {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
    margin-right: 8px;
  }
  .l_header .menu {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
@media screen and (max-width: 500px) {
  .list-v li {
    max-width: 270px;
  }
}
#u-search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 60px 20px;
  z-index: 1001;
}
@media screen and (max-width: 680px) {
  #u-search {
    padding: 0px;
  }
}

  </style>
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
    '.kill-t{'+
      'font-size: 2rem;'+
    '}'+
    '.kill-c{'+
      'font-size: 1.2rem;'+
    '}'+
		'#l_header,#l_body{'+
			'display: none;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        `<span class="kill-t"><b>抱歉，您的浏览器无法访问本站</b></span><br/>`+
        `<span class="kill-c">微软已经于2016年终止了对 Internet Explorer (IE) 10 及更早版本的支持，<br/>继续使用存在极大的安全隐患，请使用当代主流的浏览器进行访问。</span><br/>`+
        `<a target="_blank" rel="noopener" href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/"><strong>了解详情 ></strong></a>`+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
    .kill-t{
      font-size: 2rem;
    }
    .kill-c{
      font-size: 1.2rem;
    }
		#l_header,#l_body{
			display: none;
		}
	</style>
    <div class="kill-noscript">
        <span class="kill-t"><b>抱歉，您的浏览器无法访问本站</b></span><br/>
        <span class="kill-c">本页面需要浏览器支持（启用）JavaScript</span><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=启用JavaScript"><strong>了解详情 ></strong></a>
    </div>
</noscript>


  <script>
  /************这个文件存放不需要重载的全局变量和全局函数*********/
  window.volantis = {}; // volantis 全局变量
  volantis.debug = "env"; // 调试模式
  volantis.dom = {}; // 页面Dom see: /source/js/app.js etc.

  volantis.GLOBAL_CONFIG ={
    debug: "env",
    cdn: {"js":{"app":"/js/app.js","parallax":"/js/plugins/parallax.js","rightMenu":"/js/plugins/rightMenu.js","rightMenus":"/js/plugins/rightMenus.js","sites":"/js/plugins/tags/sites.js","friends":"/js/plugins/tags/friends.js","contributors":"/js/plugins/tags/contributors.js","search":"/js/search/hexo.js"},"css":{"style":"/css/style.css"}},
    default: {"avatar":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg","link":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/link/8f277b4ee0ecd.svg","cover":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg","image":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/image/2659360.svg"},
    lastupdate: new Date(1693732071565),
    sidebar: {
      for_page: ["blogger","category","tagcloud","donate"],
      for_post: ["toc"],
      webinfo: {
        lastupd: {
          enable: true,
          friendlyShow: true
        },
        runtime: {
          data: "2020/01/01",
          unit: "天"
        }
      }
    },
    plugins: {
      message: {"enable":true,"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/css/iziToast.min.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/js/iziToast.min.js","icon":{"default":"fa-solid fa-info-circle light-blue","quection":"fa-solid fa-question-circle light-blue"},"time":{"default":5000,"quection":20000},"position":"topRight","transitionIn":"bounceInLeft","transitionOut":"fadeOutRight","titleColor":"var(--color-text)","messageColor":"var(--color-text)","backgroundColor":"var(--color-card)","zindex":2147483647,"copyright":{"enable":true,"title":"知识共享许可协议","message":"请遵守 CC BY-NC-SA 4.0 协议。","icon":"far fa-copyright light-blue"},"aplayer":{"enable":true,"play":"fa-solid fa-play","pause":"fa-solid fa-pause"},"rightmenu":{"enable":true,"notice":true}},
      fancybox: {"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.umd.js"},
      
      aplayer: {
        id: 461471417,
        enable:true
      },
      
      
      
    }
  }

  /******************** volantis.EventListener ********************************/
  // 事件监听器 see: /source/js/app.js
  volantis.EventListener = {}
  // 这里存放pjax切换页面时将被移除的事件监听器
  volantis.EventListener.list = []
  //构造方法
  function volantisEventListener(type, f, ele) {
    this.type = type
    this.f = f
    this.ele = ele
  }
  // 移除事件监听器
  volantis.EventListener.remove = () => {
    volantis.EventListener.list.forEach(function (i) {
      i.ele.removeEventListener(i.type, i.f, false)
    })
    volantis.EventListener.list = []
  }
  /******************** volantis.dom.$ ********************************/
  // 注：这里没有选择器，也没有forEach一次只处理一个dom，这里重新封装主题常用的dom方法，返回的是dom对象，对象包含了以下方法，同时保留dom的原生API
  function volantisDom(ele) {
    if (!ele) ele = document.createElement("div")
    this.ele = ele;
    // ==============================================================
    this.ele.find = (c) => {
      let q = this.ele.querySelector(c)
      if (q)
        return new volantisDom(q)
    }
    // ==============================================================
    this.ele.hasClass = (c) => {
      return this.ele.className.match(new RegExp('(\\s|^)' + c + '(\\s|$)'));
    }
    this.ele.addClass = (c) => {
      this.ele.classList.add(c);
      return this.ele
    }
    this.ele.removeClass = (c) => {
      this.ele.classList.remove(c);
      return this.ele
    }
    this.ele.toggleClass = (c) => {
      if (this.ele.hasClass(c)) {
        this.ele.removeClass(c)
      } else {
        this.ele.addClass(c)
      }
      return this.ele
    }
    // ==============================================================
    // 参数 r 为 true 表示pjax切换页面时事件监听器将被移除，false不移除
    this.ele.on = (c, f, r = 1) => {
      this.ele.addEventListener(c, f, false)
      if (r) {
        volantis.EventListener.list.push(new volantisEventListener(c, f, this.ele))
      }
      return this.ele
    }
    this.ele.click = (f, r) => {
      this.ele.on("click", f, r)
      return this.ele
    }
    this.ele.scroll = (f, r) => {
      this.ele.on("scroll", f, r)
      return this.ele
    }
    // ==============================================================
    this.ele.html = (c) => {
      // if(c=== undefined){
      //   return this.ele.innerHTML
      // }else{
      this.ele.innerHTML = c
      return this.ele
      // }
    }
    // ==============================================================
    this.ele.hide = (c) => {
      this.ele.style.display = "none"
      return this.ele
    }
    this.ele.show = (c) => {
      this.ele.style.display = "block"
      return this.ele
    }
    // ==============================================================
    return this.ele
  }
  volantis.dom.$ = (ele) => {
    return !!ele ? new volantisDom(ele) : null;
  }
  /******************** RunItem ********************************/
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = ()=>{
          volantis.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) =>{
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index,1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }
  /******************** Pjax ********************************/
  // /layout/_plugins/pjax/index.ejs
  // volantis.pjax.send(callBack[,"callBackName"]) 传入pjax:send回调函数
  // volantis.pjax.push(callBack[,"callBackName"]) 传入pjax:complete回调函数
  // volantis.pjax.error(callBack[,"callBackName"]) 传入pjax:error回调函数
  volantis.pjax = {};
  volantis.pjax.method = {
    complete: new RunItem(),
    error: new RunItem(),
    send: new RunItem(),
  };
  volantis.pjax = Object.assign(volantis.pjax, {
    push: volantis.pjax.method.complete.push,
    error: volantis.pjax.method.error.push,
    send: volantis.pjax.method.send.push,
  });
  /******************** RightMenu ********************************/
  // volantis.rightmenu.handle(callBack[,"callBackName"]) 外部菜单项控制
  // 可在 volantis.mouseEvent 处获取右键事件
  volantis.rightmenu = {};
  volantis.rightmenu.method = {
    handle: new RunItem(),
  }
  volantis.rightmenu = Object.assign(volantis.rightmenu, {
    handle: volantis.rightmenu.method.handle.push,
  });
  /********************  Dark Mode  ********************************/
  // /layout/_partial/scripts/darkmode.ejs
  // volantis.dark.mode 当前模式 dark or light
  // volantis.dark.toggle() 暗黑模式触发器
  // volantis.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  volantis.dark = {};
  volantis.dark.method = {
    toggle: new RunItem(),
  };
  volantis.dark = Object.assign(volantis.dark, {
    push: volantis.dark.method.toggle.push,
  });
  /********************  Message  ********************************/
  // VolantisApp.message
  /********************  isMobile  ********************************/
  // /source/js/app.js
  // volantis.isMobile
  // volantis.isMobileOld
  /********************脚本动态加载函数********************************/
  // volantis.js(src, cb)  cb 可以传入onload回调函数 或者 JSON对象 例如: volantis.js("src", ()=>{}) 或 volantis.js("src", {defer:true,onload:()=>{}})
  // volantis.css(src)

  // 返回Promise对象，如下方法同步加载资源，这利于处理文件资源之间的依赖关系，例如：APlayer 需要在 MetingJS 之前加载
  // (async () => {
  //     await volantis.js("...theme.plugins.aplayer.js.aplayer...")
  //     await volantis.js("...theme.plugins.aplayer.js.meting...")
  // })();

  // 已经加入了setTimeout
  volantis.js = (src, cb) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }
  volantis.css = (src) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  }
  /********************按需加载的插件********************************/
  // volantis.import.jQuery().then(()=>{})
  volantis.import = {
    jQuery: () => {
      if (typeof jQuery == "undefined") {
        return volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/jquery/dist/jquery.min.js")
      } else {
        return new Promise(resolve => {
          resolve()
        });
      }
    }
  }
  /********************** requestAnimationFrame ********************************/
  // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
  // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
  volantis.requestAnimationFrame = (fn)=>{
    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
    }
    window.requestAnimationFrame(fn)
  }
  /************************ layoutHelper *****************************************/
  volantis.layoutHelper = (helper, html, opt)=>{
    opt = Object.assign({clean:false, pjax:true}, opt)
    function myhelper(helper, html, clean) {
      volantis.tempDiv = document.createElement("div");
      volantis.tempDiv.innerHTML = html;
      let layoutHelper = document.querySelector("#layoutHelper-"+helper)
      if (layoutHelper) {
        if (clean) {
          layoutHelper.innerHTML = ""
        }
        layoutHelper.append(volantis.tempDiv);
      }
    }
    myhelper(helper, html, opt.clean)
    if (opt.pjax) {
      volantis.pjax.push(()=>{
        myhelper(helper, html, opt.clean)
      },"layoutHelper-"+helper)
    }
  }
  /****************************** 滚动事件处理 ****************************************/
  volantis.scroll = {
    engine: new RunItem(),
    unengine: new RunItem(),
  };
  volantis.scroll = Object.assign(volantis.scroll, {
    push: volantis.scroll.engine.push,
  });
  // 滚动条距离顶部的距离
  volantis.scroll.getScrollTop = () =>{
    let scrollPos;
    if (window.pageYOffset) {
      scrollPos = window.pageYOffset;
    } else if (document.compatMode && document.compatMode != 'BackCompat') {
      scrollPos = document.documentElement.scrollTop;
    } else if (document.body) {
      scrollPos = document.body.scrollTop;
    }
    return scrollPos;
  }
  // 使用 requestAnimationFrame 处理滚动事件
  // `volantis.scroll.del` 中存储了一个数值, 该数值检测一定时间间隔内滚动条滚动的位移, 数值的检测频率是浏览器的刷新频率. 数值为正数时, 表示向下滚动. 数值为负数时, 表示向上滚动.
  volantis.scroll.handleScrollEvents = () => {
    volantis.scroll.lastScrollTop = volantis.scroll.getScrollTop()
    function loop() {
      const scrollTop = volantis.scroll.getScrollTop();
      if (volantis.scroll.lastScrollTop !== scrollTop) {
        volantis.scroll.del = scrollTop - volantis.scroll.lastScrollTop;
        volantis.scroll.lastScrollTop = scrollTop;
        // if (volantis.scroll.del > 0) {
        //   console.log("向下滚动");
        // } else {
        //   console.log("向上滚动");
        // }
        // 注销过期的unengine未滚动事件
        volantis.scroll.unengine.list=[]
        volantis.scroll.engine.start();
      }else{
        volantis.scroll.unengine.start();
      }
      volantis.requestAnimationFrame(loop)
    }
    volantis.requestAnimationFrame(loop)
  }
  volantis.scroll.handleScrollEvents()
  volantis.scroll.ele = null;
  // 触发页面滚动至目标元素位置
  volantis.scroll.to = (ele, option = {}) => {
    if (!ele) return;
    volantis.scroll.ele = ele;
    // 默认配置
    opt = {
      top: ele.getBoundingClientRect().top + document.documentElement.scrollTop,
      behavior: "smooth"
    }
    // 定义配置
    if ("top" in option) {
      opt.top = option.top
    }
    if ("behavior" in option) {
      opt.behavior = option.behavior
    }
    if ("addTop" in option) {
      opt.top += option.addTop
    }
    if (!("observerDic" in option)) {
      option.observerDic = 100
    }
    // 滚动
    window.scrollTo(opt);
    // 监视器
    // 监视并矫正元素滚动到指定位置
    // 用于处理 lazyload 引起的 cls 导致的定位失败问题
    // option.observer = false
    if (option.observer) {
      setTimeout(() => {
        if (volantis.scroll.ele != ele) {
          return
        }
        volantis.scroll.unengine.push(() => {
          let me = ele.getBoundingClientRect().top
          if(!(me >= -option.observerDic && me <= option.observerDic)){
            volantis.scroll.to(ele, option)
          }
          volantis.scroll.unengine.remove("unengineObserver")
        },"unengineObserver")
      },1000)
    }
  }
  /********************** Content Visibility ********************************/
  // 见 source/css/first.styl 如果遇到任何问题 删除 .post-story 即可
  // 一个元素被声明 content-visibility 属性后 如果元素不在 viewport 中 浏览器不会计算其后代元素样式和属性 从而节省 Style & Layout 耗时
  // content-visibility 的副作用: 锚点失效 等等(实验初期 暂不明确), 使用此方法清除样式
  volantis.cleanContentVisibility = ()=>{
    if (document.querySelector(".post-story")) {
      console.log("cleanContentVisibility");
      document.querySelectorAll(".post-story").forEach(e=>{
        e.classList.remove("post-story")
      })
    }
  }
  /******************************************************************************/
  /******************************************************************************/
  /******************************************************************************/
  //图像加载出错时的处理
  function errorImgAvatar(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg";
    img.onerror = null;
  }
  function errorImgCover(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg";
    img.onerror = null;
  }
  /******************************************************************************/
</script>

  <!-- import head_end begin -->
  <!-- import head_end end -->
  <!-- Custom Files headEnd begin-->
  
  <!-- Custom Files headEnd end-->
  <!-- front-matter head_end begin -->
  <!-- front-matter head_end end -->
</head>
  <body itemscope itemtype="http://schema.org/WebPage">
    <!-- import body_begin begin-->
    <!-- import body_begin end-->
    <!-- Custom Files bodyBegin begin-->
    
    <!-- Custom Files bodyBegin end-->
    <!-- front-matter body_begin begin -->
    <!-- front-matter body_begin end -->
    <header itemscope itemtype="http://schema.org/WPHeader" id="l_header" class="l_header auto shadow floatable blur show" style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fa-solid fa-comments fa-fw" target="_self"  href="/" onclick="return false;" title="comment"></a></li>
        
          <li><a id="s-toc" class="s-toc fa-solid fa-list fa-fw" target="_self"  href="/" onclick="return false;" title="toc"></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/Logo-NavBar@3x.png'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="博客"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                target="_blank" rel="noopener" href="https://space.bilibili.com/57415148" title="关于"
                  
                  
                  
                    active-action="action-https:spacebilibilicom57415148"
                  >
                  <i class='fa-solid fa-user fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>
      
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fa-solid fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>
      

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fa-solid fa-search fa-fw" target="_self" href="/" onclick="return false;" title="search"></a></li>
				
				<li>
          <a class="s-menu fa-solid fa-bars fa-fw" target="_self" href="/" onclick="return false;" title="menu"></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="博客"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                target="_blank" rel="noopener" href="https://space.bilibili.com/57415148" title="关于"
                  
                  
                  
                    active-action="action-https:spacebilibilicom57415148"
                  >
                  <i class='fa-solid fa-user fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>

      <!-- Custom Files header begin -->
      
      <!-- Custom Files header end -->
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
      <!-- see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs -->
      <div id="none" class='cover-wrapper post search' style="display: none;">
        
  <div class='cover-bg lazyload placeholder' data-bg="https://gcore.jsdelivr.net/gh/MHG-LAB/cron@gh-pages/bing/bing.jpg"></div>

<div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">Luhumu</p>
    
    
      <p class="subtitle">那马路上天天都在塞</p>
    
  </div>
  <div class='bottom'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="输入你需要搜索的关键字" />
          <i class="icon fa-solid fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <div class='list-h'>
        
          
            <a target="_blank" rel="noopener" href="https://space.bilibili.com/57415148"
              
              
              active-action="action-https:spacebilibilicom57415148">
              <p>b站</p>
            </a>
          
            <a href="/archives/"
              
              
              active-action="action-archives">
              <p>博客</p>
            </a>
          
            <a target="_blank" rel="noopener" href="https://github.com/mengxiangzhuifeiji"
              
              
              active-action="action-https:githubcommengxiangzhuifeiji">
              <p>源码</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

        <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
      </div>
    
  
</div>

      <div id="safearea">
        <div class="body-wrapper">
          
<div id="l_main" class=''>
  <article itemscope itemtype="http://schema.org/Article" class="article post white-box reveal md shadow floatable blur article-type-post" id="post" itemscope itemprop="blogPost">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/31/Nginx/">
  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天天">
  </span>
  <span hidden itemprop="post" itemscope itemtype="http://schema.org/Post">
    <meta itemprop="name" content="天天">
    <meta itemprop="description" content="blog">
  </span>
  


  
    <span hidden>
      <meta itemprop="image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
    </span>
  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title" itemprop="name headline">
        Nginx
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author' itemprop="author" itemscope itemtype="http://schema.org/Person">
  <a itemprop="url" class='author' href="/" rel="nofollow">
    <img itemprop="image" src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
    <p itemprop="name">请设置文章作者</p>
  </a>
</div>

          
        
          
            
  <div class='new-meta-item category'>
    <i class="fa-solid fa-folder-open fa-fw" aria-hidden="true"></i>
    <a class="category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
    
      <span hidden itemprop="about" itemscope itemtype="http://schema.org/Thing">
        <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url"><span itemprop="name">中间件</span></a>
      </span>
    
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateCreated datePublished" datetime="2023-07-31T17:31:12+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2023年7月31日</p>
  </a>
</div>

          
        
          
            



          
        
        <!-- Custom Files topMeta begin-->
        
        <!-- Custom Files topMeta end-->
      </div>
    
  </div>


  <div id="layoutHelper-page-plugins"></div>
  <div id="post-body" itemprop="articleBody">
    <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="Nginx简介"><a href="#Nginx简介" class="headerlink" title="Nginx简介"></a>Nginx简介</h2><h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>Nginx（“engine x”）一个具有高性能的【<strong>HTTP</strong>】和【<strong>反向代理</strong>】的【<strong>WEB服务器</strong>】，同时也是一个【<strong>POP3&#x2F;SMTP&#x2F;IMAP代理服务器</strong>】，是由伊戈尔·赛索耶夫(俄罗斯人)使用<strong>C语言编写</strong>的，Nginx的第一个版本是2004年10月4号发布的0.1.0版本。另外值得一提的是伊戈尔·赛索耶夫将Nginx的源码进行了开源，这也为Nginx的发展提供了良好的保障。</p>
<h4 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h4><ol>
<li>WEB服务器：</li>
</ol>
<p>WEB服务器也叫网页服务器，英文名叫Web Server，主要功能是为用户提供网上信息浏览服务。</p>
<ol start="2">
<li>HTTP:(协议)</li>
</ol>
<p>HTTP是超文本传输协议的缩写，是用于从WEB服务器传输超文本到本地浏览器的传输协议，也是互联网上应用最为广泛的一种网络协议。HTTP是一个客户端和服务器端请求和应答的标准，客户端是终端用户，服务端是网站，通过使用Web浏览器、网络爬虫或者其他工具，客户端发起一个到服务器上指定端口的HTTP请求。</p>
<ol start="3">
<li>POP3&#x2F;SMTP&#x2F;IMAP：</li>
</ol>
<p>POP3(Post Offic Protocol 3)邮局协议的第三个版本，<br>SMTP(Simple Mail Transfer Protocol)简单邮件传输协议，<br>IMAP(Internet Mail Access Protocol)交互式邮件存取协议，<br>通过上述名词的解释，我们可以了解到Nginx也可以作为<strong>电子邮件代理服务器。</strong></p>
<ol start="4">
<li><strong>反向代理</strong></li>
</ol>
<p><strong>正向代理</strong>：替客户端向服务器发送请求<br>假设 客户端不能向服务器发送请求（例如 跨域问题） 我们需要找一个代理服务器发送就行了<br>客户端-&gt; 代理服务器 -&gt; 目标服务器<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685334835174-cc01028e-fe04-4a87-add5-477a9fcfa3f1.png#averageHue=%23fafafa&clientId=u233b67c3-2e62-4&from=paste&height=431&id=uef835b5c&originHeight=539&originWidth=851&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55441&status=done&style=none&taskId=u721a401d-9060-40c0-bc77-5fe9be7e8f5&title=&width=680.8" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685334835174-cc01028e-fe04-4a87-add5-477a9fcfa3f1.png#averageHue=%23fafafa&clientId=u233b67c3-2e62-4&from=paste&height=431&id=uef835b5c&originHeight=539&originWidth=851&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55441&status=done&style=none&taskId=u721a401d-9060-40c0-bc77-5fe9be7e8f5&title=&width=680.8" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>上图就是正向代理  所谓的魔法（翻墙） 就是用的这种模式 <strong>正向代理代理的是客户端请求 让客户端认为这才是真正的服务器</strong></p>
<p><strong>反向代理</strong><br>反向代理 是为了缓解服务器的压力 将请求部署在多台服务器上 这个时候前端发起请求就要根据不同的url去访问 可以通过访问<strong>代理服务器（前端发送同一个地址） 服务器去转发到不同的后端处理</strong><br><strong>反向代理代理的是服务器端</strong><br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335031335-409ecaf9-a7cf-41f9-9fb5-9416d8f46b9b.png#averageHue=%23fbfbfb&clientId=u233b67c3-2e62-4&from=paste&height=685&id=u1c62f6c5&originHeight=856&originWidth=1218&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=170697&status=done&style=none&taskId=ud0651627-4c85-481b-8585-bad901a101b&title=&width=974.4" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335031335-409ecaf9-a7cf-41f9-9fb5-9416d8f46b9b.png#averageHue=%23fbfbfb&clientId=u233b67c3-2e62-4&from=paste&height=685&id=u1c62f6c5&originHeight=856&originWidth=1218&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=170697&status=done&style=none&taskId=ud0651627-4c85-481b-8585-bad901a101b&title=&width=974.4" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"></p>
<h3 id="常见服务器对比"><a href="#常见服务器对比" class="headerlink" title="常见服务器对比"></a>常见服务器对比</h3><p>在介绍这一节内容之前，我们先来认识一家公司叫Netcraft。<br>Netcraft公司于1994年底在英国成立，多年来一直致力于互联网市场以及在线安全方面的咨询服务，其中在国际上最具影响力的当属其针对网站服务器、SSL市场所做的客观严谨的分析研究，公司官网每月公布的调研数据（Web Server Survey）已成为当今人们了解全球网站数量以及服务器市场分额情况的主要参考依据，时常被诸如华尔街杂志，英国BBC，Slashdot等媒体报道或引用。<br>我们先来看一组数据，我们先打开Nginx的官方网站 <a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org/</a>,找到Netcraft公司公布的数据，对当前主流服务器产品进行介绍。</p>
<p>几种常见的服务器：</p>
<h4 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h4><pre><code>全称(Internet Information Services)即互联网信息服务，是由微软公司提供的基于windows系统的互联网基本服务。windows作为服务器在稳定性与其他一些性能上都不如类UNIX操作系统，因此在需要高性能Web服务器的场合下，IIS可能就会被&quot;冷落&quot;.
</code></pre>
<h4 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h4><pre><code>Tomcat是一个运行Servlet和JSP的Web应用软件，Tomcat技术先进、性能稳定而且开放源代码，因此深受Java爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web应用服务器。但是Tomcat天生是一个重量级的Web服务器，对静态文件和高并发的处理比较弱。
</code></pre>
<h4 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h4><pre><code>Apache的发展时期很长，同时也有过一段辉煌的业绩。从上图可以看出大概在2014年以前都是市场份额第一的服务器。Apache有很多优点，如稳定、开源、跨平台等。但是它出现的时间太久了，在它兴起的年代，互联网的产业规模远远不如今天，所以它被设计成一个重量级的、不支持高并发的Web服务器。在Apache服务器上，如果有数以万计的并发HTTP请求同时访问，就会导致服务器上消耗大量能存，操作系统内核对成百上千的Apache进程做进程间切换也会消耗大量的CUP资源，并导致HTTP请求的平均响应速度降低，这些都决定了Apache不可能成为高性能的Web服务器。这也促使了Lighttpd和Nginx的出现。
</code></pre>
<h4 id="Lighttpd"><a href="#Lighttpd" class="headerlink" title="Lighttpd"></a>Lighttpd</h4><pre><code>Lighttpd是德国的一个开源的Web服务器软件，它和Nginx一样，都是轻量级、高性能的Web服务器，欧美的业界开发者比较钟爱Lighttpd,而国内的公司更多的青睐Nginx，同时网上Nginx的资源要更丰富些。
</code></pre>
<h4 id="其他的服务器"><a href="#其他的服务器" class="headerlink" title="其他的服务器"></a>其他的服务器</h4><p>Google Servers，Weblogic, Webshpere(IBM)…<br>经过各个服务器的对比，种种迹象都表明，Nginx将以性能为王。这也是我们为什么选择Nginx的理由。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="Nginx的优点"><a href="#Nginx的优点" class="headerlink" title="Nginx的优点"></a>Nginx的优点</h4><h5 id="1-速度更快、并发更高"><a href="#1-速度更快、并发更高" class="headerlink" title="(1)速度更快、并发更高"></a>(1)速度更快、并发更高</h5><p>单次请求或者高并发请求的环境下，Nginx都会比其他Web服务器响应的速度更快。一方面在正常情况下，单次请求会得到更快的响应，另一方面，在高峰期(如有数以万计的并发请求)，Nginx比其他Web服务器更快的响应请求。Nginx之所以有这么高的并发处理能力和这么好的性能原因在于Nginx采用了<strong>多进程和I&#x2F;O多路复用(epoll)的底层实现</strong>。</p>
<h5 id="2-配置简单，扩展性强"><a href="#2-配置简单，扩展性强" class="headerlink" title="(2)配置简单，扩展性强"></a>(2)配置简单，扩展性强</h5><p>Nginx的设计极具扩展性，它本身就是由很多模块组成，这些模块的使用可以通过配置文件的配置来添加。这些模块有官方提供的也有第三方提供的模块，如果需要完全可以开发服务自己业务特性的定制模块。</p>
<h5 id="3-高可靠性"><a href="#3-高可靠性" class="headerlink" title="(3)高可靠性"></a>(3)高可靠性</h5><p>Nginx采用的是多进程模式运行，其中有一个master主进程和N多个worker进程，worker进程的数量我们可以手动设置，每个worker进程之间都是相互独立提供服务，并且master主进程可以在某一个worker进程出错时，快速去”拉起”新的worker进程提供服务。</p>
<h5 id="4-热部署"><a href="#4-热部署" class="headerlink" title="(4)热部署"></a>(4)热部署</h5><p>现在互联网项目都要求以7*24小时进行服务的提供，针对于这一要求，Nginx也提供了热部署功能，即可以在Nginx不停止的情况下，对Nginx进行文件升级、更新配置和更换日志文件等功能。</p>
<h5 id="5-成本低、BSD许可证"><a href="#5-成本低、BSD许可证" class="headerlink" title="(5)成本低、BSD许可证"></a>(5)成本低、BSD许可证</h5><p>BSD是一个开源的许可证，世界上的开源许可证有很多，现在比较流行的有六种分别是GPL、BSD、MIT、Mozilla、Apache、LGPL。这六种的区别是什么，我们可以通过下面一张图来解释下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335440503-fd9002b5-7d7c-4b9b-b16d-ad2a3b4ff8cf.png#averageHue=%23fcfcfb&clientId=u233b67c3-2e62-4&from=paste&height=483&id=u368240b3&originHeight=604&originWidth=1177&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=175210&status=done&style=none&taskId=u87de7b3a-152f-4bd8-b2e5-2036dba638e&title=&width=941.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335440503-fd9002b5-7d7c-4b9b-b16d-ad2a3b4ff8cf.png#averageHue=%23fcfcfb&clientId=u233b67c3-2e62-4&from=paste&height=483&id=u368240b3&originHeight=604&originWidth=1177&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=175210&status=done&style=none&taskId=u87de7b3a-152f-4bd8-b2e5-2036dba638e&title=&width=941.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>Nginx本身是开源的，我们不仅可以免费的将Nginx应用在商业领域，而且还可以在项目中直接修改Nginx的源码来定制自己的特殊要求。这些点也都是Nginx为什么能吸引无数开发者继续为Nginx来贡献自己的智慧和青春。OpenRestry [Nginx+Lua] Tengine[淘宝]</p>
<h3 id="Nginx的功能特性及常用功能"><a href="#Nginx的功能特性及常用功能" class="headerlink" title="Nginx的功能特性及常用功能"></a>Nginx的功能特性及常用功能</h3><p>Nginx提供的基本功能服务从大体上归纳为”<strong>基本HTTP服务</strong>“、“<strong>高级HTTP服务</strong>”和”邮件服务”等三大类。</p>
<h4 id="基本HTTP服务"><a href="#基本HTTP服务" class="headerlink" title="基本HTTP服务"></a>基本HTTP服务</h4><p>Nginx可以提供基本HTTP服务，可以作为HTTP代理服务器和反向代理服务器，支持通过缓存加速访问，可以完成简单的负载均衡和容错，支持包过滤功能，支持SSL等。</p>
<ul>
<li>处理静态文件、处理索引文件以及支持自动索引；</li>
<li>提供反向代理服务器，并可以使用缓存加上反向代理，同时完成负载均衡和容错；</li>
<li>提供对FastCGI、memcached等服务的缓存机制，，同时完成负载均衡和容错；</li>
<li>使用Nginx的模块化特性提供过滤器功能。Nginx基本过滤器包括gzip压缩、ranges支持、chunked响应、XSLT、SSI以及图像缩放等。其中针对包含多个SSI的页面，经由FastCGI或反向代理，SSI过滤器可以并行处理。</li>
<li>支持HTTP下的安全套接层安全协议SSL.</li>
<li>支持基于加权和依赖的优先权的HTTP&#x2F;2</li>
</ul>
<h4 id="高级HTTP服务"><a href="#高级HTTP服务" class="headerlink" title="高级HTTP服务"></a>高级HTTP服务</h4><ul>
<li>支持基于名字和IP的虚拟主机设置</li>
<li>支持HTTP&#x2F;1.0中的KEEP-Alive模式和管线(PipeLined)模型连接</li>
<li>自定义访问日志格式、带缓存的日志写操作以及快速日志轮转。</li>
<li>提供3xx~5xx错误代码重定向功能</li>
<li>支持重写（Rewrite)模块扩展</li>
<li>支持重新加载配置以及在线升级时无需中断正在处理的请求</li>
<li>支持网络监控</li>
<li>支持FLV和MP4流媒体传输</li>
</ul>
<h4 id="邮件服务"><a href="#邮件服务" class="headerlink" title="邮件服务"></a>邮件服务</h4><p>Nginx提供邮件代理服务也是其基本开发需求之一，主要包含以下特性：</p>
<ul>
<li>支持IMPA&#x2F;POP3代理服务功能</li>
<li>支持内部SMTP代理服务功能</li>
</ul>
<h4 id="Nginx常用的功能模块"><a href="#Nginx常用的功能模块" class="headerlink" title="Nginx常用的功能模块"></a>Nginx常用的功能模块</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">静态资源部署</span><br><span class="line">Rewrite地址重写</span><br><span class="line">    正则表达式</span><br><span class="line">反向代理</span><br><span class="line">负载均衡</span><br><span class="line">    轮询、加权轮询、ip_hash、url_hash、fair</span><br><span class="line">Web缓存</span><br><span class="line">环境部署</span><br><span class="line">    高可用的环境</span><br><span class="line">用户认证模块...</span><br></pre></td></tr></table></figure>
<p>Nginx的核心组成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx二进制可执行文件 </span><br><span class="line">nginx.conf配置文件</span><br><span class="line">error.log错误的日志记录</span><br><span class="line">access.log访问日志记录</span><br></pre></td></tr></table></figure>


<h2 id="Nginx环境准备"><a href="#Nginx环境准备" class="headerlink" title="Nginx环境准备"></a>Nginx环境准备</h2><h3 id="Nginx版本介绍"><a href="#Nginx版本介绍" class="headerlink" title="Nginx版本介绍"></a>Nginx版本介绍</h3><p>Nginx的官方网站为: <a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org</a><br>Nginx的官方下载网站为<a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a>，当然你也可以之间在首页选中右边的download进入版本下载网页。在下载页面我们会看到如下内容：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335929487-99ebb89a-703b-4cfc-8039-56e76c695ec5.png#averageHue=%23fcfafa&clientId=u233b67c3-2e62-4&from=paste&height=674&id=u740e7bfa&originHeight=842&originWidth=1115&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=324355&status=done&style=none&taskId=u5803abc1-62c7-4635-9e27-d78181b78af&title=&width=892" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685335929487-99ebb89a-703b-4cfc-8039-56e76c695ec5.png#averageHue=%23fcfafa&clientId=u233b67c3-2e62-4&from=paste&height=674&id=u740e7bfa&originHeight=842&originWidth=1115&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=324355&status=done&style=none&taskId=u5803abc1-62c7-4635-9e27-d78181b78af&title=&width=892" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>下载linux的 </p>
<h3 id="获取Nginx源码"><a href="#获取Nginx源码" class="headerlink" title="获取Nginx源码"></a>获取Nginx源码</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/download/">http://nginx.org/download/</a><br>打开上述网站，就可以查看到Nginx的所有版本，选中自己需要的版本进行下载。下载我们可以直接在windows上下载然后上传到服务器，也可以直接从服务器上下载，这个时候就需要准备一台服务器。</p>
<h3 id="准备服务器系统"><a href="#准备服务器系统" class="headerlink" title="准备服务器系统"></a>准备服务器系统</h3><p>环境准备</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VMware WorkStation</span><br><span class="line">Centos7</span><br><span class="line">MobaXterm</span><br><span class="line">    xsheel,SecureCRT</span><br><span class="line">网络</span><br></pre></td></tr></table></figure>
<p>(1)确认centos的内核<br>准备一个内核为2.6及以上版本的操作系统，因为linux2.6及以上内核才支持epoll,而Nginx需要解决高并发压力问题是需要用到epoll，所以我们需要有这样的版本要求。<br>我们可以使用uname -a命令来查询linux的内核版本。<br>(2)确保centos能联网<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685426392225-0af4aaa0-0933-44cc-b9da-e284b658c590.png#averageHue=%23f5f5f5&clientId=ua34293e8-ddf5-4&from=paste&height=302&id=u38d889ff&originHeight=378&originWidth=1202&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46474&status=done&style=none&taskId=u5453949a-8498-4f11-9629-69d53fe238c&title=&width=961.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685426392225-0af4aaa0-0933-44cc-b9da-e284b658c590.png#averageHue=%23f5f5f5&clientId=ua34293e8-ddf5-4&from=paste&height=302&id=u38d889ff&originHeight=378&originWidth=1202&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46474&status=done&style=none&taskId=u5453949a-8498-4f11-9629-69d53fe238c&title=&width=961.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>三种模式<br>(3)确认关闭防火墙<br>这一项的要求仅针对于那些对linux系统的防火墙设置规则不太清楚的，建议大家把防火墙都关闭掉，因为我们此次课程主要的内容是对Nginx的学习，把防火墙关闭掉，可以省掉后续Nginx学习过程中遇到的诸多问题。<br>关闭的方式有如下两种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld      关闭运行的防火墙，系统重新启动后，防火墙将重新打开</span><br><span class="line">systemctl disable firewalld   永久关闭防火墙，，系统重新启动后，防火墙依然关闭</span><br><span class="line">systemctl status firewalld   查看防火墙状态</span><br></pre></td></tr></table></figure>
<p>（4）确认停用selinux<br>selinux(security-enhanced linux),美国安全局对于强制访问控制的实现，在linux2.6内核以后的版本中，selinux已经成功内核中的一部分。可以说selinux是linux史上最杰出的新安全子系统之一。虽然有了selinux，我们的系统会更安全，但是对于我们的学习Nginx的历程中，会多很多设置，所以这块建议大家将selinux进行关闭<br>sestatus命令查看状态<br>如果查看不是disabled状态，我们可以通过修改配置文件来进行设置,修改SELINUX&#x3D;disabled，然后重启下系统即可生效。<br>vim &#x2F;etc&#x2F;selinux&#x2F;config</p>
<h3 id="Nginx安装方式介绍"><a href="#Nginx安装方式介绍" class="headerlink" title="Nginx安装方式介绍"></a>Nginx安装方式介绍</h3><p>Nginx的安装方式有两种分别是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通过Nginx源码</span><br><span class="line">    通过Nginx源码简单安装 (1)</span><br><span class="line">    通过Nginx源码复杂安装 (3)</span><br><span class="line">通过yum安装 (2)</span><br></pre></td></tr></table></figure>
<p>如果通过Nginx源码安装需要提前准备的内容：</p>
<h5 id="GCC编译器"><a href="#GCC编译器" class="headerlink" title="GCC编译器"></a>GCC编译器</h5><p>Nginx是使用C语言编写的程序，因此想要运行Nginx就需要安装一个编译工具。GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。 (想要运行java需要有jdk)<br>使用命令yum install -y gcc来安装<br>安装成功后，可以通过gcc –version来查看gcc是否安装成功</p>
<h5 id="PCRE"><a href="#PCRE" class="headerlink" title="PCRE"></a>PCRE</h5><p>Nginx在编译过程中需要使用到PCRE库（perl Compatible Regular Expressoin 兼容正则表达式库)，因为在Nginx的Rewrite模块和http核心模块都会使用到PCRE正则表达式语法。<br>可以使用命令yum install -y pcre pcre-devel来进行安装<br>安装成功后，可以通过rpm -qa pcre pcre-devel来查看是否安装成功</p>
<h5 id="zlib"><a href="#zlib" class="headerlink" title="zlib"></a>zlib</h5><p>zlib库提供了开发人员的压缩算法，在Nginx的各个模块中需要使用gzip压缩，所以我们也需要提前安装其库及源代码zlib和zlib-devel<br>可以使用命令yum install -y zlib zlib-devel来进行安装<br>安装成功后，可以通过rpm -qa zlib zlib-devel来查看是否安装成功</p>
<h5 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h5><p>OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包进行安全通信，并且避免被窃听。<br>SSL:Secure Sockets Layer安全套接协议的缩写，可以在Internet上提供秘密性传输，其目标是保证两个应用间通信的保密性和可靠性。在Nginx中，如果服务器需要提供安全网页时就需要用到OpenSSL库，所以我们需要对OpenSSL的库文件及它的开发安装包进行一个安装。<br>可以使用命令yum install -y openssl openssl-devel来进行安装<br>安装成功后，可以通过rpm -qa openssl openssl-devel来查看是否安装成功<br>上述命令，一个个来的话比较麻烦，我们也可以通过一条命令来进行安装<br>yum install -y gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel进行全部安装。</p>
<h4 id="方案一：Nginx的源码简单安装"><a href="#方案一：Nginx的源码简单安装" class="headerlink" title="方案一：Nginx的源码简单安装"></a>方案一：Nginx的源码简单安装</h4><p>(1)进入官网查找需要下载版本的链接地址，然后使用wget命令进行下载<br>wget <a target="_blank" rel="noopener" href="http://nginx.org/download/nginx-1.16.1.tar.gz">http://nginx.org/download/nginx-1.16.1.tar.gz</a><br>(2)建议大家将下载的资源进行包管理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p nginx/core</span><br><span class="line">mv nginx-1.16.1.tar.gz nginx/core</span><br></pre></td></tr></table></figure>
<p>(3)解压缩<br>tar -xzf nginx-1.16.1.tar.gz<br>(4)进入资源文件中，发现configure<br>.&#x2F;configure<br>(5)编译<br>make<br>(6)安装<br>make install</p>
<h4 id="方案二：yum安装"><a href="#方案二：yum安装" class="headerlink" title="方案二：yum安装"></a>方案二：yum安装</h4><p>使用源码进行简单安装，我们会发现安装的过程比较繁琐，需要提前准备GCC编译器、PCRE兼容正则表达式库、zlib压缩库、OpenSSL安全通信的软件库包，然后才能进行Nginx的安装。<br>（1）安装yum-utils<br><code>sudo yum  install -y yum-utils</code><br>（2）添加yum源文件<br><code>vim /etc/yum.repos.d/nginx.repo</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br></pre></td></tr></table></figure>
<p>（3）查看是否安装成功<br><code>yum list | grep nginx</code><br>（4）使用yum进行安装<br><code>yum install -y nginx</code><br>（5）查看nginx的安装位置<br><code>whereis nginx</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685427318522-096efd6b-7aba-48d4-b3d3-3116181f2f97.png#averageHue=%231d1915&clientId=ua34293e8-ddf5-4&from=paste&height=27&id=u87cb5df3&originHeight=34&originWidth=1017&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11450&status=done&style=none&taskId=u3931ab8c-bca5-40a1-b8ad-01a00c924e9&title=&width=813.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685427318522-096efd6b-7aba-48d4-b3d3-3116181f2f97.png#averageHue=%231d1915&clientId=ua34293e8-ddf5-4&from=paste&height=27&id=u87cb5df3&originHeight=34&originWidth=1017&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11450&status=done&style=none&taskId=u3931ab8c-bca5-40a1-b8ad-01a00c924e9&title=&width=813.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>（6）启动测试<br>进入 <code>cd/usr/sbin</code>  执行 <code>./nginx</code>启动nginx</p>
<p><strong>关于yum安装以后 一些文件的位置</strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zouhong/p/14790750.html">https://www.cnblogs.com/zouhong/p/14790750.html</a><br>日志文件(error.log) 在&#x2F;var&#x2F;log&#x2F;nginx&#x2F;</p>
<h4 id="源码简单安装和yum安装的差异："><a href="#源码简单安装和yum安装的差异：" class="headerlink" title="源码简单安装和yum安装的差异："></a>源码简单安装和yum安装的差异：</h4><p>这里先介绍一个命令: .&#x2F;nginx -V,通过该命令可以查看到所安装Nginx的版本及相关配置信息。<br>简单安装 <code>configure arguments</code>这一栏是空<br>yum安装  <code>configure arguments</code>这一栏有很多的配置</p>
<h5 id="解压Nginx目录"><a href="#解压Nginx目录" class="headerlink" title="解压Nginx目录"></a>解压Nginx目录</h5><p>执行tar -zxvf nginx-1.16.1.tar.gz对下载的资源进行解压缩，进入压缩后的目录，可以看到如下结构<br>内容解释：<br>auto:存放的是编译相关的脚本<br>CHANGES:版本变更记录<br>CHANGES.ru:俄罗斯文的版本变更记录<br>conf:nginx默认的配置文件<br>configure:nginx软件的自动脚本程序,是一个比较重要的文件，作用如下：<br>    （1）检测环境及根据环境检测结果生成C代码<br>    （2）生成编译代码需要的Makefile文件<br>contrib:存放的是几个特殊的脚本文件，其中README中对脚本有着详细的说明<br>html:存放的是Nginx自带的两个html页面，访问Nginx的首页和错误页面<br>LICENSE:许可证的相关描述文件<br>man:nginx的man手册<br>README:Nginx的阅读指南<br>src:Nginx的源代码</p>
<h4 id="方案三-Nginx的源码复杂安装"><a href="#方案三-Nginx的源码复杂安装" class="headerlink" title="方案三:Nginx的源码复杂安装"></a>方案三:Nginx的源码复杂安装</h4><p>这种方式和简单的安装配置不同的地方在第一步，通过.&#x2F;configure来对编译参数进行设置，需要我们手动来指定。那么都有哪些参数可以进行设置，接下来我们进行一个详细的说明。<br>PATH:是和路径相关的配置信息<br>with:是启动模块，默认是关闭的<br>without:是关闭模块，默认是开启的<br>我们先来认识一些简单的路径配置已经通过这些配置来完成一个简单的编译：<br>–prefix&#x3D;PATH<br>指向Nginx的安装目录，默认值为&#x2F;usr&#x2F;local&#x2F;nginx<br>–sbin-path&#x3D;PATH<br>指向(执行)程序文件(nginx)的路径,默认值为<prefix>&#x2F;sbin&#x2F;nginx<br>–modules-path&#x3D;PATH</p>
<blockquote>
<p>指向Nginx动态模块安装目录，默认值为<prefix>&#x2F;modules<br>**–conf-path&#x3D;PATH **这里需要注意<br>指向配置文件(nginx.conf)的路径,默认值为<prefix>&#x2F;conf&#x2F;nginx.conf</p>
</blockquote>
<p>–error-log-path&#x3D;PATH<br>指向错误日志文件的路径,默认值为<prefix>&#x2F;logs&#x2F;error.log<br>–http-log-path&#x3D;PATH<br>指向访问日志文件的路径,默认值为<prefix>&#x2F;logs&#x2F;access.log<br>–pid-path&#x3D;PATH<br>指向Nginx启动后进行ID的文件路径，默认值为<prefix>&#x2F;logs&#x2F;nginx.pid<br>–lock-path&#x3D;PATH<br>指向Nginx锁文件的存放路径,默认值为<prefix>&#x2F;logs&#x2F;nginx.lock<br>要想使用可以通过如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--sbin-path=/usr/local/nginx/sbin/nginx \</span><br><span class="line">--modules-path=/usr/local/nginx/modules \</span><br><span class="line">--conf-path=/usr/local/nginx/conf/nginx.conf \</span><br><span class="line">--error-log-path=/usr/local/nginx/logs/error.log \</span><br><span class="line">--http-log-path=/usr/local/nginx/logs/access.log \</span><br><span class="line">--pid-path=/usr/local/nginx/logs/nginx.pid \</span><br><span class="line">--lock-path=/usr/local/nginx/logs/nginx.lock</span><br></pre></td></tr></table></figure>
<p>在使用上述命令之前，需要将之前服务器已经安装的nginx进行卸载，卸载的步骤分为三步骤：<br>步骤一：需要将nginx的进程关闭<br><code>./nginx -s stop</code><br>步骤二:将安装的nginx进行删除<br><code>rm -rf /usr/local/nginx</code><br>步骤三:将安装包之前编译的环境清除掉<br><code>make clean</code></p>
<h3 id="Nginx目录结构分析"><a href="#Nginx目录结构分析" class="headerlink" title="Nginx目录结构分析"></a>Nginx目录结构分析</h3><p>在使用Nginx之前，我们先对安装好的Nginx目录文件进行一个分析，在这块给大家介绍一个工具tree，通过tree我们可以很方面的去查看centos系统上的文件目录结构，当然，如果想使用tree工具，就得先通过yum install -y tree来进行安装，安装成功后，可以通过执行tree &#x2F;usr&#x2F;local&#x2F;nginx(tree后面跟的是Nginx的安装目录,我们用的是yum 目录在 etc&#x2F;nginx)，获取的结果如下： </p>
<p>conf:nginx所有配置文件目录<br>CGI(Common Gateway Interface)通用网关【接口】，主要解决的问题是从客户端发送一个请求和数据，服务端获取到请求和数据后可以调用调用CGI【程序】处理及相应结果给客户端的一种标准规范。<br>    fastcgi.conf:fastcgi相关配置文件<br>    fastcgi.conf.default:fastcgi.conf的备份文件<br>    fastcgi_params:fastcgi的参数文件<br>    fastcgi_params.default:fastcgi的参数备份文件<br>    scgi_params:scgi的参数文件<br>    scgi_params.default：scgi的参数备份文件<br>uwsgi_params:uwsgi的参数文件<br>    uwsgi_params.default:uwsgi的参数备份文件<br>    mime.types:记录的是HTTP协议中的Content-Type的值和文件后缀名的对应关系<br>    mime.types.default:mime.types的备份文件<br>    <strong>nginx.conf:这个是Nginx的核心配置文件，这个文件非常重要，也是我们即将要学习的重点</strong><br>    nginx.conf.default:nginx.conf的备份文件<br>    koi-utf、koi-win、win-utf这三个文件都是与编码转换映射相关的配置文件，用来将一种编码转换成另一种编码<br>html:存放nginx自带的两个静态的html页面<br>    50x.html:访问失败后的失败页面<br>    index.html:成功访问的默认首页<br>logs:记录入门的文件，当nginx服务器启动后，这里面会有 access.log error.log 和nginx.pid三个文件出现。<br>sbin:是存放执行程序文件nginx<br>    nginx是用来控制Nginx的启动和停止等相关的命令。</p>
<h3 id="Nginx服务器启停命令"><a href="#Nginx服务器启停命令" class="headerlink" title="Nginx服务器启停命令"></a>Nginx服务器启停命令</h3><p>Nginx安装完成后，接下来我们要学习的是如何启动、重启和停止Nginx的服务。<br>对于Nginx的启停在linux系统中也有很多种方式，我们本次课程介绍两种方式：</p>
<ol>
<li>Nginx服务的信号控制</li>
<li><strong>Nginx的命令行控制</strong></li>
</ol>
<h4 id="方式一-Nginx服务的信号控制"><a href="#方式一-Nginx服务的信号控制" class="headerlink" title="方式一:Nginx服务的信号控制"></a>方式一:Nginx服务的信号控制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Nginx中的master和worker进程?</span><br><span class="line">Nginx的工作方式?</span><br><span class="line">如何获取进程的PID?</span><br><span class="line">信号有哪些?</span><br><span class="line">如何通过信号控制Nginx的启停等相关操作?</span><br></pre></td></tr></table></figure>
<p>前面在提到Nginx的高性能，其实也和它的架构模式有关。Nginx默认采用的是多进程的方式来工作的，当将Nginx启动后，我们通过ps -ef | grep nginx命令可以查看到如下内容：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429163323-4536b7b0-8e95-42bd-a729-5fd027ff33c2.png#averageHue=%23100b08&clientId=ua34293e8-ddf5-4&from=paste&height=121&id=u044884d5&originHeight=151&originWidth=753&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19677&status=done&style=none&taskId=ud2b425ef-cf6d-4eee-b804-edc81e11a4c&title=&width=602.4" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429163323-4536b7b0-8e95-42bd-a729-5fd027ff33c2.png#averageHue=%23100b08&clientId=ua34293e8-ddf5-4&from=paste&height=121&id=u044884d5&originHeight=151&originWidth=753&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19677&status=done&style=none&taskId=ud2b425ef-cf6d-4eee-b804-edc81e11a4c&title=&width=602.4" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>从上图中可以看到,Nginx后台进程中包含一个master进程和多个worker进程，master进程主要用来管理worker进程，包含接收外界的信息，并将接收到的信号发送给各个worker进程，监控worker进程的状态，当worker进程出现异常退出后，会自动重新启动新的worker进程。而worker进程则是专门用来处理用户请求的，各个worker进程之间是平等的并且相互独立，处理请求的机会也是一样的。nginx的进程模型，我们可以通过下图来说明下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429172663-184f3fed-f5e6-4883-9b89-89e6ddcf1cda.png#averageHue=%23f5f5f4&clientId=ua34293e8-ddf5-4&from=paste&height=601&id=uf3983687&originHeight=751&originWidth=1095&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=809413&status=done&style=none&taskId=u64435398-1f51-47af-bc4d-7b80ccb03f5&title=&width=876" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429172663-184f3fed-f5e6-4883-9b89-89e6ddcf1cda.png#averageHue=%23f5f5f4&clientId=ua34293e8-ddf5-4&from=paste&height=601&id=uf3983687&originHeight=751&originWidth=1095&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=809413&status=done&style=none&taskId=u64435398-1f51-47af-bc4d-7b80ccb03f5&title=&width=876" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>worker 用来接收用户请求 master进程用来管理worker进程 管理员只需要发送给master进程 他会分发到worker进程</p>
<p>（1）要想操作Nginx的master进程，就需要获取到master进程的进程号ID。获取方式简单介绍两个，<br>方式一：通过ps -ef | grep nginx；<br>方式二：在讲解nginx的.&#x2F;configure的配置参数的时候，有一个参数是–pid-path&#x3D;PATH默认是&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid,所以可以通过查看该文件来获取nginx的master进程ID.<br>（2）信号</p>
<table>
<thead>
<tr>
<th><strong>信号</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>TERM&#x2F;INT</td>
<td>立即关闭整个服务</td>
</tr>
<tr>
<td>QUIT</td>
<td>“优雅”地关闭整个服务</td>
</tr>
<tr>
<td>HUP</td>
<td>重读配置文件并使用服务对新配置项生效</td>
</tr>
<tr>
<td>USR1</td>
<td>重新打开日志文件，可以用来进行日志切割</td>
</tr>
<tr>
<td>USR2</td>
<td>平滑升级到最新版的nginx</td>
</tr>
<tr>
<td>WINCH</td>
<td>所有子进程不在接收处理新连接，相当于给work进程发送QUIT指令</td>
</tr>
</tbody></table>
<p>调用命令为kill -signal PID<br><strong>signal:即为信号；PID即为获取到的master线程ID</strong></p>
<ol>
<li><p>发送TERM&#x2F;INT信号给master进程，会将Nginx服务立即关闭。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -TERM PID / kill -TERM `cat /usr/local/nginx/logs/nginx.pid`</span><br><span class="line">kill -INT PID / kill -INT `cat /usr/local/nginx/logs/nginx.pid`</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送QUIT信号给master进程，master进程会控制所有的work进程不再接收新的请求，等所有请求处理完后，在把进程都关闭掉。</p>
</li>
</ol>
<p><code>kill -QUIT PID / kill -TERM </code>cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;&#96;</p>
<ol start="3">
<li>发送HUP信号给master进程，master进程会把控制旧的work进程不再接收新的请求，等处理完请求后将旧的work进程关闭掉，然后根据nginx的配置文件重新启动新的work进程</li>
</ol>
<p><code>kill -HUP PID / kill -TERM </code>cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;&#96;</p>
<ol start="4">
<li>发送USR1信号给master进程，告诉Nginx重新开启日志文件</li>
</ol>
<p><code>kill -USR1 PID / kill -TERM </code>cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;&#96;</p>
<ol start="5">
<li>发送USR2信号给master进程，告诉master进程要平滑升级，这个时候，会重新开启对应的master进程和work进程，整个系统中将会有两个master进程，并且新的master进程的PID会被记录在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid而之前的旧的master进程PID会被记录在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid.oldbin文件中，接着再次发送QUIT信号给旧的master进程，让其处理完请求后再进行关闭</li>
</ol>
<p><code>kill -USR2 PID / kill -USR2 </code>cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid<code> `kill -QUIT PID / kill -QUIT `cat /usr/local/nginx/logs/nginx.pid.oldbin</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429681069-1947d070-cba8-42b8-b006-fc4baabba79b.png#averageHue=%23fdfdfc&clientId=ua34293e8-ddf5-4&from=paste&height=317&id=uf969d0be&originHeight=396&originWidth=1158&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=82372&status=done&style=none&taskId=u0fe84806-bed7-4b49-8f13-0360d0ec23e&title=&width=926.4" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685429681069-1947d070-cba8-42b8-b006-fc4baabba79b.png#averageHue=%23fdfdfc&clientId=ua34293e8-ddf5-4&from=paste&height=317&id=uf969d0be&originHeight=396&originWidth=1158&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=82372&status=done&style=none&taskId=u0fe84806-bed7-4b49-8f13-0360d0ec23e&title=&width=926.4" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"></p>
<ol start="6">
<li>发送WINCH信号给master进程,让master进程控制不让所有的work进程在接收新的请求了，请求处理完后关闭work进程。注意master进程不会被关闭掉</li>
</ol>
<p><code>kill -WINCH PID /kill -WINCH</code>cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;&#96;</p>
<h4 id="方式二-Nginx的命令行控制"><a href="#方式二-Nginx的命令行控制" class="headerlink" title="方式二:Nginx的命令行控制"></a>方式二:Nginx的命令行控制</h4><p>此方式是通过Nginx安装目录下的sbin下的可执行文件nginx来进行Nginx状态的控制，我们可以通过nginx -h来查看都有哪些参数可以用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">-?,-h         : this help</span><br><span class="line">-v            : show version and exit</span><br><span class="line">-V            : show version and configure options then exit</span><br><span class="line">-t            : test configuration and exit</span><br><span class="line">-T            : test configuration, dump it and exit</span><br><span class="line">-q            : suppress non-error messages during configuration testing</span><br><span class="line">-s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">-p prefix     : set prefix path (default: /etc/nginx/)</span><br><span class="line">-e filename   : set error log file (default: /var/log/nginx/error.log)</span><br><span class="line">-c filename   : set configuration file (default: /etc/nginx/nginx.conf)</span><br><span class="line">-g directives : set global directives out of configuration file</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>-?和-h:显示帮助信息<br>-v:打印版本号信息并退出<br>-V:打印版本号信息和配置信息并退出<br>-t:测试nginx的配置文件语法是否正确并退出<br>-T:测试nginx的配置文件语法是否正确并列出用到的配置文件信息然后退出<br>-q:在配置测试期间禁止显示非错误消息<br>-s:signal信号，后面可以跟 ：<br>     stop[快速关闭，类似于TERM&#x2F;INT信号的作用]<br>    quit[优雅的关闭，类似于QUIT信号的作用]<br>    reopen[重新打开日志文件类似于USR1信号的作用]<br>    reload[类似于HUP信号的作用]<br>-p:prefix，指定Nginx的prefix路径，(默认为: &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;)<br>-c:filename,指定Nginx的配置文件路径,(默认为: conf&#x2F;nginx.conf)<br>-g:用来补充Nginx配置文件，向Nginx服务指定启动时应用全局的配置</p>
<p>经常-tc 联合使用 测试指定文件是否正确</p>
<h3 id="Nginx服务器版本升级和新增模块"><a href="#Nginx服务器版本升级和新增模块" class="headerlink" title="Nginx服务器版本升级和新增模块"></a>Nginx服务器版本升级和新增模块</h3><p>如果想对Nginx的版本进行更新，或者要应用一些新的模块，最简单的做法就是停止当前的Nginx服务，然后开启新的Nginx服务。但是这样会导致在一段时间内，用户是无法访问服务器。为了解决这个问题，我们就需要用到Nginx服务器提供的平滑升级功能。这个也是Nginx的一大特点，使用这种方式，就可以使Nginx在7*24小时不间断的提供服务了。接下来我们分析下需求：<br>需求：Nginx的版本最开始使用的是Nginx-1.14.2,由于服务升级，需要将Nginx的版本升级到Nginx-1.16.1,要求Nginx不能中断提供服务。<br>为了应对上述的需求，这里我们给大家提供两种解决方案:<br>方案一:使用Nginx服务信号完成Nginx的升级<br>方案二:使用Nginx安装目录的make命令完成升级</p>
<h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><p>（1）先准备两个版本的Nginx分别是 1.14.2和1.16.1<br>（2）使用Nginx源码安装的方式将1.14.2版本安装成功并正确访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进入安装目录</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>（3）将Nginx1.16.1进行参数配置和编译，不需要进行安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进入安装目录</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<h4 id="方案一-使用Nginx服务信号进行升级"><a href="#方案一-使用Nginx服务信号进行升级" class="headerlink" title="方案一:使用Nginx服务信号进行升级"></a>方案一:使用Nginx服务信号进行升级</h4><p>第一步:将1.14.2版本的sbin目录下的nginx进行备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">mv nginx nginxold</span><br></pre></td></tr></table></figure>
<p>第二步:将Nginx1.16.1安装目录编译后的objs目录下的nginx文件，拷贝到原来&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/nginx/core/nginx-1.16.1/objs</span><br><span class="line">cp nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>
<p>第三步:发送信号USR2给Nginx的1.14.2版本对应的master进程<br>第四步:发送信号QUIT给Nginx的1.14.2版本对应的master进程<br>kill -QUIT <code>more /usr/local/logs/nginx.pid.oldbin</code></p>
<h4 id="方案二-使用Nginx安装目录的make命令完成升级"><a href="#方案二-使用Nginx安装目录的make命令完成升级" class="headerlink" title="方案二:使用Nginx安装目录的make命令完成升级"></a>方案二:使用Nginx安装目录的make命令完成升级</h4><p>第一步:将1.14.2版本的sbin目录下的nginx进行备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">mv nginx nginxold</span><br></pre></td></tr></table></figure>
<p>第二步:将Nginx1.16.1安装目录编译后的objs目录下的nginx文件，拷贝到原来&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/nginx/core/nginx-1.16.1/objs</span><br><span class="line">cp nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>
<p>第三步:进入到安装目录，执行make upgrade<br>第四步:查看是否更新成功<br>.&#x2F;nginx -v<br>在整个过程中，其实Nginx是一直对外提供服务的。并且当Nginx的服务器启动成功后，我们是可以通过浏览器进行直接访问的，同时我们可以通过更改html目录下的页面来修改我们在页面上所看到的内容，那么问题来了，为什么我们要修改html目录下的文件，能不能多添加一些页面是Nginx的功能更加丰富，还有前面聊到Nginx的前端功能又是如何来实现的，这就需要我们对Nginx的核心配置文件进行一个详细的学习。</p>
<h2 id="Nginx核心配置文件结构"><a href="#Nginx核心配置文件结构" class="headerlink" title="Nginx核心配置文件结构***"></a>Nginx核心配置文件结构***</h2><p>从前面的内容学习中，我们知道Nginx的核心配置文件默认是放在<code>/etc/nginx/nginx.conf</code>，这一节，我们就来学习下nginx.conf的内容和基本配置方法。<br>读取Nginx自带的Nginx配置文件，我们将其中的注释部分【学习一个技术点就是在Nginx的配置文件中可以使用#来注释】删除掉后，就剩下下面内容:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123; <span class="comment"># 十分重要 代理 缓存都是在这里设置</span></span><br><span class="line">  <span class="attribute">include</span>       mime.types;</span><br><span class="line">  <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">  <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123; <span class="comment"># 服务</span></span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">root</span>   html;</span><br><span class="line">      <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">      <span class="attribute">root</span>   html;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">指令名 指令值;  <span class="comment">#全局块，主要设置Nginx服务器整体运行的配置指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#events块,主要设置,Nginx服务器与用户的网络连接,这一部分对Nginx服务器的性能影响较大</span></span><br><span class="line"><span class="section">events</span> &#123;     </span><br><span class="line">  指令名 指令值;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#http块，是Nginx服务器配置中的重要部分，代理、缓存、日志记录、第三方模块配置...             </span></span><br><span class="line"><span class="section">http</span> &#123;      </span><br><span class="line">  指令名 指令值;</span><br><span class="line">  <span class="section">server</span> &#123; <span class="comment">#server块，是Nginx配置和虚拟主机相关的内容</span></span><br><span class="line">    指令名 指令值;</span><br><span class="line">    <span class="section">location</span> / &#123; </span><br><span class="line">      <span class="comment">#location块，基于Nginx服务器接收请求字符串与location后面的值进行匹配，对特定请求进行处理</span></span><br><span class="line">      指令名 指令值;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单小结下:<br>nginx.conf配置文件中默认有三大块：全局块、events块、<strong>http块</strong><br>http块中可以配置多个server块，每个server块又可以配置多个location块。</p>
<h3 id="全局块"><a href="#全局块" class="headerlink" title="全局块"></a>全局块</h3><h4 id="user指令"><a href="#user指令" class="headerlink" title="user指令"></a>user指令</h4><p>（1）user:用于配置运行Nginx服务器的<strong>worker进程的用户和用户组</strong>。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>user user [group]</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>nobody</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>该属性也可以在编译的时候指定，语法如下.&#x2F;configure –user&#x3D;user –group&#x3D;group,如果两个地方都进行了设置，最终生效的是配置文件中的配置。<br>该指令的使用步骤:<br>(1)设置一个用户信息”www”<br>user www;<br>(2) 创建一个用户<br>useradd www<br>(3)修改user属性<br>user www<br>(4)创建&#x2F;root&#x2F;html&#x2F;index.html页面，添加如下内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">35em</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">      working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">      Commercial support is available at</span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>I am WWW<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(5)修改nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   /root/html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(5)测试启动访问<br>页面会报403拒绝访问的错误<br>(6)分析原因<br>因为当前用户没有访问&#x2F;root&#x2F;html目录的权限<br>(7)将文件创建到 &#x2F;home&#x2F;www&#x2F;html&#x2F;index.html,修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   /home/www/html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(8)再次测试启动访问<br>能正常访问。<br>综上所述，使用user指令可以指定启动运行工作进程的用户及用户组，这样对于系统的权限访问控制的更加精细，也更加安全。</p>
<h4 id="work-process指令"><a href="#work-process指令" class="headerlink" title="work process指令"></a>work process指令</h4><p>master_process:用来指定是否开启工作进程。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>master_process on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>master_process on;</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p><strong>worker_processes:用于配置Nginx生成工作进程的数量，这个是Nginx服务器实现并发处理服务的关键所在。理论上来说workder process的值越大，可以支持的并发处理量也越多，但事实上这个值的设定是需要受到来自服务器自身的限制，建议将该值和服务器CPU的内核数保存一致。</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>worker_processes num&#x2F;auto;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>1</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>如果将worker_processes设置成2，则会看到如下内容:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685431833832-96133b42-0704-4f7d-83dd-45314825bbb3.png#averageHue=%23191a17&clientId=ua34293e8-ddf5-4&from=paste&height=84&id=u5bfd09a4&originHeight=105&originWidth=1047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=157955&status=done&style=none&taskId=u94d825d0-a065-4da3-8746-0eef1a2afa0&title=&width=837.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685431833832-96133b42-0704-4f7d-83dd-45314825bbb3.png#averageHue=%23191a17&clientId=ua34293e8-ddf5-4&from=paste&height=84&id=u5bfd09a4&originHeight=105&originWidth=1047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=157955&status=done&style=none&taskId=u94d825d0-a065-4da3-8746-0eef1a2afa0&title=&width=837.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"></p>
<p><strong>关于以上的命令 一般默认即可 需要在修改</strong></p>
<h4 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h4><p><strong>daemon：设定Nginx是否以守护进程的方式启动。</strong><br>守护式进程是linux后台执行的一种服务进程，特点是独立于控制终端，不会随着终端关闭而停止。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>daemon on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>daemon on;</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p><strong>pid:用来配置Nginx当前master进程的进程号ID存储的文件路径。</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>pid file;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>默认为:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>该属性可以通过.&#x2F;configure –pid-path&#x3D;PATH来指定<br><strong>error_log:用来配置Nginx的错误日志存放路径</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>error_log file [日志级别];</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>error_log logs&#x2F;error.log error;</td>
</tr>
<tr>
<td>位置</td>
<td>全局块、http、server、location</td>
</tr>
</tbody></table>
<p>该属性可以通过.&#x2F;configure –error-log-path&#x3D;PATH来指定<br>其中日志级别的值有：debug|info|notice|warn|error|crit|alert|emerg，翻译过来为试|信息|通知|警告|错误|临界|警报|紧急，这块<strong>建议大家设置的时候不要设置成info以下的等级</strong>，因为会带来大量的磁盘I&#x2F;O消耗，影响Nginx的性能。<br>（5）include:用来引入其他配置文件，使Nginx的配置更加灵活</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>include file;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>无</td>
</tr>
<tr>
<td>位置</td>
<td>any</td>
</tr>
</tbody></table>
<h3 id="events块"><a href="#events块" class="headerlink" title="events块"></a>events块</h3><p>（1）accept_mutex:用来设置Nginx网络连接序列化</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>accept_mutex on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>accept_mutex on;</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<p>这个配置主要可以用来解决常说的”惊群”（<strong>所谓惊群 一个请求来了 所有worker进程 进行抢夺获取 只会有一个成功</strong>）问题。大致意思是在某一个时刻，客户端发来一个请求连接，Nginx后台是以多进程的工作模式，也就是说有多个worker进程会被同时唤醒，但是最终只会有一个进程可以获取到连接，如果每次唤醒的进程数目太多，就会影响Nginx的整体性能。<strong>如果将上述值设置为on(开启状态)，将会对多个Nginx进程接收连接进行序列号，一个个来唤醒接收，就防止了多个进程对连接的争抢。(这也不一定是绝对好 还是要看业务来进行处理 一个个慢一点)</strong></p>
<p>（2）<strong>multi_accept:用来设置是否允许同时接收多个网络连接</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>multi_accept on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>multi_accept off;</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<p>如果multi_accept被禁止了，nginx一个工作进程只能同时接受一个新的连接。否则，一个工作进程可以同时接受所有的新连接（<strong>建议设置为on 打开它</strong>）<br>（3）worker_connections：用来配置单个worker进程最大的连接数</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>worker_connections number;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>worker_commections 512;</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<p>这里的连接数不仅仅包括和前端用户建立的连接数，而是包括所有可能的连接数。另外，number值不能大于操作系统支持打开的最大文件句柄数量。<br>（4）use:用来设置Nginx服务器选择哪种事件驱动来处理网络消息。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>use method;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>根据操作系统定</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<p>注意：此处所选择事件处理模型是Nginx优化部分的一个重要内容，method的可选值有select&#x2F;poll&#x2F;epoll&#x2F;kqueue等，之前在准备centos环境的时候，我们强调过要使用linux内核在2.6以上，就是为了能使用epoll函数来优化Nginx。<br>另外这些值的选择，我们也可以在编译的时候使用<br>–with-select_module、–without-select_module、<br>–with-poll_module、–without-poll_module来设置是否需要将对应的事件驱动模块编译到Nginx的内核。</p>
<h4 id="events指令配置实例"><a href="#events指令配置实例" class="headerlink" title="events指令配置实例"></a>events指令配置实例</h4><p>打开Nginx的配置文件 nginx.conf,添加如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">events&#123;</span><br><span class="line">    accept_mutex on;</span><br><span class="line">    multi_accept on;</span><br><span class="line">    worker_commections 1024;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./nginx -t</span><br><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>


<h3 id="http块"><a href="#http块" class="headerlink" title="http块 *********"></a>http块 *********</h3><h4 id="定义MIME-Type"><a href="#定义MIME-Type" class="headerlink" title="定义MIME-Type"></a>定义MIME-Type</h4><p>我们都知道浏览器中可以显示的内容有HTML、XML、GIF等种类繁多的文件、媒体等资源，浏览器为了区分这些资源，就需要使用MIME Type。<strong>所以说MIME Type是网络资源的媒体类型。Nginx作为web服务器，也需要能够识别前端请求的资源类型。</strong><br>在Nginx的配置文件中，默认有两行配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span> mime.types;</span><br><span class="line"><span class="attribute">default_type</span> application/octet-stream; <span class="comment"># 这个是说二进制流的方式来处理</span></span><br></pre></td></tr></table></figure>
<p>（1）default_type:用来配置Nginx响应前端请求默认的MIME类型。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>default_type mime-type;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>default_type text&#x2F;plain；</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>在default_type之前还有一句include mime.types,include之前我们已经介绍过，相当于把mime.types文件中MIMT类型与相关类型文件的文件后缀名的对应关系加入到当前的配置文件中。<br>举例来说明：<br>有些时候请求某些接口的时候需要返回指定的文本字符串或者json字符串，如果逻辑非常简单或者干脆是固定的字符串，那么可以使用nginx快速实现，这样就不用编写程序响应请求了，可以减少服务器资源占用并且响应性能非常快。<br>如何实现:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /get_text &#123; <span class="comment"># 访问这个网址的时候 会按照这个配置</span></span><br><span class="line">  <span class="comment">#这里也可以设置成text/plain</span></span><br><span class="line">  <span class="attribute">default_type</span> text/html;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;This is nginx&#x27;s text&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /get_json&#123;</span><br><span class="line">  <span class="attribute">default_type</span> application/json;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&#123;&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义服务日志"><a href="#自定义服务日志" class="headerlink" title="自定义服务日志"></a>自定义服务日志</h4><p>Nginx中日志的类型分access.log、error.log。<br>access.log:用来记录用户所有的访问请求。<br>error.log:记录nginx本身运行时的错误信息，不会记录用户的访问请求。<br>Nginx服务器支持对服务日志的格式、大小、输出等进行设置，需要使用到两个指令，分别是access_log和log_format指令。<br>（1）access_log:用来设置用户访问日志的相关属性。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>access_log path[format[buffer&#x3D;size]]</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>access_log logs&#x2F;access.log combined;</td>
</tr>
<tr>
<td>位置</td>
<td>http, server, location</td>
</tr>
</tbody></table>
<p>（2）log_format:用来指定日志的输出格式。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>log_format name [escape&#x3D;default&#124;json&#124;none] string….;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>log_format combined “…”;</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<h4 id="其他配置指令"><a href="#其他配置指令" class="headerlink" title="其他配置指令"></a>其他配置指令</h4><p>（1）sendfile:用来设置Nginx服务器是否使用sendfile()传输文件，该属性可以大大提高Nginx处理静态资源的性能</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>sendfile on&#124;off；</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>sendfile off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（2）keepalive_timeout:用来设置长连接的超时时间。<br>》为什么要使用keepalive？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们都知道HTTP是一种无状态协议，客户端向服务端发送一个TCP请求，服务端响应完毕后断开连接。</span><br><span class="line">如何客户端向服务端发送多个请求，每个请求都需要重新创建一次连接，效率相对来说比较多，使用keepalive模式，可以告诉服务器端在处理完一个请求后保持这个TCP连接的打开状态，若接收到来自这个客户端的其他请求，服务端就会利用这个未被关闭的连接，而不需要重新创建一个新连接，提升效率，但是这个连接也不能一直保持，这样的话，连接如果过多，也会是服务端的性能下降，这个时候就需要我们进行设置其的超时时间。</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>keepalive_timeout time;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>keepalive_timeout 75s;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（3）keepalive_requests:用来设置一个keep-alive连接使用的次数。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>keepalive_requests number;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>keepalive_requests 100;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="server块和location块-这里只是简单的使用-具体需要等到后面"><a href="#server块和location块-这里只是简单的使用-具体需要等到后面" class="headerlink" title="server块和location块 这里只是简单的使用 具体需要等到后面"></a>server块和location块 这里只是简单的使用 具体需要等到后面</h3><p>server块和location块都是我们要重点讲解和学习的内容，因为我们后面会对Nginx的功能进行详细讲解，所以这块内容就放到静态资源部署的地方给大家详细说明。<br>本节我们主要来认识下Nginx默认给的nginx.conf中的相关内容，以及server块与location块在使用的时候需要注意的一些内容。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>       <span class="number">80</span>; <span class="comment"># 监听的是80端口</span></span><br><span class="line">  <span class="attribute">server_name</span>  localhost;</span><br><span class="line">  <span class="section">location</span> / &#123; <span class="comment"># 当访问的资源是/ 进入这里</span></span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span>  /50x.html;</span><br><span class="line">  <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Nginx进阶篇"><a href="#Nginx进阶篇" class="headerlink" title="Nginx进阶篇"></a>Nginx进阶篇</h1><h2 id="Nginx服务器基础配置实例"><a href="#Nginx服务器基础配置实例" class="headerlink" title="Nginx服务器基础配置实例"></a>Nginx服务器基础配置实例</h2><p>前面我们已经对Nginx服务器默认配置文件的结构和涉及的基本指令做了详细的阐述。通过这些指令的合理配置，我们就可以让一台Nginx服务器正常工作，并且提供基本的web服务器功能。<br>接下来我们将通过一个比较完整和最简单的基础配置实例，来巩固下前面所学习的指令及其配置。<br>需求如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（1）有如下访问：</span><br><span class="line">    http://192.168.200.133:8081/server1/location1</span><br><span class="line">        访问的是：index_sr1_location1.html</span><br><span class="line">    http://192.168.200.133:8081/server1/location2</span><br><span class="line">        访问的是：index_sr1_location2.html</span><br><span class="line">    http://192.168.200.133:8082/server2/location1</span><br><span class="line">        访问的是：index_sr2_location1.html</span><br><span class="line">    http://192.168.200.133:8082/server2/location2</span><br><span class="line">        访问的是：index_sr2_location2.html</span><br><span class="line">（2）如果访问的资源不存在，</span><br><span class="line">    返回自定义的404页面</span><br><span class="line">（3）将/server1和/server2的配置使用不同的配置文件分割</span><br><span class="line">    将文件放到/home/www/conf.d目录下，然后使用include进行合并</span><br><span class="line">（4）为/server1和/server2各自创建一个访问日志文件</span><br></pre></td></tr></table></figure>
<p>准备相关文件，目录如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685451011174-f1495a77-0ec1-4f1f-99e0-c652c2d66c9f.png#averageHue=%23252423&clientId=ufc533906-995c-4&from=paste&height=606&id=u152d4d7b&originHeight=758&originWidth=932&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=124153&status=done&style=none&taskId=uac4864bd-006e-46e3-b304-b68999d0b62&title=&width=745.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685451011174-f1495a77-0ec1-4f1f-99e0-c652c2d66c9f.png#averageHue=%23252423&clientId=ufc533906-995c-4&from=paste&height=606&id=u152d4d7b&originHeight=758&originWidth=932&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=124153&status=done&style=none&taskId=uac4864bd-006e-46e3-b304-b68999d0b62&title=&width=745.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br> 配置的内容如下:(<strong>在nginx.conf中配置</strong>)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##全局块 begin##</span></span><br><span class="line"><span class="comment">#配置允许运行Nginx工作进程的用户和用户组</span></span><br><span class="line"><span class="attribute">user</span> www;</span><br><span class="line"><span class="comment">#配置运行Nginx进程生成的worker进程数</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">#配置Nginx服务器运行对错误日志存放的路径</span></span><br><span class="line"><span class="attribute">error_log</span> logs/<span class="literal">error</span>.log;</span><br><span class="line"><span class="comment">#配置Nginx服务器允许时记录Nginx的master进程的PID文件路径和名称</span></span><br><span class="line"><span class="attribute">pid</span> logs/nginx.pid;</span><br><span class="line"><span class="comment">#配置Nginx服务是否以守护进程方法启动</span></span><br><span class="line"><span class="comment">#daemon on;</span></span><br><span class="line"><span class="comment">##全局块 end##</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##events块 begin##</span></span><br><span class="line">events&#123;</span><br><span class="line">  <span class="comment">#设置Nginx网络连接序列化</span></span><br><span class="line">  <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment">#设置Nginx的worker进程是否可以同时接收多个请求</span></span><br><span class="line">  <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment">#设置Nginx的worker进程最大的连接数</span></span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">  <span class="comment">#设置Nginx使用的事件驱动模型</span></span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">##events块 end##</span></span><br><span class="line"><span class="comment">##http块 start##</span></span><br><span class="line">http&#123;</span><br><span class="line">  <span class="comment">#定义MIME-Type</span></span><br><span class="line">  <span class="attribute">include</span> mime.types;</span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  <span class="comment">#配置允许使用sendfile方式运输</span></span><br><span class="line">  <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment">#配置连接超时时间</span></span><br><span class="line">  <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">  <span class="comment">#配置请求处理日志格式</span></span><br><span class="line">  <span class="attribute">log_format</span> server1 <span class="string">&#x27;===&gt;server1 access log&#x27;</span>;</span><br><span class="line">  <span class="attribute">log_format</span> server2 <span class="string">&#x27;===&gt;server2 access log&#x27;</span>;</span><br><span class="line">  <span class="comment">##server块 开始 导入这个目录下的所有conf 也就是以下的server块 http中有server块来指定请求配置##</span></span><br><span class="line">  <span class="attribute">include</span> /home/www/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">    <span class="comment">##server块 结束##</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">##http块 end##</span></span><br></pre></td></tr></table></figure>
<p>server1.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  <span class="comment">#配置监听端口和主机名称</span></span><br><span class="line">  <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">  <span class="comment">#配置请求处理日志存放路径</span></span><br><span class="line">  <span class="attribute">access_log</span> /home/www/myweb/server1/logs/access.log server1;</span><br><span class="line">  <span class="comment">#配置错误页面</span></span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">  <span class="comment">#配置处理/server1/location1请求的location</span></span><br><span class="line">  <span class="section">location</span> /server1/location1&#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> index_sr1_location1.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#配置处理/server1/location2请求的location</span></span><br><span class="line">  <span class="section">location</span> /server1/location2&#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> index_sr1_location2.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#配置错误页面转向</span></span><br><span class="line">  <span class="section">location</span> = /<span class="number">404</span>.html &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> <span class="number">404</span>.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server2.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  <span class="comment">#配置监听端口和主机名称</span></span><br><span class="line">  <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">  <span class="comment">#配置请求处理日志存放路径</span></span><br><span class="line">  <span class="attribute">access_log</span> /home/www/myweb/server2/logs/access.log server2;</span><br><span class="line">  <span class="comment">#配置错误页面,对404.html做了定向配置</span></span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">  <span class="comment">#配置处理/server1/location1请求的location</span></span><br><span class="line">  <span class="section">location</span> /server2/location1&#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> index_sr2_location1.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#配置处理/server2/location2请求的location</span></span><br><span class="line">  <span class="section">location</span> /server2/location2&#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> index_sr2_location2.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#配置错误页面转向</span></span><br><span class="line">  <span class="section">location</span> = /<span class="number">404</span>.html &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/myweb;</span><br><span class="line">    <span class="attribute">index</span> <span class="number">404</span>.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx服务操作的问题"><a href="#Nginx服务操作的问题" class="headerlink" title="Nginx服务操作的问题"></a>Nginx服务操作的问题</h2><p>经过前面的操作，我们会发现，如果想要启动、关闭或重新加载nginx配置文件，都需要先进入到nginx的安装目录的sbin目录，然后使用nginx的二级制可执行文件来操作，相对来说操作比较繁琐，这块该如何优化？另外如果我们想把Nginx设置成随着服务器启动就自动完成启动操作，又该如何来实现?这就需要用到接下来我们要讲解的两个知识点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Nginx配置成系统服务</span><br><span class="line">Nginx命令配置到系统环境</span><br></pre></td></tr></table></figure>
<h2 id="Nginx配置成系统服务"><a href="#Nginx配置成系统服务" class="headerlink" title="Nginx配置成系统服务"></a>Nginx配置成系统服务</h2><p>把Nginx应用服务设置成为系统服务，方便对Nginx服务的启动和停止等相关操作，具体实现步骤:<br>(1) 在&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system目录下添加nginx.service,内容如下:<br>vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx web service</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid # 这里及以下都需要改成自己的</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure>
<p>(2)添加完成后如果权限有问题需要进行权限设置<br>chmod 755 &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service<br>(3)使用系统命令来操作Nginx服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">启动: systemctl start nginx</span><br><span class="line">停止: systemctl stop nginx</span><br><span class="line">重启: systemctl restart nginx</span><br><span class="line">重新加载配置文件: systemctl reload nginx</span><br><span class="line">查看nginx状态: systemctl status nginx</span><br><span class="line">开机启动: systemctl enable nginx</span><br></pre></td></tr></table></figure>
<h2 id="Nginx命令配置到系统环境"><a href="#Nginx命令配置到系统环境" class="headerlink" title="Nginx命令配置到系统环境"></a>Nginx命令配置到系统环境</h2><p>前面我们介绍过Nginx安装目录下的二级制可执行文件nginx的很多命令，要想使用这些命令前提是需要进入sbin目录下才能使用，很不方便，如何去优化，我们可以将该二进制可执行文件加入到系统的环境变量，这样的话在任何目录都可以使用nginx对应的相关命令。具体实现步骤如下:<br>演示可删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br><span class="line">cd /usr/local/nginx/sbin  nginx -V</span><br><span class="line">如何优化？？？</span><br></pre></td></tr></table></figure>
<p>(1)修改&#x2F;etc&#x2F;profile文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">在最后一行添加</span><br><span class="line">export PATH=$PATH:/usr/sbin</span><br></pre></td></tr></table></figure>
<p>(2)使之立即生效<br>source &#x2F;etc&#x2F;profile<br>(3)执行nginx命令<br>nginx -V</p>
<h2 id="Nginx静态资源部署"><a href="#Nginx静态资源部署" class="headerlink" title="Nginx静态资源部署 ***"></a>Nginx静态资源部署 ***</h2><h3 id="Nginx静态资源概述"><a href="#Nginx静态资源概述" class="headerlink" title="Nginx静态资源概述"></a>Nginx静态资源概述</h3><p>上网去搜索访问资源对于我们来说并不陌生，通过浏览器发送一个HTTP请求实现从客户端发送请求到服务器端获取所需要内容后并把内容回显展示在页面的一个过程。这个时候，我们所请 求的内容就分为两种类型，一类是静态资源、一类是动态资源。静态资源即指在服务器端真实存在并且能直接拿来展示的一些文件，比如常见的html页面、css文件、js文件、图 片、视频等资源；动态资源即指在服务器端真实存在但是要想获取需要经过一定的业务逻辑处理，根据不同的条件展示在页面不同这 一部分内容，比如说报表数据展示、根据当前登录用户展示相关具体数据等资源；<br>Nginx处理静态资源的内容，我们需要考虑下面这几个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）静态资源的配置指令</span><br><span class="line">（2）静态资源的配置优化</span><br><span class="line">（3）静态资源的压缩配置指令</span><br><span class="line">（4）静态资源的缓存处理</span><br><span class="line">（5）静态资源的访问控制，包括跨域问题和防盗链问题</span><br></pre></td></tr></table></figure>
<h3 id="Nginx静态资源的配置指令"><a href="#Nginx静态资源的配置指令" class="headerlink" title="Nginx静态资源的配置指令"></a>Nginx静态资源的配置指令</h3><h4 id="listen指令"><a href="#listen指令" class="headerlink" title="listen指令"></a>listen指令</h4><p>listen:用来配置监听端口。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>listen address[:port] [default_server]…;listen port [default_server]…;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>listen *:80 &#124; *:8000</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<p>listen的设置比较灵活，我们通过几个例子来把常用的设置方式熟悉下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8000; // listen localhost:8000 监听指定的IP和端口</span><br><span class="line">listen 127.0.0.1;   监听指定IP的所有端口</span><br><span class="line">listen 8000;    监听指定端口上的连接</span><br><span class="line">listen *:8000;  监听指定端口上的连接</span><br></pre></td></tr></table></figure>
<p><strong>default_server属性是标识符，用来将此虚拟主机设置成默认主机。所谓的默认主机指的是如果没有匹配到对应的address:port，则会默认执行的。如果不指定默认使用的是第一个server。</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">  <span class="attribute">server_name</span> <span class="number">127.0.0.1</span>;</span><br><span class="line">  <span class="section">location</span> /&#123;</span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">8080</span> default_server;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">  <span class="attribute">default_type</span> text/plain;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">444</span> <span class="string">&#x27;This is a error request&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="server-name指令"><a href="#server-name指令" class="headerlink" title="server_name指令"></a>server_name指令</h4><p><strong>server_name：用来设置虚拟主机服务名称。 可以直接写域名</strong><br>127.0.0.1 、 localhost 、域名[<a target="_blank" rel="noopener" href="https://www.baidu.com/">www.baidu.com</a> | <a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a>]</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>server_name name …;name可以提供多个中间用空格分隔</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>server_name “”;</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<p>关于server_name的配置方式有三种，分别是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">精确匹配</span><br><span class="line">通配符匹配</span><br><span class="line">正则表达式匹配</span><br></pre></td></tr></table></figure>
<p>配置方式一：精确匹配<br>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.itcast.cn www.itheima.cn;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>补充小知识点:<br>hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统会再将网址提交DNS域名解析服务器进行IP地址的解析。<br>windows:C:\Windows\System32\drivers\etc<br>centos：&#x2F;etc&#x2F;hosts<br>因为域名是要收取一定的费用，所以我们可以使用修改hosts文件来制作一些虚拟域名来使用。需要修改 &#x2F;etc&#x2F;hosts文件来添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">127.0.0.1 www.itcast.cn</span><br><span class="line">127.0.0.1 www.itheima.cn</span><br></pre></td></tr></table></figure>
<p>配置方式二:<strong>使用通配符配置</strong><br>server_name中支持通配符”*”,但需要注意的是通配符不能出现在域名的中间，只能出现在首段或尾段，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  *.itcast.cn    www.itheima.*;</span><br><span class="line">    # www.itcast.cn abc.itcast.cn www.itheima.cn www.itheima.com</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面的配置就会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  www.*.cn www.itheima.c*</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置三:<strong>使用正则表达式配置</strong><br>server_name中可以使用正则表达式，并且使用~作为正则表达式字符串的开始标记。<br>常见的正则表达式</p>
<table>
<thead>
<tr>
<th><strong>代码</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>匹配搜索字符串开始位置</td>
</tr>
<tr>
<td>$</td>
<td>匹配搜索字符串结束位置</td>
</tr>
<tr>
<td>.</td>
<td>匹配除换行符\n之外的任何单个字符</td>
</tr>
<tr>
<td>\</td>
<td>转义字符，将下一个字符标记为特殊字符</td>
</tr>
<tr>
<td>[xyz]</td>
<td>字符集，与任意一个指定字符匹配</td>
</tr>
<tr>
<td>[a-z]</td>
<td>字符范围，匹配指定范围内的任何字符</td>
</tr>
<tr>
<td>\w</td>
<td>与以下任意字符匹配 A-Z a-z 0-9 和下划线,等效于[A-Za-z0-9_]</td>
</tr>
<tr>
<td>\d</td>
<td>数字字符匹配，等效于[0-9]</td>
</tr>
<tr>
<td>{n}</td>
<td>正好匹配n次</td>
</tr>
<tr>
<td>{n,}</td>
<td>至少匹配n次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>匹配至少n次至多m次</td>
</tr>
<tr>
<td>*</td>
<td>零次或多次，等效于{0,}</td>
</tr>
<tr>
<td>+</td>
<td>一次或多次，等效于{1,}</td>
</tr>
<tr>
<td>?</td>
<td>零次或一次，等效于{0,1}</td>
</tr>
</tbody></table>
<p>配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name ~^www\.(\w+)\.com$;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 $1  $2 ..;</span><br><span class="line">&#125;</span><br><span class="line">注意 ~后面不能加空格，括号可以取值</span><br></pre></td></tr></table></figure>
<h5 id="匹配执行顺序"><a href="#匹配执行顺序" class="headerlink" title="匹配执行顺序"></a>匹配执行顺序</h5><p>由于server_name指令支持通配符和正则表达式，因此在包含多个虚拟主机的配置文件中，可能会出现一个名称被多个虚拟主机的server_name匹配成功，当遇到这种情况，当前的请求交给谁来处理呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ~^www\.\w+\.com$;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 &#x27;regex_success&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.itheima.*;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 &#x27;wildcard_after_success&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name *.itheima.com;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 &#x27;wildcard_before_success&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.itheima.com;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 &#x27;exact_success&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    server_name _;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 444 &#x27;default_server not found server&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结论：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exact_success</span><br><span class="line">wildcard_before_success</span><br><span class="line">wildcard_after_success</span><br><span class="line">regex_success</span><br><span class="line">default_server not found server!!</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">No1:准确匹配server_name</span><br><span class="line"></span><br><span class="line">No2:通配符在开始时匹配server_name成功</span><br><span class="line"></span><br><span class="line">No3:通配符在结束时匹配server_name成功</span><br><span class="line"></span><br><span class="line">No4:正则表达式匹配server_name成功</span><br><span class="line"></span><br><span class="line">No5:被默认的default_server处理，如果没有指定默认找第一个server</span><br></pre></td></tr></table></figure>
<h4 id="location指令"><a href="#location指令" class="headerlink" title="location指令"></a>location指令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    location /abc&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>location:用来设置请求的URI</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><em><em>location [ &#x3D; &#124; ~ &#124; ~</em> &#124; ^~ &#124;@ ] uri{…}</em>*</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server,location</td>
</tr>
</tbody></table>
<p>uri变量是待匹配的请求字符串，可以不包含正则表达式，也可以包含正则表达式，那么nginx服务器在搜索匹配location的时候，是先使用不包含正则表达式进行匹配，找到一个匹配度最高的一个，然后在通过包含正则表达式的进行匹配，如果能匹配到直接访问，匹配不到，就使用刚才匹配度最高的那个location来处理请求。<br>属性介绍:<br><strong>不带符号，要求必须以指定模式开始</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line">    location /abc&#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 &quot;access success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">以下访问都是正确的</span><br><span class="line">http://192.168.200.133/abc</span><br><span class="line">http://192.168.200.133/abc?p1=TOM</span><br><span class="line">http://192.168.200.133/abc/</span><br><span class="line">http://192.168.200.133/abcdef</span><br></pre></td></tr></table></figure>
<p><strong>&#x3D; : 用于不包含正则表达式的uri前，必须与指定的模式精确匹配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line">    location =/abc&#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 &quot;access success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">可以匹配到</span><br><span class="line">http://192.168.200.133/abc</span><br><span class="line">http://192.168.200.133/abc?p1=TOM</span><br><span class="line">匹配不到</span><br><span class="line">http://192.168.200.133/abc/</span><br><span class="line">http://192.168.200.133/abcdef</span><br></pre></td></tr></table></figure>
<p><strong>~ ： 用于表示当前uri中包含了正则表达式，并且区分大小写~*: 用于表示当前uri中包含了正则表达式，并且不区分大小写</strong><br><strong>换句话说，如果uri包含了正则表达式，需要用上述两个符合来标识</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line">    location ~^/abc\w$&#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 &quot;access success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line">    location ~*^/abc\w$&#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 &quot;access success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>^~: 用于不包含正则表达式的uri前，功能和不加符号的一致，唯一不同的是，如果模式匹配，那么就停止搜索其他模式了。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line">    location ^~/abc&#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 &quot;access success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置请求资源的目录root-alias"><a href="#设置请求资源的目录root-alias" class="headerlink" title="设置请求资源的目录root &#x2F; alias"></a>设置请求资源的目录root &#x2F; alias</h4><p><strong>root：设置请求的根目录</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>root path;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>root html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>path为Nginx服务器接收到请求以后查找资源的根目录路径。<br><strong>alias：用来更改location的URI</strong></p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>alias path;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>location</td>
</tr>
</tbody></table>
<p>path为修改后的根路径。<br>以上两个指令都可以来指定访问资源的路径，那么这两者之间的区别是什么?<br>举例说明：<br>（1）在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html目录下创建一个 images目录,并在目录下放入一张图片mv.png图片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">    root /usr/local/nginx/html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问图片的路径为:<br><a target="_blank" rel="noopener" href="http://192.168.200.133/images/mv.png">http://192.168.200.133/images/mv.png</a><br>（2）如果把root改为alias</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">    alias /usr/local/nginx/html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次访问上述地址，页面会出现404的错误，查看错误日志会发现是因为地址不对，所以验证了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root的处理结果是: root路径+location路径</span><br><span class="line">/usr/local/nginx/html/images/mv.png</span><br><span class="line">alias的处理结果是:使用alias路径替换location路径</span><br><span class="line">/usr/local/nginx/html/images</span><br></pre></td></tr></table></figure>
<p>需要在alias后面路径改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">    alias /usr/local/nginx/html/images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）如果location路径是以&#x2F;结尾,则alias也必须是以&#x2F;结尾，root没有要求<br>将上述配置修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123;</span><br><span class="line">    alias /usr/local/nginx/html/images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问就会出问题，查看错误日志还是路径不对，所以需要把alias后面加上 &#x2F;<br>小结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root的处理结果是: root路径+location路径</span><br><span class="line">alias的处理结果是:使用alias路径替换location路径</span><br><span class="line">alias是一个目录别名的定义，root则是最上层目录的含义。</span><br><span class="line">如果location路径是以/结尾,则alias也必须是以/结尾，root没有要求</span><br></pre></td></tr></table></figure>
<h4 id="index指令"><a href="#index指令" class="headerlink" title="index指令"></a>index指令</h4><p>index:设置网站的默认首页</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>index file …;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>index index.html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>index后面可以跟多个设置，如果访问的时候没有指定具体访问的资源，则会依次进行查找，找到第一个为止。<br>举例说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root /usr/local/nginx/html;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">访问该location的时候，可以通过 http://ip:port/，地址后面如果不添加任何内容，则默认依次访问index.html和index.htm，找到第一个来进行返回</span><br></pre></td></tr></table></figure>
<h4 id="error-page指令"><a href="#error-page指令" class="headerlink" title="error_page指令"></a>error_page指令</h4><p>error_page:设置网站的错误页面</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>error_page code … [&#x3D;[response]] uri;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location……</td>
</tr>
</tbody></table>
<p>当出现对应的响应code后，如何来处理。<br>举例说明：<br>（1）可以指定具体跳转的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    error_page 404 http://www.itcast.cn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）可以指定重定向地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    error_page 404 /50x.html;</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location =/50x.html&#123;</span><br><span class="line">        root html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）使用location的@符合完成错误信息展示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    error_page 404 @jump_to_error;</span><br><span class="line">    location @jump_to_error &#123;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 404 &#x27;Not Found Page...&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可选项&#x3D;[response]的作用是用来将相应代码更改为另外一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    error_page 404 =200 /50x.html;</span><br><span class="line">    location =/50x.html&#123;</span><br><span class="line">        root html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">这样的话，当返回404找不到对应的资源的时候，在浏览器上可以看到，最终返回的状态码是200，这块需要注意下，编写error_page后面的内容，404后面需要加空格，200前面不能加空格</span><br></pre></td></tr></table></figure>
<h3 id="静态资源优化配置语法"><a href="#静态资源优化配置语法" class="headerlink" title="静态资源优化配置语法"></a>静态资源优化配置语法</h3><p>Nginx对静态资源如何进行优化配置。这里从三个属性配置进行优化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodeplay on;</span><br></pre></td></tr></table></figure>
<p>（1）sendﬁle，用来开启高效的文件传输模式。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>sendﬁle on &#124;oﬀ;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>sendﬁle oﬀ;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p>请求静态资源的过程：客户端通过网络接口向服务端发送请求，操作系统将这些客户端的请求传递给服务器端应用程序，服务器端应用程序会处理这些请求，请求处理完成以后，操作系统还需要将处理得到的结果通过网络适配器传递回去。<br>如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost；</span><br><span class="line">	location / &#123;</span><br><span class="line">		<span class="attribute">root</span> html;</span><br><span class="line">		<span class="attribute">index</span> index.html;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">在html目录下有一个welcome.html页面，访问地址</span><br><span class="line">http://192.168.200.133/welcome.html</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685457752923-65d270dd-1a22-4dce-92bb-d28c2243464c.png#averageHue=%23f4f3f3&clientId=ufc533906-995c-4&from=paste&height=657&id=ua9cde1d3&originHeight=821&originWidth=1218&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=178411&status=done&style=none&taskId=uaac37d86-05c8-42aa-8b29-5c485dc5cca&title=&width=974.4" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685457752923-65d270dd-1a22-4dce-92bb-d28c2243464c.png#averageHue=%23f4f3f3&clientId=ufc533906-995c-4&from=paste&height=657&id=ua9cde1d3&originHeight=821&originWidth=1218&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=178411&status=done&style=none&taskId=uaac37d86-05c8-42aa-8b29-5c485dc5cca&title=&width=974.4" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>不使用sendfile的时候 需要进行多次拷贝 因为从磁盘 到缓冲区 在经由网卡发送 需要多次的拷贝<br>使用了sendfile的时候 他是一个函数 指定从哪里获取 交给谁 少了很多的copy</p>
<p>（2）tcp_nopush：该指令必须在sendfile打开的状态下才会生效，主要是用来提升网络包的传输’效率’</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>tcp_nopush on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nopush oﬀ;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（3）tcp_nodelay：该指令必须在keep-alive连接开启的情况下才生效，来提高网络包传输的’实时性’</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>tcp_nodelay on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nodelay on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685458630486-4896ce06-4945-4a28-8cfe-38cdce67cb30.png#averageHue=%23f9f9f9&clientId=ufc533906-995c-4&from=paste&height=590&id=u0d3657e7&originHeight=737&originWidth=1215&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=114259&status=done&style=none&taskId=ub76cec88-83cc-4f1a-ab94-550b8624ceb&title=&width=972" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685458630486-4896ce06-4945-4a28-8cfe-38cdce67cb30.png#averageHue=%23f9f9f9&clientId=ufc533906-995c-4&from=paste&height=590&id=u0d3657e7&originHeight=737&originWidth=1215&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=114259&status=done&style=none&taskId=ub76cec88-83cc-4f1a-ab94-550b8624ceb&title=&width=972" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>经过刚才的分析，”tcp_nopush”和”tcp_nodelay“看起来是”互斥的”，那么为什么要将这两个值都打开，这个大家需要知道的是在linux2.5.9以后的版本中两者是可以兼容的，三个指令都开启的好处是，sendfile可以开启高效的文件传输模式，tcp_nopush开启可以确保在发送到客户端之前数据包已经充分“填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有“填满”而暂停的数据包时，Nginx会忽略tcp_nopush参数， 然后，tcp_nodelay强制套接字发送数据。由此可知，TCP_NOPUSH可以与TCP_NODELAY一起设置，它比单独配置TCP_NODELAY具有更强的性能。所以我们可以使用如下配置来优化Nginx静态资源的处理 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br></pre></td></tr></table></figure>


<h3 id="Nginx静态资源压缩实战"><a href="#Nginx静态资源压缩实战" class="headerlink" title="Nginx静态资源压缩实战"></a>Nginx静态资源压缩实战</h3><p>经过上述内容的优化，我们再次思考一个问题，假如在满足上述优化的前提下，我们传送一个1M的数据和一个10M的数据那个效率高?，答案显而易见，传输内容小，速度就会快。那么问题又来了，同样的内容，如果把大小降下来，我们脑袋里面要蹦出一个词就是”压缩”，接下来，我们来学习Nginx的静态资源压缩模块。<br>在Nginx的配置文件中可以通过配置gzip来对静态资源进行压缩，相关的指令可以配置在http块、server块和location块中，Nginx可以通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_gzip_module模块</span><br><span class="line">ngx_http_gzip_static_module模块</span><br><span class="line">ngx_http_gunzip_module模块</span><br></pre></td></tr></table></figure>
<p>对这些指令进行解析和处理。<br>接下来我们从以下内容进行学习</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（1）Gzip各模块支持的配置指令</span><br><span class="line">（2）Gzip压缩功能的配置</span><br><span class="line">（3）Gzip和sendfile的冲突解决</span><br><span class="line">（4）浏览器不支持Gzip的解决方案</span><br></pre></td></tr></table></figure>
<h4 id="Gzip模块配置指令"><a href="#Gzip模块配置指令" class="headerlink" title="Gzip模块配置指令"></a>Gzip模块配置指令</h4><p>接下来所学习的指令都来自ngx_http_gzip_module模块，该模块会在nginx安装的时候内置到nginx的安装环境中，也就是说我们可以直接使用这些指令。</p>
<ol>
<li>gzip指令：该指令用于开启或者关闭gzip功能<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
</li>
</ol>
<p>注意只有该指令为打开状态，下面的指令才有效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">   gzip on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>gzip_types指令：该指令可以根据响应页的MIME类型选择性地开启Gzip压缩功能 <table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_types mime-type …;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_types text&#x2F;html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p>所选择的值可以从mime.types文件中进行查找，也可以使用”*”代表所有。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    gzip_types application/javascript; # 这个类型的才会压缩 可指定位*</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>gzip_comp_level指令：该指令用于设置Gzip压缩程度，级别从1-9,1表示要是程度最低，要是效率最高，9刚好相反，压缩程度最高，但是效率最低最费时间。<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_comp_level level;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_comp_level 1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    gzip_comp_level 6; # </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>gzip_vary指令：该指令用于设置使用Gzip进行压缩发送是否携带“Vary:Accept-Encoding”头域的响应头部。主要是告诉接收方，所发送的数据经过了Gzip压缩处理<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_vary on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_vary off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685459516859-cd8e0d19-2281-4bff-96cc-b39d03fe4c05.png#averageHue=%23f5f5f5&clientId=ufc533906-995c-4&from=paste&height=334&id=u677fdbe7&originHeight=418&originWidth=697&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80472&status=done&style=none&taskId=u28dab2ca-175a-4aad-8eda-93d0eba7f2a&title=&width=557.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685459516859-cd8e0d19-2281-4bff-96cc-b39d03fe4c05.png#averageHue=%23f5f5f5&clientId=ufc533906-995c-4&from=paste&height=334&id=u677fdbe7&originHeight=418&originWidth=697&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80472&status=done&style=none&taskId=u28dab2ca-175a-4aad-8eda-93d0eba7f2a&title=&width=557.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"></p>
<ol start="5">
<li>gzip_buffers指令：该指令用于处理请求压缩的缓冲区数量和大小。<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_buffers number size;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_buffers 32 4k&#124;16 8k;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p>其中number:指定Nginx服务器向系统申请缓存空间个数，size指的是每个缓存空间的大小。主要实现的是申请number个每个大小为size的内存空间。这个值的设定一般会和服务器的操作系统有关，所以建议此项不设置，使用默认值即可。<br>gzip_buffers 4 16K;   #缓存空间大小</p>
<ol start="6">
<li>gzip_disable指令：针对不同种类客户端发起的请求，可以选择性地开启和关闭Gzip功能。<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_disable regex …;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p>regex:根据客户端的浏览器标志(user-agent)来设置，支持使用正则表达式。指定的浏览器标志不使用Gzip.该指令一般是用来排除一些明显不支持Gzip的浏览器。<br>gzip_disable “MSIE [1-6].“;</p>
<ol start="7">
<li>gzip_http_version指令：针对不同的HTTP协议版本，可以选择性地开启和关闭Gzip功能。<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_http_version 1.0&#124;1.1;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_http_version 1.1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p>该指令是指定使用Gzip的HTTP最低版本，该指令一般采用默认值即可。</p>
<ol start="8">
<li>gzip_min_length指令：该指令针对传输数据的大小，可以选择性地开启和关闭Gzip功能<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_min_length length;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_min_length 20;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nignx计量大小的单位：bytes[字节] / kb[千字节] / M[兆]</span><br><span class="line">例如: 1024 / 10k|K / 10m|M</span><br></pre></td></tr></table></figure>
<p>Gzip压缩功能对大数据的压缩效果明显，但是如果要压缩的数据比较小的化，可能出现越压缩数据量越大的情况，因此我们需要根据响应内容的大小来决定是否使用Gzip功能，响应页面的大小可以通过头信息中的Content-Length来获取。但是如何使用了Chunk编码动态压缩，该指令将被忽略。建议设置为1K或以上。</p>
<ol start="9">
<li>gzip_proxied指令：该指令设置是否对服务端返回的结果进行Gzip压缩。<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_proxied off&#124;expired&#124;no-cache&#124;no-store&#124;private&#124;no_last_modified&#124;no_etag&#124;auth&#124;any;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_proxied off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
</li>
</ol>
<p>off - 关闭Nginx服务器对后台服务器返回结果的Gzip压缩expired - 启用压缩，如果header头中包含 “Expires” 头信息no-cache - 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息no-store - 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息private - 启用压缩，如果header头中包含 “Cache-Control:private” 头信息no_last_modified - 启用压缩,如果header头中不包含 “Last-Modified” 头信息no_etag - 启用压缩 ,如果header头中不包含 “ETag” 头信息auth - 启用压缩 , 如果header头中包含 “Authorization” 头信息any - 无条件启用压缩</p>
<h4 id="Gzip压缩功能的实例配置"><a href="#Gzip压缩功能的实例配置" class="headerlink" title="Gzip压缩功能的实例配置"></a>Gzip压缩功能的实例配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gzip on;              #开启gzip功能</span><br><span class="line">gzip_types *;         #压缩源文件类型,根据具体的访问资源类型设定</span><br><span class="line">gzip_comp_level 6;    #gzip压缩级别</span><br><span class="line">gzip_min_length 1024; #进行压缩响应页面的最小长度,content-length</span><br><span class="line">gzip_buffers 4 16K;   #缓存空间大小</span><br><span class="line">gzip_http_version 1.1; #指定压缩响应所需要的最低HTTP请求版本</span><br><span class="line">gzip_vary  on;        #往头信息中添加压缩标识</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;; #对IE6以下的版本都不进行压缩</span><br><span class="line">gzip_proxied  off； #nginx作为反向代理压缩服务端返回数据的条件</span><br></pre></td></tr></table></figure>
<p>这些配置在很多地方可能都会用到，所以我们可以将这些内容抽取到一个配置文件中，然后通过include指令把配置文件再次加载到nginx.conf配置文件中，方法使用。<br>nginx_gzip.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gzip on;</span><br><span class="line">gzip_types *;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_min_length 1024;</span><br><span class="line">gzip_buffers 4 16K;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_vary  on;</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line">gzip_proxied  off;</span><br></pre></td></tr></table></figure>
<p>nginx.conf<br>include nginx_gzip.conf</p>
<h4 id="Gzip和sendfile共存问题"><a href="#Gzip和sendfile共存问题" class="headerlink" title="Gzip和sendfile共存问题"></a>Gzip和sendfile共存问题</h4><p>前面在讲解sendfile的时候，提到过，开启sendfile以后，在读取磁盘上的静态资源文件的时候，可以减少拷贝的次数，可以不经过用户进程将静态文件通过网络设备发送出去，但是Gzip要想对资源压缩，是需要经过用户进程进行操作的。所以如何解决两个设置的共存问题。<br>可以使用ngx_http_gzip_static_module模块的gzip_static指令来解决。</p>
<h5 id="gzip-static指令"><a href="#gzip-static指令" class="headerlink" title="gzip_static指令"></a>gzip_static指令</h5><p>gzip_static: 检查与访问资源同名的.gz文件时，response中以gzip相关的header返回.gz文件的内容。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>gzip_static on &#124; off &#124; always;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_static off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>添加上述命令后，会报一个错误，unknown directive “gzip_static”主要的原因是Nginx默认是没有添加ngx_http_gzip_static_module模块。如何来添加?</p>
<h5 id="添加模块到Nginx的实现步骤"><a href="#添加模块到Nginx的实现步骤" class="headerlink" title="添加模块到Nginx的实现步骤"></a>添加模块到Nginx的实现步骤</h5><p>(1)查询当前Nginx的配置参数<br>nginx -V<br>(2)将nginx安装目录下sbin目录中的nginx二进制文件进行更名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">mv nginx nginxold</span><br></pre></td></tr></table></figure>
<p>(3) 进入Nginx的安装目录<br>cd &#x2F;root&#x2F;nginx&#x2F;core&#x2F;nginx-1.16.1<br>(4)执行make clean清空之前编译的内容<br>make clean<br>(5)使用configure来配置参数<br>.&#x2F;configure –with-http_gzip_static_module<br>(6)使用make命令进行编译<br>make<br>(7) 将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin目录中<br>mv objs&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<br>(8)执行更新命令<br>make upgrade</p>
<h5 id="gzip-static测试使用"><a href="#gzip-static测试使用" class="headerlink" title="gzip_static测试使用"></a>gzip_static测试使用</h5><h3 id="静态资源的缓存处理"><a href="#静态资源的缓存处理" class="headerlink" title="静态资源的缓存处理"></a>静态资源的缓存处理</h3><h4 id="什么是缓存"><a href="#什么是缓存" class="headerlink" title="什么是缓存"></a>什么是缓存</h4><p>缓存（cache），原始意义是指访问速度比一般随机存取存储器（RAM）快的一种高速存储器，通常它不像系统主存那样使用DRAM技术，而使用昂贵但较快速的SRAM技术。缓存的设置是所有现代计算机系统发挥高性能的重要因素之一。</p>
<h4 id="什么是web缓存"><a href="#什么是web缓存" class="headerlink" title="什么是web缓存"></a>什么是web缓存</h4><p>Web缓存是指一个Web资源（如html页面，图片，js，数据等）存在于Web服务器和客户端（浏览器）之间的副本。缓存会根据进来的请求保存输出内容的副本；当下一个请求来到的时候，如果是相同的URL，缓存会根据缓存机制决定是直接使用副本响应访问请求，还是向源服务器再次发送请求。比较常见的就是浏览器会缓存访问过网站的网页，当再次访问这个URL地址的时候，如果网页没有更新，就不会再次下载网页，而是直接使用本地缓存的网页。只有当网站明确标识资源已经更新，浏览器才会再次下载网页</p>
<h4 id="web缓存的种类"><a href="#web缓存的种类" class="headerlink" title="web缓存的种类"></a>web缓存的种类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">客户端缓存</span><br><span class="line">    浏览器缓存</span><br><span class="line">服务端缓存</span><br><span class="line">    Nginx / Redis / Memcached等</span><br></pre></td></tr></table></figure>
<h4 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h4><p>是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览.</p>
<h4 id="为什么要用浏览器缓存"><a href="#为什么要用浏览器缓存" class="headerlink" title="为什么要用浏览器缓存"></a>为什么要用浏览器缓存</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">成本最低的一种缓存实现</span><br><span class="line">减少网络带宽消耗</span><br><span class="line">降低服务器压力</span><br><span class="line">减少网络延迟，加快页面打开速度</span><br></pre></td></tr></table></figure>
<h4 id="浏览器缓存的执行流程"><a href="#浏览器缓存的执行流程" class="headerlink" title="浏览器缓存的执行流程"></a>浏览器缓存的执行流程</h4><p>HTTP协议中和页面缓存相关的字段，我们先来认识下：</p>
<table>
<thead>
<tr>
<th><strong>header</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Expires</td>
<td>缓存过期的日期和时间</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>设置和缓存相关的配置信息</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>请求资源最后修改时间</td>
</tr>
<tr>
<td>ETag</td>
<td>请求变量的实体标签的当前值，比如文件的MD5值</td>
</tr>
</tbody></table>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685461471712-0fa2cc5a-b4a4-469a-a554-a75e853cdcaf.png#averageHue=%23f6f6f5&clientId=ufc533906-995c-4&from=paste&height=422&id=ua9432f21&originHeight=527&originWidth=1194&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=695862&status=done&style=none&taskId=u7d46a54f-5d72-4f5e-9d3e-69806bad48a&title=&width=955.2" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685461471712-0fa2cc5a-b4a4-469a-a554-a75e853cdcaf.png#averageHue=%23f6f6f5&clientId=ufc533906-995c-4&from=paste&height=422&id=ua9432f21&originHeight=527&originWidth=1194&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=695862&status=done&style=none&taskId=u7d46a54f-5d72-4f5e-9d3e-69806bad48a&title=&width=955.2" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>（1）用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送request请求来获取数据；<br>（2）服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回200的成功状态码并且在响应头上附上对应资源以及缓存信息；<br>（3）当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件<br>（4）如果没有找到对应的缓存文件，则走(2)步<br>（5）如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是(Expires),<br>（6）如果没有过期，则直接从本地缓存中返回数据进行展示<br>（7）如果Expires过期，接下来需要判断缓存文件是否发生过变化<br>（8）判断的标准有两个，一个是ETag(Entity Tag),一个是Last-Modified<br>（9）判断结果是未发生变化，则服务端返回304，直接从缓存文件中获取数据<br>（10）如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商(服务端所设置的是否需要进行缓存数据的设置)来进行数据缓存。</p>
<h4 id="浏览器缓存相关指令"><a href="#浏览器缓存相关指令" class="headerlink" title="浏览器缓存相关指令"></a>浏览器缓存相关指令</h4><p>Nginx需要进行缓存相关设置，就需要用到如下的指令</p>
<h5 id="expires指令"><a href="#expires指令" class="headerlink" title="expires指令"></a>expires指令</h5><p>expires:该指令用来控制页面缓存的作用。可以通过该指令控制HTTP应答中的“Expires”和”Cache-Control”</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>expires [modified] timeexpires epoch&#124;max&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>expires off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>time:可以整数也可以是负数，指定过期时间，如果是负数，Cache-Control则为no-cache,如果为整数或0，则Cache-Control的值为max-age&#x3D;time;<br>epoch: 指定Expires的值为’1 January,1970,00:00:01 GMT’(1970-01-01 00:00:00)，Cache-Control的值no-cache<br>max:指定Expires的值为’31 December2037 23:59:59GMT’ (2037-12-31 23:59:59) ，Cache-Control的值为10年<br>off:默认不缓存。</p>
<h5 id="add-header指令"><a href="#add-header指令" class="headerlink" title="add_header指令"></a>add_header指令</h5><p>add_header指令是用来添加指定的响应头和响应值。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>add_header name value [always];</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p>Cache-Control作为响应头信息，可以设置如下值：<br>缓存响应指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cache-control: must-revalidate</span><br><span class="line">Cache-control: no-cache</span><br><span class="line">Cache-control: no-store</span><br><span class="line">Cache-control: no-transform</span><br><span class="line">Cache-control: public</span><br><span class="line">Cache-control: private</span><br><span class="line">Cache-control: proxy-revalidate</span><br><span class="line">Cache-Control: max-age=&lt;seconds&gt;</span><br><span class="line">Cache-control: s-maxage=&lt;seconds&gt;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>must-revalidate</td>
<td>可缓存但必须再向源服务器进行确认</td>
</tr>
<tr>
<td>no-cache</td>
<td>缓存前必须确认其有效性</td>
</tr>
<tr>
<td>no-store</td>
<td>不缓存请求或响应的任何内容</td>
</tr>
<tr>
<td>no-transform</td>
<td>代理不可更改媒体类型</td>
</tr>
<tr>
<td>public</td>
<td>可向任意方提供响应的缓存</td>
</tr>
<tr>
<td>private</td>
<td>仅向特定用户返回响应</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>要求中间缓存服务器对缓存的响应有效性再进行确认</td>
</tr>
<tr>
<td>max-age&#x3D;&lt;秒&gt;</td>
<td>响应最大Age值</td>
</tr>
<tr>
<td>s-maxage&#x3D;&lt;秒&gt;</td>
<td>公共缓存服务器响应的最大Age值</td>
</tr>
</tbody></table>
<p>max-age&#x3D;[秒]：</p>
<h3 id="Nginx的跨域问题解决"><a href="#Nginx的跨域问题解决" class="headerlink" title="Nginx的跨域问题解决"></a>Nginx的跨域问题解决</h3><p>这块内容，我们主要从以下方面进行解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">什么情况下会出现跨域问题?</span><br><span class="line">实例演示跨域问题</span><br><span class="line">具体的解决方案是什么?</span><br></pre></td></tr></table></figure>
<h4 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h4><p>浏览器的同源策略：是一种约定，是浏览器最核心也是最基本的安全功能，如果浏览器少了同源策略，则浏览器的正常功能可能都会受到影响。<br>同源: 协议、域名(IP)、端口相同即为同源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.131/user/1</span><br><span class="line">https://192.168.200.131/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.132/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.131:8080/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://www.nginx.com/user/1</span><br><span class="line">http://www.nginx.org/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.131:8080/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://www.nginx.org:80/user/1</span><br><span class="line">http://www.nginx.org/user/1</span><br><span class="line">满足</span><br></pre></td></tr></table></figure>
<h4 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h4><p>简单描述下:<br>有两台服务器分别为A,B,如果从服务器A的页面发送异步请求到服务器B获取数据，如果服务器A和服务器B不满足同源策略，则就会出现跨域问题。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>使用add_header指令，该指令可以用来添加一些头信息</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>add_header name value…</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>此处用来解决跨域问题，需要添加两个头信息，一个是Access-Control-Allow-Origin,Access-Control-Allow-Methods<br>Access-Control-Allow-Origin: 直译过来是允许跨域访问的源地址信息，可以配置多个(多个用逗号分隔)，也可以使用*代表所有源<br>Access-Control-Allow-Methods:直译过来是允许跨域访问的请求方式，值可以为 GET POST PUT DELETE…,可以全部设置，也可以根据需要设置，多个用逗号分隔<br>具体配置方式</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /getUser&#123;</span><br><span class="line">  <span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line">  <span class="attribute">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE;</span><br><span class="line">  <span class="attribute">default_type</span> application/json;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 跨域最好还是后端服务器处理</p>
<h3 id="静态资源防盗链-保证自己的资源不被别人随意使用"><a href="#静态资源防盗链-保证自己的资源不被别人随意使用" class="headerlink" title="静态资源防盗链 保证自己的资源不被别人随意使用"></a>静态资源防盗链 保证自己的资源不被别人随意使用</h3><h4 id="什么是资源盗链"><a href="#什么是资源盗链" class="headerlink" title="什么是资源盗链"></a>什么是资源盗链</h4><p>资源盗链指的是此内容不在自己服务器上，而是通过技术手段，绕过别人的限制将别人的内容放到自己页面上最终展示给用户。以此来盗取大网站的空间和流量。简而言之就是用别人的东西成就自己的网站。<br>效果演示<br>京东:<a target="_blank" rel="noopener" href="https://img14.360buyimg.com/n7/jfs/t1/101062/37/2153/254169/5dcbd410E6d10ba22/4ddbd212be225fcd.jpg">https://img14.360buyimg.com/n7/jfs/t1/101062/37/2153/254169/5dcbd410E6d10ba22/4ddbd212be225fcd.jpg</a><br>百度:<a target="_blank" rel="noopener" href="https://pics7.baidu.com/feed/cf1b9d16fdfaaf516f7e2011a7cda1e8f11f7a1a.jpeg?token=551979a23a0995e5e5279b8fa1a48b34&s=BD385394D2E963072FD48543030030BB">https://pics7.baidu.com/feed/cf1b9d16fdfaaf516f7e2011a7cda1e8f11f7a1a.jpeg?token=551979a23a0995e5e5279b8fa1a48b34&s=BD385394D2E963072FD48543030030BB</a><br>我们自己准备一个页面，在页面上引入这两个图片查看效果<br>从上面的效果，可以看出来，下面的图片地址添加了防止盗链的功能，京东这边我们可以直接使用其图片。</p>
<h4 id="Nginx防盗链的实现原理："><a href="#Nginx防盗链的实现原理：" class="headerlink" title="Nginx防盗链的实现原理："></a>Nginx防盗链的实现原理：</h4><p>了解防盗链的原理之前，我们得先学习一个HTTP的头信息Referer,当浏览器向web服务器发送请求的时候，一般都会带上Referer,来告诉浏览器该网页是从哪个页面链接过来的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685511959849-4b1f2e7f-3d40-4644-952e-a56add414ee1.png#averageHue=%23f1f2ed&clientId=u198a04b2-966b-4&from=paste&height=274&id=ua62b8c71&originHeight=343&originWidth=1222&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=522711&status=done&style=none&taskId=u28af3b95-869c-4c39-a725-8258f8fab34&title=&width=977.6" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685511959849-4b1f2e7f-3d40-4644-952e-a56add414ee1.png#averageHue=%23f1f2ed&clientId=u198a04b2-966b-4&from=paste&height=274&id=ua62b8c71&originHeight=343&originWidth=1222&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=522711&status=done&style=none&taskId=u28af3b95-869c-4c39-a725-8258f8fab34&title=&width=977.6" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>后台服务器可以根据获取到的这个Referer信息来判断是否为自己信任的网站地址，如果是则放行继续访问，如果不是则可以返回403(服务端拒绝访问)的状态信息。<br>在本地模拟上述的服务器效果：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685511979594-e03fa0d6-d178-41d8-a33e-708b35e5289a.png#averageHue=%23fcfbfb&clientId=u198a04b2-966b-4&from=paste&height=243&id=ubbbf7a29&originHeight=304&originWidth=1216&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=70079&status=done&style=none&taskId=u97f44be1-fbd0-4188-b1c5-b17b9035414&title=&width=972.8" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685511979594-e03fa0d6-d178-41d8-a33e-708b35e5289a.png#averageHue=%23fcfbfb&clientId=u198a04b2-966b-4&from=paste&height=243&id=ubbbf7a29&originHeight=304&originWidth=1216&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=70079&status=done&style=none&taskId=u97f44be1-fbd0-4188-b1c5-b17b9035414&title=&width=972.8" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br><strong>Nginx防盗链的具体实现:</strong><br>valid_referers:nginx会通就过查看referer自动和valid_referers后面的内容进行匹配，如果匹配到了就将$invalid_referer变量置0，如果没有匹配到，则将$invalid_referer变量置为1，匹配的过程中不区分大小写。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>valid_referers none&#124;blocked&#124;server_names&#124;string…</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody></table>
<p>none: 如果Header中的Referer为空，允许访问<br>blocked:在Header中的Referer不为空，但是该值被防火墙或代理进行伪装过，如不带”http:&#x2F;&#x2F;“ 、”https:&#x2F;&#x2F;“等协议头的资源允许访问。<br>server_names:指定具体的域名或者IP<br>string: 可以支持正则表达式和*的字符串。如果是正则表达式，需要以~开头表示，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~*\.(png|jpg|gif)&#123;</span><br><span class="line">           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.;</span><br><span class="line">           if ($invalid_referer)&#123;</span><br><span class="line">                return 403;</span><br><span class="line">           &#125;</span><br><span class="line">           root /usr/local/nginx/html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>遇到的问题:图片有很多，该如何批量进行防盗链？</p>
<h4 id="针对目录进行防盗链"><a href="#针对目录进行防盗链" class="headerlink" title="针对目录进行防盗链"></a>针对目录进行防盗链</h4><p>配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.;</span><br><span class="line">           if ($invalid_referer)&#123;</span><br><span class="line">                return 403;</span><br><span class="line">           &#125;</span><br><span class="line">           root /usr/local/nginx/html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们可以对一个目录下的所有资源进行翻到了操作。<br>遇到的问题：Referer的限制比较粗，比如随意加一个Referer，上面的方式是无法进行限制的。那么这个问题改如何解决？<br>此处我们需要用到Nginx的第三方模块ngx_http_accesskey_module，第三方模块如何实现盗链，如果在Nginx中使用第三方模块的功能，这些我们在后面的Nginx的模块篇再进行详细的讲解。</p>
<h3 id="Rewrite功能配置"><a href="#Rewrite功能配置" class="headerlink" title="Rewrite功能配置"></a>Rewrite功能配置</h3><p>Rewrite是Nginx服务器提供的一个重要基本功能，是Web服务器产品中几乎必备的功能。<strong>主要的作用是用来实现URL的重写。 重写url 可以实现重定向</strong><br>注意:Nginx服务器的Rewrite功能的实现依赖于PCRE的支持，因此在编译安装Nginx服务器之前，需要安装PCRE库。Nginx使用的是ngx_http_rewrite_module模块来解析和处理Rewrite功能的相关配置。</p>
<h4 id="“地址重写”与”地址转发”"><a href="#“地址重写”与”地址转发”" class="headerlink" title="“地址重写”与”地址转发”"></a>“地址重写”与”地址转发”</h4><p>重写和转发的区别:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">地址重写浏览器地址会发生变化而地址转发则不变</span><br><span class="line">一次地址重写会产生两次请求而一次地址转发只会产生一次请求</span><br><span class="line">地址重写到的页面必须是一个完整的路径而地址转发则不需要</span><br><span class="line">地址重写因为是两次请求所以request范围内属性不能传递给新页面而地址转发因为是一次请求所以可以传递值</span><br><span class="line">地址转发速度快于地址重写</span><br></pre></td></tr></table></figure>
<h4 id="Rewrite规则"><a href="#Rewrite规则" class="headerlink" title="Rewrite规则"></a>Rewrite规则</h4><h4 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a>set指令</h4><p>该指令用来设置一个新的变量。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>set $variable value;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>variable:变量的名称，该变量名称要用”$”作为变量的第一个字符，且不能与Nginx服务器预设的全局变量同名。<br>value:变量的值，可以是字符串、其他变量或者变量的组合等。</p>
<h4 id="Rewrite常用全局变量"><a href="#Rewrite常用全局变量" class="headerlink" title="Rewrite常用全局变量"></a>Rewrite常用全局变量</h4><table>
<thead>
<tr>
<th><strong>变量</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>$args</td>
<td>变量中存放了请求URL中的请求指令。比如<a target="_blank" rel="noopener" href="http://192.168.200.133:8080/?arg1=value1&args2=value2">http://192.168.200.133:8080?arg1=value1&args2=value2</a></td>
</tr>
<tr>
<td>中的”arg1&#x3D;value1&amp;arg2&#x3D;value2”，功能和$query_string一样</td>
<td></td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>变量存储的是用户访问服务的代理信息(如果通过浏览器访问，记录的是浏览器的相关版本信息)</td>
</tr>
<tr>
<td>$host</td>
<td>变量存储的是访问服务器的server_name值</td>
</tr>
<tr>
<td>$document_uri</td>
<td>变量存储的是当前访问地址的URI。比如<a target="_blank" rel="noopener" href="http://192.168.200.133/server?id=10&name=zhangsan">http://192.168.200.133/server?id=10&name=zhangsan</a></td>
</tr>
<tr>
<td>中的”&#x2F;server”，功能和$uri一样</td>
<td></td>
</tr>
<tr>
<td>$document_root</td>
<td>变量存储的是当前请求对应location的root值，如果未设置，默认指向Nginx自带html目录所在位置</td>
</tr>
<tr>
<td>$content_length</td>
<td>变量存储的是请求头中的Content-Length的值</td>
</tr>
<tr>
<td>$content_type</td>
<td>变量存储的是请求头中的Content-Type的值</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>变量存储的是客户端的cookie信息，可以通过add_header Set-Cookie ‘cookieName&#x3D;cookieValue’来添加cookie数据</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>变量中存储的是Nginx服务器对网络连接速率的限制，也就是Nginx配置中对limit_rate指令设置的值，默认是0，不限制。</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>变量中存储的是客户端的IP地址</td>
</tr>
<tr>
<td>$remote_port</td>
<td>变量中存储了客户端与服务端建立连接的端口号</td>
</tr>
<tr>
<td>$remote_user</td>
<td>变量中存储了客户端的用户名，需要有认证模块才能获取</td>
</tr>
<tr>
<td>$scheme</td>
<td>变量中存储了访问协议</td>
</tr>
<tr>
<td>$server_addr</td>
<td>变量中存储了服务端的地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>变量中存储了客户端请求到达的服务器的名称</td>
</tr>
<tr>
<td>$server_port</td>
<td>变量中存储了客户端请求到达服务器的端口号</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>变量中存储了客户端请求协议的版本，比如”HTTP&#x2F;1.1”</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>变量中存储了发给后端服务器的本地文件资源的名称</td>
</tr>
<tr>
<td>$request_method</td>
<td>变量中存储了客户端的请求方式，比如”GET”,”POST”等</td>
</tr>
<tr>
<td>$request_filename</td>
<td>变量中存储了当前请求的资源文件的路径名</td>
</tr>
<tr>
<td>$request_uri</td>
<td>变量中存储了当前请求的URI，并且携带请求参数，比如<a target="_blank" rel="noopener" href="http://192.168.200.133/server?id=10&name=zhangsan">http://192.168.200.133/server?id=10&name=zhangsan</a></td>
</tr>
<tr>
<td>中的”&#x2F;server?id&#x3D;10&amp;name&#x3D;zhangsan”</td>
<td></td>
</tr>
</tbody></table>
<h4 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h4><p>该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>if (condition){…}</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody></table>
<p>condition为判定条件，可以支持以下写法：</p>
<ol>
<li><p>变量名。如果变量名对应的值为空或者是0，if都判断为false,其他条件为true。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($param)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>使用”&#x3D;”和”!&#x3D;”比较变量和字符串是否相等，满足条件为true，不满足为false</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($request_method = POST)&#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：此处和Java不太一样的地方是字符串不需要添加引号。</p>
</li>
<li><p>使用正则表达式对变量进行匹配，匹配成功返回true，否则返回false。变量与正则表达式之间使用”<del>“,”</del><em>“,”!<del>“,”!</del></em>“来连接。”<del>“代表匹配正则表达式过程中区分大小写，”</del><em>“代表匹配正则表达式过程中不区分大小写”!<del>“和”!</del></em>“刚好和上面取相反值，如果匹配上返回false,匹配不上返回true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE)&#123;</span><br><span class="line">    #$http_user_agent的值中是否包含MSIE字符串，如果包含返回true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含”}”或者是”;”等字符时，就需要把引号加上。</p>
</li>
<li><p>判断请求的文件是否存在使用”-f”和”!-f”,当使用”-f”时，如果请求的文件存在返回true，不存在返回false。当使用”!f”时，如果请求文件不存在，但该文件所在目录存在返回true,文件和目录都不存在返回false,如果文件存在返回false</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (-f $request_filename)&#123;</span><br><span class="line">    #判断请求的文件是否存在</span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">    #判断请求的文件是否不存在</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断请求的目录是否存在使用”-d”和”!-d”,当使用”-d”时，如果请求的目录存在，if返回true，如果目录不存在则返回false当使用”!-d”时，如果请求的目录不存在但该目录的上级目录存在则返回true，该目录和它上级目录都不存在则返回false,如果请求目录存在也返回false.</p>
</li>
<li><p>判断请求的目录或者文件是否存在使用”-e”和”!-e”当使用”-e”,如果请求的目录或者文件存在时，if返回true,否则返回false.当使用”!-e”,如果请求的文件和文件所在路径上的目录都不存在返回true,否则返回false</p>
</li>
<li><p>判断请求的文件是否可执行使用”-x”和”!-x”当使用”-x”,如果请求的文件可执行，if返回true,否则返回false当使用”!-x”,如果请求文件不可执行，返回true,否则返回false</p>
</li>
</ol>
<h4 id="break指令"><a href="#break指令" class="headerlink" title="break指令"></a>break指令</h4><p>该指令用于中断当前相同作用域中的其他Nginx配置。与该指令处于同一作用域的Nginx配置中，位于它前面的指令配置生效，位于后面的指令配置无效。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>break;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>例子:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /&#123;</span><br><span class="line">    if ($param)&#123;</span><br><span class="line">        set $id $1;</span><br><span class="line">        break;</span><br><span class="line">        limit_rate 10k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="return指令"><a href="#return指令" class="headerlink" title="return指令"></a>return指令</h4><p>该指令用于完成对请求的处理，直接向客户端返回响应状态代码。在return后的所有Nginx配置都是无效的。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>return code [text];return code URL;return URL;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>code:为返回给客户端的HTTP状态代理。可以返回的状态代码为0~999的任意HTTP状态代理<br>text:为返回给客户端的响应体内容，支持变量的使用<br>URL:为返回给客户端的URL地址</p>
<h4 id="rewrite指令"><a href="#rewrite指令" class="headerlink" title="rewrite指令"></a>rewrite指令</h4><p>该指令通过正则表达式的使用来改变URI。可以同时存在一个或者多个指令，按照顺序依次对URL进行匹配和处理。<br>URL和URI的区别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URI:统一资源标识符</span><br><span class="line">URL:统一资源定位符</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>rewrite regex replacement [flag];</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>regex:用来匹配URI的正则表达式<br>replacement:匹配成功后，用于替换URI中被截取内容的字符串。如果该字符串是以”http:&#x2F;&#x2F;“或者”https:&#x2F;&#x2F;“开头的，则不会继续向下对URI进行其他处理，而是直接返回重写后的URI给客户端。<br>flag:用来设置rewrite对URI的处理行为，可选值有如下：</p>
<ul>
<li>last:</li>
<li>break</li>
<li>redirect</li>
<li>permanent</li>
</ul>
<h4 id="rewrite-log指令"><a href="#rewrite-log指令" class="headerlink" title="rewrite_log指令"></a>rewrite_log指令</h4><p>该指令配置是否开启URL重写日志的输出功能。</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>rewrite_log on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>rewrite_log off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location、if</td>
</tr>
</tbody></table>
<p>开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</p>
<h3 id="Rewrite的案例"><a href="#Rewrite的案例" class="headerlink" title="Rewrite的案例"></a>Rewrite的案例</h3><h4 id="域名跳转"><a href="#域名跳转" class="headerlink" title="域名跳转"></a>域名跳转</h4><blockquote>
<p>问题分析</p>
</blockquote>
<p>先来看一个效果，如果我们想访问京东网站，大家都知道我们可以输入<a href="http://www.jd.com,但是同样的我们也可以输入www.360buy.com同样也都能访问到京东网站。这个其实是因为京东刚开始的时候域名就是[www.360buy.com](https://www.360buy.com)，后面由于各种原因把自己的域名换成了[www.jd.com](https://www.jd.com)">www.jd.com,但是同样的我们也可以输入www.360buy.com同样也都能访问到京东网站。这个其实是因为京东刚开始的时候域名就是[www.360buy.com](https://www.360buy.com)，后面由于各种原因把自己的域名换成了[www.jd.com](https://www.jd.com)</a>, 虽然说域名变量，但是对于以前只记住了<a target="_blank" rel="noopener" href="https://www.360buy.com/">www.360buy.com</a>的用户来说，<strong>我们如何把这部分用户也迁移到我们新域名的访问上来，针对于这个问题，我们就可以使用Nginx中Rewrite的域名跳转来解决。</strong></p>
<blockquote>
<p>环境准备</p>
</blockquote>
<ul>
<li>准备两个域名 <a target="_blank" rel="noopener" href="https://www.360buy.com/">www.360buy.com</a> | <a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a></li>
</ul>
<p>vim &#x2F;etc&#x2F;hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.133 www.360buy.com</span><br><span class="line">192.168.200.133 www.jd.com</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;hm目录下创建一个访问页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;欢迎来到我们的网站&lt;/h1&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过Nginx实现当访问www.访问到系统的首页</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.hm.com;</span><br><span class="line">    location /&#123;</span><br><span class="line">        root /usr/local/nginx/html/hm;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>》通过Rewrite完成将<a target="_blank" rel="noopener" href="https://www.360buy.com/">www.360buy.com</a>的请求跳转到<a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.360buy.com;</span><br><span class="line">    rewrite ^/ http://www.jd.com permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题描述:如何在域名跳转的过程中携带请求的URI？<br>修改配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.itheima.com;</span><br><span class="line">    rewrite ^(.*) http://www.hm.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题描述:我们除了上述说的<a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a> 、<a target="_blank" rel="noopener" href="https://www.360buy.com/">www.360buy.com</a>其实还有我们也可以通过<a target="_blank" rel="noopener" href="https://www.jingdong.com/">www.jingdong.com</a>来访问，那么如何通过Rewrite来实现多个域名的跳转?<br>添加域名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.200.133 www.jingdong.com</span><br></pre></td></tr></table></figure>
<p>修改配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.360buy.com www.jingdong.com;</span><br><span class="line">    rewrite ^(.*) http://www.jd.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="域名镜像"><a href="#域名镜像" class="headerlink" title="域名镜像"></a>域名镜像</h4><p>上述案例中，将<a target="_blank" rel="noopener" href="https://www.360buy.com/">www.360buy.com</a> 和 <a target="_blank" rel="noopener" href="https://www.jingdong.com/">www.jingdong.com</a>都能跳转到<a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a>，那么<a target="_blank" rel="noopener" href="https://www.jd.com/">www.jd.com</a>我们就可以把它起名叫主域名，其他两个就是我们所说的镜像域名，当然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在location块中配置rewrite功能，这样在好处是 一个域名挂了 剩下的还可以顶替他 高可用性 比如: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.myweb.com;</span><br><span class="line">    location ^~ /source1&#123;</span><br><span class="line">        rewrite ^/resource1(.*) http://rewrite.myweb.com/web$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">    location ^~ /source2&#123;</span><br><span class="line">        rewrite ^/resource2(.*) http://rewrite.myweb.com/web$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="独立域名"><a href="#独立域名" class="headerlink" title="独立域名"></a>独立域名</h4><p>一个完整的项目包含多个模块，比如购物网站有商品商品搜索模块、商品详情模块已经购物车模块等，那么我们如何为每一个模块设置独立的域名。<br>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://search.hm.com  访问商品搜索模块</span><br><span class="line">http://item.hm.com    访问商品详情模块</span><br><span class="line">http://cart.hm.com    访问商品购物车模块</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name search.hm.com;</span><br><span class="line">    rewrite ^(.*) http://www.hm.com/bbs$1 last;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    server_name item.hm.com;</span><br><span class="line">    rewrite ^(.*) http://www.hm.com/item$1 last;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen 82;</span><br><span class="line">    server_name cart.hm.com;</span><br><span class="line">    rewrite ^(.*) http://www.hm.com/cart$1 last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="目录自动添加”-“"><a href="#目录自动添加”-“" class="headerlink" title="目录自动添加”&#x2F;“"></a>目录自动添加”&#x2F;“</h4><p>问题描述<br>通过一个例子来演示下问题:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要想访问上述资源，很简单，只需要通过<a target="_blank" rel="noopener" href="http://192.168.200.133/">http://192.168.200.133</a>直接就能访问，地址后面不需要加&#x2F;,但是如果将上述的配置修改为如下内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location /hm &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候，要想访问上述资源，按照上述的访问方式，我们可以通过<a target="_blank" rel="noopener" href="http://192.168.200.133/hm/">http://192.168.200.133/hm/</a>来访问,但是如果地址后面不加斜杠，页面就会出问题。如果不加斜杠，Nginx服务器内部会自动做一个301的重定向，重定向的地址会有一个指令叫server_name_in_redirect on|off;来决定重定向的地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果该指令为on</span><br><span class="line">    重定向的地址为:  http://server_name/目录名/;</span><br><span class="line">如果该指令为off</span><br><span class="line">    重定向的地址为:  http://原URL中的域名/目录名/;</span><br></pre></td></tr></table></figure>
<p>所以就拿刚才的地址来说，<a target="_blank" rel="noopener" href="http://192.168.200.133/hm">http://192.168.200.133/hm</a>如果不加斜杠，那么按照上述规则，如果指令server_name_in_redirect为on，则301重定向地址变为 <a target="_blank" rel="noopener" href="http://localhost/hm/">http://localhost/hm/</a>,如果为off，则301重定向地址变为<a target="_blank" rel="noopener" href="http://192.168.200.133/ht/">http://192.168.200.133/ht/</a>。后面这个是正常的，前面地址就有问题。<br>注意server_name_in_redirect指令在Nginx的0.8.48版本之前默认都是on，之后改成了off,所以现在我们这个版本不需要考虑这个问题，但是如果是0.8.48以前的版本并且server_name_in_redirect设置为on，我们如何通过rewrite来解决这个问题？<br>解决方案<br>我们可以使用rewrite功能为末尾没有斜杠的URL自动添加一个斜杠</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    server_name_in_redirect on;</span><br><span class="line">    location /hm &#123;</span><br><span class="line">        if (-d $request_filename)&#123;</span><br><span class="line">            rewrite ^/(.*)([^/])$ http://$host/$1$2/ permanent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="合并目录"><a href="#合并目录" class="headerlink" title="合并目录"></a>合并目录</h4><p>搜索引擎优化(SEO)是一种利用搜索引擎的搜索规则来提供目的网站的有关搜索引擎内排名的方式。我们在创建自己的站点时，可以通过很多中方式来有效的提供搜索引擎优化的程度。其中有一项就包含URL的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来，这两个问题是相互矛盾的，那么使用rewrite如何解决上述问题?<br>举例，网站中有一个资源文件的访问路径时 &#x2F;server&#x2F;11&#x2F;22&#x2F;33&#x2F;44&#x2F;20.html,也就是说20.html存在于第5级目录下，如果想要访问该资源文件，客户端的URL地址就要写成 <a target="_blank" rel="noopener" href="http://www.web.name/server/11/22/33/44/20.html">http://www.web.name/server/11/22/33/44/20.html</a>,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.web.name;</span><br><span class="line">    location /server&#123;</span><br><span class="line">        root html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这个是非常不利于SEO搜索引擎优化的，同时客户端也不好记.使用rewrite我们可以进行如下配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.web.name;</span><br><span class="line">    location /server&#123;</span><br><span class="line">        rewrite ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)\.html$ /server/$1/$2/$3/$4/$5.html last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的花，客户端只需要输入<a target="_blank" rel="noopener" href="http://www.web.name/server-11-22-33-44-20.html">http://www.web.name/server-11-22-33-44-20.html</a>就可以访问到20.html页面了。这里也充分利用了rewrite指令支持正则表达式的特性。</p>
<h4 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h4><p>防盗链之前我们已经介绍过了相关的知识，在rewrite中的防盗链和之前将的原理其实都是一样的，只不过通过rewrite可以将防盗链的功能进行完善下，当出现防盗链的情况，我们可以使用rewrite将请求转发到自定义的一张图片和页面，给用户比较好的提示信息。下面我们就通过根据文件类型实现防盗链的一个配置实例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.web.com;</span><br><span class="line">    locatin ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip)$&#123;</span><br><span class="line">        valid_referers none blocked server_names *.web.com;</span><br><span class="line">        if ($invalid_referer)&#123;</span><br><span class="line">            rewrite ^/ http://www.web.com/images/forbidden.png;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据目录实现防盗链配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.web.com;</span><br><span class="line">    location /file/&#123;</span><br><span class="line">        root /server/file/;</span><br><span class="line">        valid_referers none blocked server_names *.web.com;</span><br><span class="line">        if ($invalid_referer)&#123;</span><br><span class="line">            rewrite ^/ http://www.web.com/images/forbidden.png;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx反向代理"><a href="#Nginx反向代理" class="headerlink" title="Nginx反向代理"></a>Nginx反向代理</h2><h3 id="Nginx反向代理概述"><a href="#Nginx反向代理概述" class="headerlink" title="Nginx反向代理概述"></a>Nginx反向代理概述</h3><p>关于正向代理和反向代理，我们在前面的章节已经通过一张图给大家详细的介绍过了，简而言之就是<strong>正向代理代理的对象是客户端</strong>，<strong>反向代理代理的是服务端</strong>，这是两者之间最大的区别。<br>Nginx即可以实现正向代理，也可以实现反向代理。<br>我们先来通？过一个小案例演示下Nginx正向代理的简单应用。<br>先提需求：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685517939845-b895df6d-2395-428d-9703-e7615b58e38b.png#averageHue=%23f8f7f6&clientId=ucb142d16-5477-4&from=ui&id=uc5bafcb8&originHeight=402&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=151668&status=done&style=none&taskId=u7ab0058e-0ec7-44a0-8cc1-6b72102de10&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685517939845-b895df6d-2395-428d-9703-e7615b58e38b.png#averageHue=%23f8f7f6&clientId=ucb142d16-5477-4&from=ui&id=uc5bafcb8&originHeight=402&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=151668&status=done&style=none&taskId=u7ab0058e-0ec7-44a0-8cc1-6b72102de10&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1581846370052.png"><br>(1)服务端的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  log_format main &#x27;client send request=&gt;clientIp=$remote_addr serverIp=&gt;$host&#x27;;</span><br><span class="line">	server&#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name	localhost;</span><br><span class="line">		access_log logs/access.log main;</span><br><span class="line">		location &#123;</span><br><span class="line">			root html;</span><br><span class="line">			index index.html index.htm;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2)使用客户端访问服务端，打开日志查看结果</p>
<p>(3)代理服务器设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen  82;</span><br><span class="line">        resolver 8.8.8.8;</span><br><span class="line">        location /&#123;</span><br><span class="line">                proxy_pass http://$host$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(4)查看代理服务器的IP(192.168.200.146)和Nginx配置监听的端口(82)<br>(5)在客户端配置代理服务器<br>(6)设置完成后，再次通过浏览器访问服务端</p>
<p>通过对比，上下两次的日志记录，会发现虽然我们是客户端访问服务端，但是如何使用了代理，那么服务端能看到的只是代理发送过去的请求，这样的化，就使用Nginx实现了正向代理的设置。<br><strong>但是Nginx正向代理，在实际的应用中不是特别多</strong>，所以我们简单了解下，接下来我们继续学习Nginx的反向代理，这是Nginx比较重要的一个功能。</p>
<h3 id="Nginx反向代理的配置语法"><a href="#Nginx反向代理的配置语法" class="headerlink" title="Nginx反向代理的配置语法 ***"></a>Nginx反向代理的配置语法 ***</h3><p>首先我们需要明确  当有多个服务器 nginx代理这些服务器 请求发给nginx 他在平摊给不同的服务器 这涉及到了负载均衡 反向代理经常和负载均衡联用</p>
<p>Nginx反向代理模块的指令是由<code>ngx_http_proxy_module</code>模块进行解析，该模块在安装Nginx的时候已经自己加装到Nginx中了，接下来我们把反向代理中的常用指令一一介绍下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass</span><br><span class="line">proxy_set_header</span><br><span class="line">proxy_redirect</span><br></pre></td></tr></table></figure>
<h4 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h4><p>该指令用来设置被代理服务器地址，可以是主机名称、IP地址加端口号形式。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_pass URL;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>location</td>
</tr>
</tbody></table>
<p>URL:为要设置的被代理服务器地址，包含传输协议(<code>http</code>,<code>https://</code>)、主机名称或IP地址加端口号、URI等要素。<br>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass http://www.baidu.com;</span><br><span class="line">location /server&#123;&#125;</span><br><span class="line">proxy_pass http://192.168.200.146;</span><br><span class="line">    http://192.168.200.146/server/index.html</span><br><span class="line">proxy_pass http://192.168.200.146/;</span><br><span class="line">    http://192.168.200.146/index.html</span><br></pre></td></tr></table></figure>
<p>大家在编写proxy_pass的时候，后面的值要不要加”&#x2F;“?<br>接下来通过例子来说明刚才我们提到的问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		#proxy_pass http://192.168.200.146;</span><br><span class="line">		proxy_pass http://192.168.200.146/;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">当客户端访问 http://localhost/index.html,效果是一样的</span><br><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /server&#123;</span><br><span class="line">		#proxy_pass http://192.168.200.146;</span><br><span class="line">		proxy_pass http://192.168.200.146/;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">当客户端访问 http://localhost/server/index.html</span><br><span class="line">这个时候，第一个proxy_pass就变成了http://localhost/server/index.html</span><br><span class="line">第二个proxy_pass就变成了http://localhost/index.html效果就不一样了。</span><br></pre></td></tr></table></figure>
<h4 id="proxy-set-header"><a href="#proxy-set-header" class="headerlink" title="proxy_set_header"></a>proxy_set_header</h4><p>**该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器 **<br><strong>说白了 可以对原本的请求头信息 进行操作</strong></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_set_header field value;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_set_header Host $proxy_host;</td>
</tr>
<tr>
<td>proxy_set_header Connection close;</td>
<td></td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>需要注意的是，如果想要看到结果，必须在被代理的服务器上来获取添加的头信息。<br>被代理服务器： [192.168.200.146]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen  8080;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        return 200 $http_username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理服务器: [192.168.200.133]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen  8080;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location /server &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:8080/;</span><br><span class="line">                proxy_set_header username TOM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>访问测试</p>
<h4 id="proxy-redirect"><a href="#proxy-redirect" class="headerlink" title="proxy_redirect"></a>proxy_redirect</h4><p><strong>该指令是用来重置头信息中的”Location”和”Refresh”的值。</strong></p>
<p>| 语法 | proxy_redirect redirect replacement;<br>proxy_redirect default;</p>
<p>proxy_redirect off; |<br>| — | — |<br>| 默认值 | proxy_redirect default; |<br>| 位置 | http、server、location |</p>
<blockquote>
<p>为什么要用该指令?</p>
</blockquote>
<p>服务端[192.168.200.146]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  8081;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    if (!-f $request_filename)&#123;</span><br><span class="line">    	return 302 http://192.168.200.146;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理服务端[192.168.200.133]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen  8081;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://192.168.200.146:8081/;</span><br><span class="line">		proxy_redirect http://192.168.200.146 http://192.168.200.133;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该指令的几组选项</p>
</blockquote>
<p>proxy_redirect redirect replacement;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redirect:目标,Location的值</span><br><span class="line">replacement:要替换的值</span><br></pre></td></tr></table></figure>

<p>proxy_redirect default;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">default;</span><br><span class="line">将location块的uri变量作为replacement,</span><br><span class="line">将proxy_pass变量作为redirect进行替换</span><br></pre></td></tr></table></figure>

<p>proxy_redirect off;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">关闭proxy_redirect的功能</span><br></pre></td></tr></table></figure>
<h3 id="Nginx反向代理实战"><a href="#Nginx反向代理实战" class="headerlink" title="Nginx反向代理实战***"></a>Nginx反向代理实战***</h3><p>代理服务器端</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685519955351-87eb798e-c719-49b5-991a-ac908ab86042.png#averageHue=%23f5f5f5&clientId=ucb142d16-5477-4&from=ui&id=ufe58e865&originHeight=330&originWidth=612&originalType=binary&ratio=1&rotation=0&showTitle=false&size=166951&status=done&style=none&taskId=ud03157a3-6ea7-4ca9-b64c-18896475dff&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685519955351-87eb798e-c719-49b5-991a-ac908ab86042.png#averageHue=%23f5f5f5&clientId=ucb142d16-5477-4&from=ui&id=ufe58e865&originHeight=330&originWidth=612&originalType=binary&ratio=1&rotation=0&showTitle=false&size=166951&status=done&style=none&taskId=ud03157a3-6ea7-4ca9-b64c-18896475dff&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1581883378672.png"><br>服务器1,2,3存在两种情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第一种情况: 三台服务器的内容不一样。</span><br><span class="line">第二种情况: 三台服务器的内容是一样。</span><br></pre></td></tr></table></figure>

<ol>
<li><p>如果服务器1、服务器2和服务器3的内容不一样，那我们可以<strong>根据用户请求来分发到不同的服务器。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">代理服务器</span><br><span class="line">server &#123;</span><br><span class="line">        listen          8082;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        location /server1 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9001/;</span><br><span class="line">        &#125;</span><br><span class="line">        location /server2 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9002/;</span><br><span class="line">        &#125;</span><br><span class="line">        location /server3 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9003/;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务端</span><br><span class="line">server1</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9001;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br><span class="line">server2</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9002;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br><span class="line">server3</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9003;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果服务器1、服务器2和服务器3的内容是一样的，该如何处理?</p>
</li>
</ol>
<p><strong>这就需要用到负载均衡了 服务器分摊这些请求</strong></p>
<h3 id="Nginx的安全控制"><a href="#Nginx的安全控制" class="headerlink" title="Nginx的安全控制"></a>Nginx的安全控制</h3><p>关于web服务器的安全是比较大的一个话题，里面所涉及的内容很多，Nginx反向代理是如何来提升web服务器的安全呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安全隔离</span><br></pre></td></tr></table></figure>
<p>什么是安全隔离?<br>通过代理分开了客户端到应用程序服务器端的连接，实现了安全措施。<strong>在反向代理之前设置防火墙，仅留一个入口供代理服务器访问。</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685520662842-17890bef-ba68-4f03-8aaa-41953a77cd93.png#averageHue=%23fbfbfb&clientId=ucb142d16-5477-4&from=ui&id=u969d84ad&originHeight=491&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17938&status=done&style=none&taskId=u8abd91d4-1ff7-4e71-ab6f-92d5d6fcf60&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685520662842-17890bef-ba68-4f03-8aaa-41953a77cd93.png#averageHue=%23fbfbfb&clientId=ucb142d16-5477-4&from=ui&id=u969d84ad&originHeight=491&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17938&status=done&style=none&taskId=u8abd91d4-1ff7-4e71-ab6f-92d5d6fcf60&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1589908851340.png"><br>一模一样 就是在所有服务器的访问前 让请求先去nginx在到具体的服务器</p>
<h4 id="如何使用SSL对流量进行加密-https"><a href="#如何使用SSL对流量进行加密-https" class="headerlink" title="如何使用SSL对流量进行加密 https"></a>如何使用SSL对流量进行加密 https</h4><p>翻译成大家能熟悉的说法就是将我们常用的http请求转变成https请求，那么这两个之间的区别简单的来说两个都是HTTP协议，<strong>只不过https是身披SSL外壳的http</strong>.<br><strong>HTTPS是一种通过计算机网络进行安全通信的传输协议。它经由HTTP进行通信，利用SSL&#x2F;TLS建立全通信，加密数据包，确保数据的安全性。</strong><br><strong>SSL(Secure Sockets Layer)安全套接层</strong><br>TLS(Transport Layer Security)传输层安全<br>上述这两个是为网络通信提供安全及数据完整性的一种安全协议，TLS和SSL在传输层和应用层对网络连接进行加密。<br>总结来说为什么要使用https:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http协议是明文传输数据，存在安全问题，而https是加密传输，相当于http+ssl，并且可以防止流量劫持。</span><br></pre></td></tr></table></figure>
<p>Nginx要想使用SSL，需要满足一个条件即需要添加一个模块<code>--with-http_ssl_module</code>,而该模块在编译的过程中又需要OpenSSL的支持，这个我们之前已经准备好了。</p>
<h5 id="流量劫持（DNS劫持）"><a href="#流量劫持（DNS劫持）" class="headerlink" title="流量劫持（DNS劫持）"></a>流量劫持（DNS劫持）</h5><h5 id="请求发送了-被中途截取了-把这个请求发送给他指定的web服务器-然后返回这个web服务器的结果-这样安全隐患很大"><a href="#请求发送了-被中途截取了-把这个请求发送给他指定的web服务器-然后返回这个web服务器的结果-这样安全隐患很大" class="headerlink" title="请求发送了 被中途截取了 把这个请求发送给他指定的web服务器 然后返回这个web服务器的结果 这样安全隐患很大"></a>请求发送了 被中途截取了 把这个请求发送给他指定的web服务器 然后返回这个web服务器的结果 这样安全隐患很大</h5><h5 id="nginx添加SSL的支持"><a href="#nginx添加SSL的支持" class="headerlink" title="nginx添加SSL的支持"></a>nginx添加SSL的支持</h5><p>（1）完成 <code>--with-http_ssl_module</code>模块的增量添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">》将原有/usr/local/nginx/sbin/nginx进行备份</span><br><span class="line">》拷贝nginx之前的配置信息</span><br><span class="line">》在nginx的安装源码进行配置指定对应模块  ./configure --with-http_ssl_module</span><br><span class="line">》通过make模板进行编译</span><br><span class="line">》将objs下面的nginx移动到/usr/local/nginx/sbin下</span><br><span class="line">》在源码目录下执行  make upgrade进行升级，这个可以实现不停机添加新模块的功能</span><br></pre></td></tr></table></figure>
<h5 id="Nginx的SSL相关指令"><a href="#Nginx的SSL相关指令" class="headerlink" title="Nginx的SSL相关指令"></a>Nginx的SSL相关指令</h5><p>因为刚才我们介绍过该模块的指令都是通过ngx_http_ssl_module模块来解析的。</p>
<blockquote>
<p>ssl:该指令用来在指定的服务器开启HTTPS,可以使用 listen 443 ssl,后面这种方式更通用些。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl on &#124; off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> server&#123;</span><br><span class="line">	listen 443 ssl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ssl_certificate:为当前这个虚拟主机指定一个带有PEM格式证书的证书。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_certificate file;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<blockquote>
<p>ssl_certificate_key:该指令用来指定PEM secret key文件的路径</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_ceritificate_key file;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<blockquote>
<p>ssl_session_cache:该指令用来配置用于SSL会话的缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_sesion_cache off&#124;none&#124;[builtin[:size]] [shared:name:size]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_cache none;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>off:禁用会话缓存，客户端不得重复使用会话<br>none:禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数<br>builtin:内置OpenSSL缓存，仅在一个工作进程中使用。<br>shared:所有工作进程之间共享缓存，缓存的相关信息用name和size来指定</p>
<blockquote>
<p>ssl_session_timeout：开启SSL会话功能后，设置客户端能够反复使用储存在缓存中的会话参数时间。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_session_timeout time;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_timeout 5m;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<blockquote>
<p>ssl_ciphers:指出允许的密码，密码指定为OpenSSL支持的格式</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_ciphers ciphers;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_ciphers HIGH:!aNULL:!MD5;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>可以使用<code>openssl ciphers</code>查看openssl支持的格式。</p>
<blockquote>
<p>ssl_prefer_server_ciphers：该指令指定是否服务器密码优先客户端密码</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_perfer_server_ciphers on&#124;off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_perfer_server_ciphers off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h5 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h5><p><strong>方式一：使用阿里云&#x2F;腾讯云等第三方服务进行购买。 当然是使用这种</strong><br>方式二:使用openssl生成证书<br>先要确认当前系统是否有安装openssl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure>
<p>安装下面的命令进行生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/cert</span><br><span class="line">cd /root/cert</span><br><span class="line">openssl genrsa -des3 -out server.key 1024</span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line">cp server.key server.key.org</span><br><span class="line">openssl rsa -in server.key.org -out server.key</span><br><span class="line">openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</span><br></pre></td></tr></table></figure>
<h5 id="开启SSL实例"><a href="#开启SSL实例" class="headerlink" title="开启SSL实例"></a>开启SSL实例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate      server.cert;</span><br><span class="line">    ssl_certificate_key  server.key;</span><br><span class="line"></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）验证</p>
<h3 id="反向代理系统调优"><a href="#反向代理系统调优" class="headerlink" title="反向代理系统调优"></a>反向代理系统调优</h3><p>反向代理值Buffer和Cache<br>Buffer翻译过来是”缓冲”，Cache翻译过来是”缓存”。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685522263103-46b330a2-d593-4dc5-8a3a-34e0b128b4bc.png#averageHue=%23f6f1e8&clientId=ucb142d16-5477-4&from=ui&id=u8256ca94&originHeight=161&originWidth=960&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74461&status=done&style=none&taskId=uec90074b-f4fa-4683-9f2c-a6a3a4a0da4&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685522263103-46b330a2-d593-4dc5-8a3a-34e0b128b4bc.png#averageHue=%23f6f1e8&clientId=ucb142d16-5477-4&from=ui&id=u8256ca94&originHeight=161&originWidth=960&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74461&status=done&style=none&taskId=uec90074b-f4fa-4683-9f2c-a6a3a4a0da4&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1581879638569.png"></p>
<p>总结下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">相同点:</span><br><span class="line">两种方式都是用来提供IO吞吐效率，都是用来提升Nginx代理的性能。</span><br><span class="line">不同点:</span><br><span class="line">缓冲主要用来解决不同设备之间数据传递速度不一致导致的性能低的问题，缓冲中的数据一旦此次操作完成后，就可以删除。</span><br><span class="line">缓存主要是备份，将被代理服务器的数据缓存一份到代理服务器，这样的话，客户端再次获取相同数据的时候，就只需要从代理服务器上获取，效率较高，缓存中的数据可以重复使用，只有满足特定条件才会删除.</span><br></pre></td></tr></table></figure>
<p>（1）Proxy Buffer相关指令</p>
<blockquote>
<p>proxy_buffering :该指令用来开启或者关闭代理服务器的缓冲区；</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffering on&#124;off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffering on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>proxy_buffers:该指令用来指定单个连接从代理服务器读取响应的缓存区的个数和大小。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffers number size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffers 8 4k &#124; 8K;(与系统平台有关)</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>number:缓冲区的个数<br>size:每个缓冲区的大小，缓冲区的总大小就是number*size</p>
<blockquote>
<p>proxy_buffer_size:该指令用来设置从被代理服务器获取的第一部分响应数据的大小。保持与proxy_buffers中的size一致即可，当然也可以更小。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffer_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffer_size 4k &#124; 8k;(与系统平台有关)</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>proxy_busy_buffers_size：该指令用来限制同时处于BUSY状态的缓冲总大小。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_busy_buffers_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_busy_buffers_size 8k&#124;16K;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>proxy_temp_path:当缓冲区存满后，仍未被Nginx服务器完全接受，响应数据就会被临时存放在磁盘文件上，该指令设置文件路径</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_path  path;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_path proxy_temp;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>注意path最多设置三层。</p>
<blockquote>
<p>proxy_temp_file_write_size：该指令用来设置磁盘上缓冲文件的大小。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_file_write_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_file_write_size 8K&#124;16K;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>通用网站的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 4 32k;</span><br><span class="line">proxy_busy_buffers_size 64k;</span><br><span class="line">proxy_temp_file_write_size 64k;</span><br></pre></td></tr></table></figure>
<p>根据项目的具体内容进行相应的调节。</p>
<h1 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h1><h2 id="负载均衡概述"><a href="#负载均衡概述" class="headerlink" title="负载均衡概述"></a>负载均衡概述</h2><p>早期的网站流量和业务功能都比较简单，单台服务器足以满足基本的需求，但是随着互联网的发展，业务流量越来越大并且业务逻辑也跟着越来越复杂，单台服务器的性能及单点故障问题就凸显出来了，因此需要多台服务器进行性能的水平扩展及避免单点故障出现。那么如何将不同用户的请求流量分发到不同的服务器上呢？</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685522504730-067ec35f-adeb-4e2c-ab81-d30b335d58ac.png#averageHue=%23f8f8f8&clientId=ucb142d16-5477-4&from=ui&id=u4b78d179&originHeight=453&originWidth=1803&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31314&status=done&style=none&taskId=ufff7074f-ba49-4cda-8634-08debd76704&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685522504730-067ec35f-adeb-4e2c-ab81-d30b335d58ac.png#averageHue=%23f8f8f8&clientId=ucb142d16-5477-4&from=ui&id=u4b78d179&originHeight=453&originWidth=1803&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31314&status=done&style=none&taskId=ufff7074f-ba49-4cda-8634-08debd76704&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591631182469.png"></p>
<h2 id="负载均衡的原理及处理流程"><a href="#负载均衡的原理及处理流程" class="headerlink" title="负载均衡的原理及处理流程"></a>负载均衡的原理及处理流程</h2><p>系统的扩展可以分为纵向扩展和横向扩展。<br>纵向扩展是从单机的角度出发，通过增加系统的硬件处理能力来提升服务器的处理能力<br><strong>横向扩展是通过添加机器来满足大型网站服务的处理能力。 一般来说都是横向扩展</strong><br><strong>以下是 横向扩展</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685523246884-5750209d-8e6e-4c3c-8b71-d6f0b56d1038.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=u94f074c0&originHeight=533&originWidth=936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14444&status=done&style=none&taskId=ua7c449cd-7b89-4ba0-aee0-d27a5f7da7d&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685523246884-5750209d-8e6e-4c3c-8b71-d6f0b56d1038.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=u94f074c0&originHeight=533&originWidth=936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14444&status=done&style=none&taskId=ua7c449cd-7b89-4ba0-aee0-d27a5f7da7d&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1584602513812.png"><br><img src="/assets/1584602513812.png#id=Cff16&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1584602513812.png#id=Cff16&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>这里面涉及到两个重要的角色分别是”应用集群”和”负载均衡器”。<br>应用集群：将同一应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理并返回响应的数据。<br><strong>负载均衡器:将用户访问的请求根据对应的负载均衡算法，分发到集群中的一台服务器进行处理。</strong></p>
<h3 id="负载均衡的作用"><a href="#负载均衡的作用" class="headerlink" title="负载均衡的作用"></a>负载均衡的作用</h3><p>1、解决服务器的高并发压力，提高应用程序的处理性能。<br>2、提供故障转移，实现高可用。<br>3、通过添加或减少服务器数量，增强网站的可扩展性。<br>4、在负载均衡器上进行过滤，可以提高系统的安全性。</p>
<h2 id="负载均衡常用的处理方式"><a href="#负载均衡常用的处理方式" class="headerlink" title="负载均衡常用的处理方式"></a>负载均衡常用的处理方式</h2><h4 id="方式一-用户手动选择"><a href="#方式一-用户手动选择" class="headerlink" title="方式一:用户手动选择"></a>方式一:用户手动选择</h4><p>这种方式比较原始，只要实现的方式就是在网站主页上面提供不同线路、不同服务器链接方式，让用户来选择自己访问的具体服务器，来实现负载均衡。</p>
<h4 id="方式二-DNS轮询方式"><a href="#方式二-DNS轮询方式" class="headerlink" title="方式二:DNS轮询方式"></a>方式二:DNS轮询方式</h4><p>DNS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">域名系统（服务）协议（DNS）是一种分布式网络目录服务，主要用于域名与 IP 地址的相互转换。</span><br></pre></td></tr></table></figure>

<p>大多域名注册商都支持对同一个主机名添加多条A记录（一个域名可以绑定多个ip地址），这就是DNS轮询，DNS服务器将解析请求按照A记录的顺序，随机分配到不同的IP上，这样就能完成简单的负载均衡。DNS轮询的成本非常低，在一些不重要的服务器，被经常使用。<br>根据请求域名 解析出具体ip 然后轮询分配<br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685524078355-c6fc3a6b-513b-4332-9977-5112713a077e.png#averageHue=%23f3f3f3&clientId=ucb142d16-5477-4&from=ui&id=uf7390c19&originHeight=762&originWidth=1258&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22178&status=done&style=none&taskId=u81dc2545-74cd-4f7d-982b-5738596d0f3&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685524078355-c6fc3a6b-513b-4332-9977-5112713a077e.png#averageHue=%23f3f3f3&clientId=ucb142d16-5477-4&from=ui&id=uf7390c19&originHeight=762&originWidth=1258&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22178&status=done&style=none&taskId=u81dc2545-74cd-4f7d-982b-5738596d0f3&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591010973996.png"></p>
<p>验证:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping www.nginx521.cn</span><br></pre></td></tr></table></figure>
<p>清空本地的dns缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/flushdns</span><br></pre></td></tr></table></figure>
<p>我们发现使用DNS来实现轮询，不需要投入过多的成本，虽然DNS轮询成本低廉，但是DNS负载均衡存在明显的缺点。<br>1.可靠性低<br>假设一个域名DNS轮询多台服务器，如果其中的一台服务器发生故障，那么所有的访问该服务器的请求将不会有所回应，即使你将该服务器的IP从DNS中去掉，但是由于各大宽带接入商将众多的DNS存放在缓存中，以节省访问时间，导致DNS不会实时更新。所以DNS轮流上一定程度上解决了负载均衡问题，但是却存在可靠性不高的缺点。<br>2.负载均衡不均衡<br>DNS负载均衡采用的是简单的轮询负载算法，不能区分服务器的差异，不能反映服务器的当前运行状态，不能做到为性能好的服务器多分配请求，另外本地计算机也会缓存已经解析的域名到IP地址的映射，这也会导致使用该DNS服务器的用户在一定时间内访问的是同一台Web服务器，从而引发Web服务器减的负载不均衡。<br>负载不均衡则会导致某几台服务器负荷很低，而另外几台服务器负荷确很高，处理请求的速度慢，配置高的服务器分配到的请求少，而配置低的服务器分配到的请求多。</p>
<h4 id="方式三-四-七层负载均衡-常用"><a href="#方式三-四-七层负载均衡-常用" class="headerlink" title="方式三:四&#x2F;七层负载均衡 常用"></a>方式三:四&#x2F;七层负载均衡 常用</h4><p>介绍四&#x2F;七层负载均衡之前，我们先了解一个概念，OSI(open system interconnection),叫开放式系统互联模型，这个是由国际标准化组织ISO指定的一个不基于具体机型、操作系统或公司的网络体系结构。该模型将网络通信的工作分为七层。 计网<br>应用层：为应用程序提供网络服务。<br>表示层：对数据进行格式化、编码、加密、压缩等操作。<br>会话层：建立、维护、管理会话连接。<br>传输层：建立、维护、管理端到端的连接，常见的有TCP&#x2F;UDP。<br>网络层：IP寻址和路由选择<br>数据链路层：控制网络层与物理层之间的通信。<br>物理层：比特流传输。<br>所谓四层负载均衡指的是OSI七层模型中的传输层，主要是基于IP+PORT的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实现四层负载均衡的方式：</span><br><span class="line">硬件：F5 BIG-IP、Radware等</span><br><span class="line">软件：LVS、Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>
<p>所谓的七层负载均衡指的是在应用层，主要是基于虚拟的URL或主机IP的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实现七层负载均衡的方式：</span><br><span class="line">软件：Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>
<p>四层和七层负载均衡的区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">四层负载均衡数据包是在底层就进行了分发，而七层负载均衡数据包则在最顶端进行分发，所以四层负载均衡的效率比七层负载均衡的要高。</span><br><span class="line">四层负载均衡不识别域名，而七层负载均衡识别域名。</span><br></pre></td></tr></table></figure>
<p>处理四层和七层负载以为其实还有二层、三层负载均衡，二层是在数据链路层基于mac地址来实现负载均衡，三层是在网络层一般采用虚拟IP地址的方式实现负载均衡。<br>实际环境采用的模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">四层负载(LVS)+七层负载(Nginx)</span><br></pre></td></tr></table></figure>
<p>实际 我全都要 </p>
<h3 id="Nginx七层负载均衡"><a href="#Nginx七层负载均衡" class="headerlink" title="Nginx七层负载均衡 **************"></a>Nginx七层负载均衡 **************</h3><p>Nginx要实现七层负载均衡需要用到proxy_pass代理模块配置。Nginx默认安装支持这个模块，我们不需要再做任何处理。<strong>Nginx的负载均衡是在Nginx的反向代理基础上把用户的请求根据指定的算法分发到一组【upstream虚拟服务池】。</strong></p>
<h4 id="Nginx七层负载均衡的指令"><a href="#Nginx七层负载均衡的指令" class="headerlink" title="Nginx七层负载均衡的指令"></a>Nginx七层负载均衡的指令</h4><h5 id="upstream指令"><a href="#upstream指令" class="headerlink" title="upstream指令"></a>upstream指令</h5><p>该指令是用来定义一组服务器，它们可以是监听不同端口的服务器，并且也可以是同时监听TCP和Unix socket的服务器。服务器可以指定不同的权重，默认为1。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>upstream name {…}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<h5 id="server指令"><a href="#server指令" class="headerlink" title="server指令"></a>server指令</h5><p>该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者unix socket</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>server name [paramerters]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<h4 id="Nginx七层负载均衡的实现流程"><a href="#Nginx七层负载均衡的实现流程" class="headerlink" title="Nginx七层负载均衡的实现流程"></a>Nginx七层负载均衡的实现流程</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685524534801-198b9673-b0a4-41a7-8a82-640f20952ef4.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=uf73d4ba4&originHeight=384&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30605&status=done&style=none&taskId=ua21ed2d1-52ba-4723-823f-07de6d89b54&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685524534801-198b9673-b0a4-41a7-8a82-640f20952ef4.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=uf73d4ba4&originHeight=384&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30605&status=done&style=none&taskId=ua21ed2d1-52ba-4723-823f-07de6d89b54&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591809623736.png"><br>服务端设置 配置三台端口来模拟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen   9001;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen   9002;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen   9003;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>负载均衡器设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123; # 监听这里的所有 监听组</span><br><span class="line">	server 192.168.200.146:9091;</span><br><span class="line">	server 192.168.200.146:9092;</span><br><span class="line">	server 192.168.200.146:9093;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="负载均衡状态"><a href="#负载均衡状态" class="headerlink" title="负载均衡状态"></a>负载均衡状态</h4><p>代理服务器在负责均衡调度中的状态有以下几个：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td><strong>当前的server暂时不参与负载均衡</strong></td>
</tr>
<tr>
<td>backup</td>
<td><strong>预留的备份服务器</strong></td>
</tr>
<tr>
<td>max_fails</td>
<td><strong>允许请求失败的次数</strong></td>
</tr>
<tr>
<td>fail_timeout</td>
<td><strong>经过max_fails失败后, 服务暂停时间</strong></td>
</tr>
<tr>
<td>max_conns</td>
<td><strong>限制最大的接收连接数</strong></td>
</tr>
</tbody></table>
<h5 id="down"><a href="#down" class="headerlink" title="down"></a>down</h5><p>down:将该服务器标记为永久不可用，那么该代理服务器将不参与负载均衡。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 down;</span><br><span class="line">	server 192.168.200.146:9002</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该状态一般会对需要停机维护的服务器进行设置。</p>
<h5 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h5><p>backup:将该服务器标记为备份服务器，当主服务器不可用时，将用来传递请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 down;</span><br><span class="line">	server 192.168.200.146:9002 backup;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时需要将9094端口的访问禁止掉来模拟下唯一能对外提供访问的服务宕机以后，backup的备份服务器就要开始对外提供服务，此时为了测试验证，我们需要使用防火墙来进行拦截。<br>介绍一个工具<code>firewall-cmd</code>,该工具是Linux提供的专门用来操作firewall的。<br>查询防火墙中指定的端口是否开放</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --query-port=9001/tcp</span><br></pre></td></tr></table></figure>
<p>如何开放一个指定的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=9002/tcp</span><br></pre></td></tr></table></figure>
<p>批量添加开发端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=9001-9003/tcp</span><br></pre></td></tr></table></figure>
<p>如何移除一个指定的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-port=9003/tcp</span><br></pre></td></tr></table></figure>
<p>重新加载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>其中<br>     –permanent表示设置为持久<br>     –add-port表示添加指定端口<br>     –remove-port表示移除指定端口</p>
<h5 id="max-conns"><a href="#max-conns" class="headerlink" title="max_conns"></a>max_conns</h5><p>max_conns&#x3D;number:用来设置代理服务器同时活动链接的最大数量，默认为0，表示不限制，使用该配置可以根据后端服务器处理请求的并发量来进行设置，防止后端服务器被压垮。</p>
<h5 id="max-fails和fail-timeout"><a href="#max-fails和fail-timeout" class="headerlink" title="max_fails和fail_timeout"></a>max_fails和fail_timeout</h5><p>max_fails&#x3D;number:设置允许请求代理服务器失败的次数，默认为1。<br>fail_timeout&#x3D;time:设置经过max_fails失败后，服务暂停的时间，默认是10秒。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.133:9001 down;</span><br><span class="line">	server 192.168.200.133:9002 backup;</span><br><span class="line">	server 192.168.200.133:9003 max_fails=3 fail_timeout=15; # 失败三次以后 服务暂停15秒</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略 *********"></a>负载均衡策略 *********</h4><p>介绍完Nginx负载均衡的相关指令后，我们已经能实现将用户的请求分发到不同的服务器上，那么除了采用默认的分配方式以外，我们还能采用什么样的负载算法?<br>Nginx的upstream支持如下六种方式的分配算法，分别是:</p>
<table>
<thead>
<tr>
<th>算法名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式</td>
</tr>
<tr>
<td>ip_hash</td>
<td>依据ip分配方式</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据URL分配方式</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式</td>
</tr>
</tbody></table>
<h5 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h5><p><strong>是upstream模块负载均衡默认的策略</strong>。每个请求会按时间顺序逐个分配到不同的后端服务器。轮询不需要额外的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 weight=1;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="weight加权-加权轮询"><a href="#weight加权-加权轮询" class="headerlink" title="weight加权[加权轮询]"></a>weight加权[加权轮询]</h5><p>weight&#x3D;number:用来设置服务器的权重，默认为1，权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的，所有此策略比较适合服务器的硬件配置差别比较大的情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 weight=10;</span><br><span class="line">	server 192.168.200.146:9002 weight=5;</span><br><span class="line">	server 192.168.200.146:9003 weight=3;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h5><p>当对后端的多台动态应用服务器做负载均衡时，ip_hash指令能够将某个客户端IP的请求通过哈希算法定位到同一台后端服务器上。这样，当来自某一个IP的用户在后端Web服务器A上登录后，在访问该站点的其他URL，能保证其访问的还是后端web服务器A。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ip_hash;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	ip_hash;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要额外多说一点的是使用ip_hash指令无法保证后端服务器的负载均衡，可能导致有些后端服务器接收到的请求多，有些后端服务器接收的请求少，而且设置后端服务器权重等方法将不起作用。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685526927207-e01064a2-dda4-4d15-8393-9ec79335aff1.png#averageHue=%23fdfcfc&clientId=ucb142d16-5477-4&from=ui&id=u2efabbc1&originHeight=389&originWidth=1412&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37684&status=done&style=none&taskId=u0fa68656-576b-41e6-89f7-d1e3c272bf2&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685526927207-e01064a2-dda4-4d15-8393-9ec79335aff1.png#averageHue=%23fdfcfc&clientId=ucb142d16-5477-4&from=ui&id=u2efabbc1&originHeight=389&originWidth=1412&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37684&status=done&style=none&taskId=u0fa68656-576b-41e6-89f7-d1e3c272bf2&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591706748677.png"></p>
<h5 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn"></a>least_conn</h5><p>最少连接，把请求转发给连接数较少的后端服务器。轮询算法是把请求平均的转发给各个后端，使它们的负载大致相同；但是，有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn这种方式就可以达到更好的负载均衡效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	least_conn;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此负载均衡策略适合请求处理时间长短不一造成服务器过载的情况。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685527147526-39a3072f-97be-442a-bfa6-8a78813aebfc.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=ub8799fd8&originHeight=384&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30605&status=done&style=none&taskId=ue1d29975-a4e1-46ed-a987-3f97fce6255&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685527147526-39a3072f-97be-442a-bfa6-8a78813aebfc.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=ub8799fd8&originHeight=384&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30605&status=done&style=none&taskId=ue1d29975-a4e1-46ed-a987-3f97fce6255&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591809623736.png"></p>
<h5 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h5><p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，要配合缓存命中来使用。同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。而使用url_hash，可以使得同一个url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend&#123;</span><br><span class="line">  <span class="attribute">hash</span> &amp;request_uri; <span class="comment"># &amp;request_uri 内置变量 获取的就是uri地址</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.200.146:9001</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.200.146:9002</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.200.146:9003</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">  <span class="section">location</span> /&#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问如下地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.133:8083/a</span><br><span class="line">http://192.168.200.133:8083/b</span><br><span class="line">http://192.168.200.133:8083/c</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685527226598-e0a42b60-95fa-4122-b148-0de70a6f79b3.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=u63c04f46&originHeight=405&originWidth=1628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38990&status=done&style=none&taskId=uc5f6589f-088a-4bfd-b5d7-7ef04f04fb3&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685527226598-e0a42b60-95fa-4122-b148-0de70a6f79b3.png#averageHue=%23fcfcfc&clientId=ucb142d16-5477-4&from=ui&id=u63c04f46&originHeight=405&originWidth=1628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38990&status=done&style=none&taskId=uc5f6589f-088a-4bfd-b5d7-7ef04f04fb3&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591812222306.png"><br><img src="/assets/1591812222306.png#id=cRFhG&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1591812222306.png#id=cRFhG&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h5 id="fair–公平公正"><a href="#fair–公平公正" class="headerlink" title="fair–公平公正"></a>fair–公平公正</h5><p>fair采用的不是内建负载均衡使用的轮换的均衡算法，而是可以根据页面大小、加载时间长短智能的进行负载均衡。那么如何使用第三方模块的fair负载均衡策略。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	fair;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是如何直接使用会报错，因为fair属于第三方模块实现的负载均衡。需要添加<code>nginx-upstream-fair</code>,如何添加对应的模块:</p>
<ol>
<li><p>下载nginx-upstream-fair模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下载地址为:</span><br><span class="line">	https://github.com/gnosek/nginx-upstream-fair</span><br></pre></td></tr></table></figure>
</li>
<li><p>将下载的文件上传到服务器并进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip nginx-upstream-fair-master.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>重命名资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv nginx-upstream-fair-master fair</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用.&#x2F;configure命令将资源添加到Nginx模块中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --add-module=/root/fair</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure></li>
</ol>
<p>编译可能会出现如下错误，ngx_http_upstream_srv_conf_t结构中缺少default_port</p>
<p>解决方案:<br>在Nginx的源码中 src&#x2F;http&#x2F;ngx_http_upstream.h,找到<code>ngx_http_upstream_srv_conf_s</code>，在模块中添加添加default_port属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_port_t	   default_port</span><br></pre></td></tr></table></figure>

<p>然后再进行make.</p>
<ol start="6">
<li><p>更新Nginx</p>
<p>  6.1 将sbin目录下的nginx进行备份</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginxold</span><br></pre></td></tr></table></figure>
<pre><code>6.2 将安装目录下的objs中的nginx拷贝到sbin目录
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd objs</span><br><span class="line">cp nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>
<pre><code> 6.3 更新Nginx
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ../</span><br><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>编译测试使用Nginx</li>
</ol>
<p>上面介绍了Nginx常用的负载均衡的策略，有人说是5种，是把轮询和加权轮询归为一种，也有人说是6种。那么在咱们以后的开发中到底使用哪种，这个需要根据实际项目的应用场景来决定的。</p>
<h4 id="负载均衡案例"><a href="#负载均衡案例" class="headerlink" title="负载均衡案例"></a>负载均衡案例</h4><h5 id="案例一：对所有请求实现一般轮询规则的负载均衡"><a href="#案例一：对所有请求实现一般轮询规则的负载均衡" class="headerlink" title="案例一：对所有请求实现一般轮询规则的负载均衡"></a>案例一：对所有请求实现一般轮询规则的负载均衡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="案例二：对所有请求实现加权轮询规则的负载均衡"><a href="#案例二：对所有请求实现加权轮询规则的负载均衡" class="headerlink" title="案例二：对所有请求实现加权轮询规则的负载均衡"></a>案例二：对所有请求实现加权轮询规则的负载均衡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 weight=7;</span><br><span class="line">	server 192.168.200.146:9002 weight=5;</span><br><span class="line">	server 192.168.200.146:9003 weight=3;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="案例三：对特定资源实现负载均衡"><a href="#案例三：对特定资源实现负载均衡" class="headerlink" title="案例三：对特定资源实现负载均衡"></a>案例三：对特定资源实现负载均衡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream videobackend&#123;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">&#125;</span><br><span class="line">upstream filebackend&#123;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">	server 192.168.200.146:9004;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8084;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /video/ &#123;</span><br><span class="line">		proxy_pass http://videobackend;</span><br><span class="line">	&#125;</span><br><span class="line">	location /file/ &#123;</span><br><span class="line">		proxy_pass http://filebackend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="案例四：对不同域名实现负载均衡"><a href="#案例四：对不同域名实现负载均衡" class="headerlink" title="案例四：对不同域名实现负载均衡"></a>案例四：对不同域名实现负载均衡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream itcastbackend&#123;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">&#125;</span><br><span class="line">upstream itheimabackend&#123;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">	server 192.168.200.146:9004;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	8085;</span><br><span class="line">	server_name www.itcast.cn;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://itcastbackend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	8086;</span><br><span class="line">	server_name www.itheima.cn;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://itheimabackend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="案例五：实现带有URL重写的负载均衡"><a href="#案例五：实现带有URL重写的负载均衡" class="headerlink" title="案例五：实现带有URL重写的负载均衡"></a>案例五：实现带有URL重写的负载均衡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001;</span><br><span class="line">	server 192.168.200.146:9002;</span><br><span class="line">	server 192.168.200.146:9003;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /file/ &#123;</span><br><span class="line">		rewrite ^(/file/.*) /server/$1 last;</span><br><span class="line">	&#125;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nginx四层负载均衡"><a href="#Nginx四层负载均衡" class="headerlink" title="Nginx四层负载均衡"></a>Nginx四层负载均衡</h3><p>Nginx在1.9之后，增加了一个stream模块，用来实现四层协议的转发、代理、负载均衡等。stream模块的用法跟http的用法类似，允许我们配置一组TCP或者UDP等协议的监听，然后通过proxy_pass来转发我们的请求，通过upstream添加多个后端服务，实现负载均衡。</p>
<p>四层协议负载均衡的实现，一般都会用到LVS、HAProxy、F5等，要么很贵要么配置很麻烦，而Nginx的配置相对来说更简单，更能快速完成工作。</p>
<h4 id="添加stream模块的支持"><a href="#添加stream模块的支持" class="headerlink" title="添加stream模块的支持"></a>添加stream模块的支持</h4><p>Nginx默认是没有编译这个模块的，需要使用到stream模块，那么需要在编译的时候加上<code>--with-stream</code>。<br>完成添加<code>--with-stream</code>的实现步骤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">》将原有/usr/local/nginx/sbin/nginx进行备份</span><br><span class="line">》拷贝nginx之前的配置信息</span><br><span class="line">》在nginx的安装源码进行配置指定对应模块  ./configure --with-stream</span><br><span class="line">》通过make模板进行编译</span><br><span class="line">》将objs下面的nginx移动到/usr/local/nginx/sbin下</span><br><span class="line">》在源码目录下执行  make upgrade进行升级，这个可以实现不停机添加新模块的功能</span><br></pre></td></tr></table></figure>
<h4 id="Nginx四层负载均衡的指令"><a href="#Nginx四层负载均衡的指令" class="headerlink" title="Nginx四层负载均衡的指令"></a>Nginx四层负载均衡的指令</h4><h5 id="stream指令"><a href="#stream指令" class="headerlink" title="stream指令"></a>stream指令</h5><p>该指令提供在其中指定流服务器指令的配置文件上下文。和http指令同级。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>stream { … }</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>main</td>
</tr>
</tbody></table>
<h5 id="upstream指令-1"><a href="#upstream指令-1" class="headerlink" title="upstream指令"></a>upstream指令</h5><p>该指令和http的upstream指令是类似的。</p>
<h4 id="四层负载均衡的案例"><a href="#四层负载均衡的案例" class="headerlink" title="四层负载均衡的案例"></a>四层负载均衡的案例</h4><h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685534276522-e807a1c8-879e-4654-ad84-cd25d0028e00.png#averageHue=%23fdfdfc&clientId=ucb142d16-5477-4&from=ui&id=u84c35d7d&originHeight=605&originWidth=1212&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24359&status=done&style=none&taskId=ub2a1f596-0c10-413f-bdcd-1514117953a&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685534276522-e807a1c8-879e-4654-ad84-cd25d0028e00.png#averageHue=%23fdfdfc&clientId=ucb142d16-5477-4&from=ui&id=u84c35d7d&originHeight=605&originWidth=1212&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24359&status=done&style=none&taskId=ub2a1f596-0c10-413f-bdcd-1514117953a&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591897178807.png"><br>实现步骤<br>(1)准备Redis服务器,在一条服务器上准备三个Redis，端口分别是6379,6378<br>1.上传redis的安装包，<code>redis-4.0.14.tar.gz</code><br>2.将安装包进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf redis-4.0.14.tar.gz</span><br></pre></td></tr></table></figure>
<p>3.进入redis的安装包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd redis-4.0.14</span><br></pre></td></tr></table></figure>
<p>4.使用make和install进行编译和安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make PREFIX=/usr/local/redis/redis01 install</span><br></pre></td></tr></table></figure>

<p>5.拷贝redis配置文件<code>redis.conf</code>到&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis01&#x2F;bin目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp redis.conf	/usr/local/redis/redis01/bin</span><br></pre></td></tr></table></figure>
<p>6.修改redis.conf配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port  6379      #redis的端口</span><br><span class="line">daemonize yes   #后台启动redis</span><br></pre></td></tr></table></figure>

<p>7.将redis01复制一份为redis02</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/redis</span><br><span class="line">cp -r redis01 redis02</span><br></pre></td></tr></table></figure>

<p>8.将redis02文件文件夹中的redis.conf进行修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port  6378      #redis的端口</span><br><span class="line">daemonize yes   #后台启动redis</span><br></pre></td></tr></table></figure>

<p>9.分别启动，即可获取两个Redis.并查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>
<p>使用Nginx将请求分发到不同的Redis服务器上。</p>
<p>(2)准备Tomcat服务器.<br>1.上传tomcat的安装包，<code>apache-tomcat-8.5.56.tar.gz</code></p>
<p>2.将安装包进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf apache-tomcat-8.5.56.tar.gz</span><br></pre></td></tr></table></figure>

<p>3.进入tomcat的bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd apache-tomcat-8.5.56/bin</span><br><span class="line">./startup</span><br></pre></td></tr></table></figure>

<p>nginx.conf配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">        upstream redisbackend &#123;</span><br><span class="line">                server 192.168.200.146:6379;</span><br><span class="line">                server 192.168.200.146:6378;</span><br><span class="line">        &#125;</span><br><span class="line">        upstream tomcatbackend &#123;</span><br><span class="line">        		server 192.168.200.146:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                listen  81;</span><br><span class="line">                proxy_pass redisbackend;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">        		listen	82;</span><br><span class="line">        		proxy_pass tomcatbackend;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问测试。</p>
<h1 id="Nginx缓存集成"><a href="#Nginx缓存集成" class="headerlink" title="Nginx缓存集成"></a>Nginx缓存集成</h1><h2 id="缓存的概念"><a href="#缓存的概念" class="headerlink" title="缓存的概念"></a>缓存的概念</h2><p>缓存就是数据交换的缓冲区(称作:Cache),当用户要获取数据的时候，会先从缓存中去查询获取数据，如果缓存中有就会直接返回给用户，如果缓存中没有，则会发请求从服务器重新查询数据，将数据返回给用户的同时将数据放入缓存，下次用户就会直接从缓存中获取数据。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685535970409-3a8e4a86-cd20-4394-a2b5-672a26568c41.png#averageHue=%23fcfbfb&clientId=ucb142d16-5477-4&from=ui&id=uc1da7a72&originHeight=490&originWidth=1493&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29413&status=done&style=none&taskId=ua3ae5951-ec22-4442-ad35-0536d4b712c&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685535970409-3a8e4a86-cd20-4394-a2b5-672a26568c41.png#averageHue=%23fcfbfb&clientId=ucb142d16-5477-4&from=ui&id=uc1da7a72&originHeight=490&originWidth=1493&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29413&status=done&style=none&taskId=ua3ae5951-ec22-4442-ad35-0536d4b712c&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591944051969.png"><br><img src="/assets/1591944051969.png#id=EbVeu&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1591944051969.png#id=EbVeu&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>缓存其实在很多场景中都有用到，比如：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统磁盘缓存</td>
<td>减少磁盘机械操作</td>
</tr>
<tr>
<td>数据库缓存</td>
<td>减少文件系统的IO操作</td>
</tr>
<tr>
<td>应用程序缓存</td>
<td>减少对数据库的查询</td>
</tr>
<tr>
<td>Web服务器缓存</td>
<td>减少对应用服务器请求次数</td>
</tr>
<tr>
<td>浏览器缓存</td>
<td>减少与后台的交互次数</td>
</tr>
</tbody></table>
<p>缓存的优点<br>    1.减少数据传输，节省网络流量，加快响应速度，提升用户体验；<br>    2.减轻服务器压力；<br>    3.提供服务端的高可用性；<br>缓存的缺点<br>    1.数据的不一致<br>    2.增加成本</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536034184-2f322382-1d23-450e-99f7-36722322a058.png#averageHue=%23efefef&clientId=ucb142d16-5477-4&from=ui&id=u249de431&originHeight=309&originWidth=1261&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8847&status=done&style=none&taskId=ua99c244f-0dfb-4731-a6ef-5dceb9533be&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536034184-2f322382-1d23-450e-99f7-36722322a058.png#averageHue=%23efefef&clientId=ucb142d16-5477-4&from=ui&id=u249de431&originHeight=309&originWidth=1261&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8847&status=done&style=none&taskId=ua99c244f-0dfb-4731-a6ef-5dceb9533be&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1582295367198.png"><br><img src="/assets/1582295367198.png#id=LHSId&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1582295367198.png#id=LHSId&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>本次课程注解讲解的是Nginx,Nginx作为web服务器，Nginx作为Web缓存服务器，它介于客户端和应用服务器之间，当用户通过浏览器访问一个URL时，web缓存服务器会去应用服务器获取要展示给用户的内容，将内容缓存到自己的服务器上，当下一次请求到来时，如果访问的是同一个URL，web缓存服务器就会直接将之前缓存的内容返回给客户端，而不是向应用服务器再次发送请求。web缓存降低了应用服务器、数据库的负载，减少了网络延迟，提高了用户访问的响应速度，增强了用户的体验。</p>
<h2 id="Nginx的web缓存服务"><a href="#Nginx的web缓存服务" class="headerlink" title="Nginx的web缓存服务"></a>Nginx的web缓存服务</h2><p>Nginx是从0.7.48版开始提供缓存功能。Nginx是基于Proxy Store来实现的，其原理是把URL及相关组合当做Key,在使用MD5算法对Key进行哈希，得到硬盘上对应的哈希目录路径，从而将缓存内容保存在该目录中。它可以支持任意URL连接，同时也支持404&#x2F;301&#x2F;302这样的非200状态码。Nginx即可以支持对指定URL或者状态码设置过期时间，也可以使用purge命令来手动清除指定URL的缓存。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536072245-3620ac09-bb03-4b29-a132-639ce6d2b1fe.png#averageHue=%23fbfafa&clientId=ucb142d16-5477-4&from=ui&id=ua519d633&originHeight=407&originWidth=1389&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22383&status=done&style=none&taskId=u7bcc3c62-d65a-485b-9229-85e27defa27&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536072245-3620ac09-bb03-4b29-a132-639ce6d2b1fe.png#averageHue=%23fbfafa&clientId=ucb142d16-5477-4&from=ui&id=ua519d633&originHeight=407&originWidth=1389&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22383&status=done&style=none&taskId=u7bcc3c62-d65a-485b-9229-85e27defa27&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591947990200.png"><br><img src="/assets/1591947990200.png#id=ahlr3&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1591947990200.png#id=ahlr3&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="Nginx缓存设置的相关指令"><a href="#Nginx缓存设置的相关指令" class="headerlink" title="Nginx缓存设置的相关指令"></a>Nginx缓存设置的相关指令</h2><p>Nginx的web缓存服务主要是使用<code>ngx_http_proxy_module</code>模块相关指令集来完成，接下来我们把常用的指令来进行介绍下。</p>
<h3 id="proxy-cache-path"><a href="#proxy-cache-path" class="headerlink" title="proxy_cache_path"></a>proxy_cache_path</h3><p>该指定用于设置缓存文件的存放路径</p>
<p>| 语法 | proxy_cache_path path [levels&#x3D;number] </p>
<p>keys_zone&#x3D;zone_name:zone_size [inactive&#x3D;time][max_size&#x3D;size]; |<br>| — | — |<br>| 默认值 | — |<br>| 位置 | http |</p>
<p>path:缓存路径地址,如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/proxy_cache</span><br></pre></td></tr></table></figure>
<p>levels: 指定该缓存空间对应的目录，最多可以设置3层，每层取值为1|2如 :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">levels=1:2   缓存空间有两层目录，第一次是1个字母，第二次是2个字母</span><br><span class="line">举例说明:</span><br><span class="line">itheima[key]通过MD5加密以后的值为 43c8233266edce38c2c9af0694e2107d</span><br><span class="line">levels=1:2   最终的存储路径为/usr/local/proxy_cache/d/07</span><br><span class="line">levels=2:1:2 最终的存储路径为/usr/local/proxy_cache/7d/0/21</span><br><span class="line">levels=2:2:2 最终的存储路径为??/usr/local/proxy_cache/7d/10/e2</span><br></pre></td></tr></table></figure>

<p>keys_zone:用来为这个缓存区设置名称和指定大小，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys_zone=itcast:200m  缓存区的名称是itcast,大小为200M,1M大概能存储8000个keys</span><br></pre></td></tr></table></figure>

<p>inactive:指定缓存的数据多次时间未被访问就将被删除，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inactive=1d   缓存数据在1天内没有被访问就会被删除</span><br></pre></td></tr></table></figure>

<p>max_size:设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源，如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_size=20g</span><br></pre></td></tr></table></figure>

<p>配置实例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	proxy_cache_path /usr/local/proxy_cache keys_zone=itcast:200m  levels=1:2:1 inactive=1d max_size=20g;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="proxy-cache"><a href="#proxy-cache" class="headerlink" title="proxy_cache"></a>proxy_cache</h3><p>该指令用来开启或关闭代理缓存，如果是开启则自定使用哪个缓存区来进行缓存。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache zone_name&#124;off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>zone_name：指定使用缓存区的名称</p>
<h3 id="proxy-cache-key"><a href="#proxy-cache-key" class="headerlink" title="proxy_cache_key"></a>proxy_cache_key</h3><p>该指令用来设置web缓存的key值，Nginx会根据key值MD5哈希存缓存。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_key key;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_key $scheme$proxy_host$request_uri;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="proxy-cache-valid"><a href="#proxy-cache-valid" class="headerlink" title="proxy_cache_valid"></a>proxy_cache_valid</h3><p>该指令用来对不同返回状态码的URL设置不同的缓存时间</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_valid [code …] time;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 404 1m;</span><br><span class="line">为200和302的响应URL设置10分钟缓存，为404的响应URL设置1分钟缓存</span><br><span class="line">proxy_cache_valid any 1m;</span><br><span class="line">对所有响应状态码的URL都设置1分钟缓存</span><br></pre></td></tr></table></figure>
<h3 id="proxy-cache-min-uses"><a href="#proxy-cache-min-uses" class="headerlink" title="proxy_cache_min_uses"></a>proxy_cache_min_uses</h3><p>该指令用来设置资源被访问多少次后被缓存</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_min_uses number;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_min_uses 1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="proxy-cache-methods"><a href="#proxy-cache-methods" class="headerlink" title="proxy_cache_methods"></a>proxy_cache_methods</h3><p>该指令用户设置缓存哪些HTTP方法</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_methods GET&#124;HEAD&#124;POST;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_methods GET HEAD;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>默认缓存HTTP的GET和HEAD方法，不缓存POST方法。</p>
<h2 id="Nginx缓存设置案例"><a href="#Nginx缓存设置案例" class="headerlink" title="Nginx缓存设置案例"></a>Nginx缓存设置案例</h2><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="/assets/1591959569463.png#id=Ujojc&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" class="lazyload" data-srcset="/assets/1591959569463.png#id=Ujojc&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536716370-86581a2a-92d6-4d99-9239-5913feb22244.png#averageHue=%23faf9f9&clientId=ucb142d16-5477-4&from=ui&id=u21478c5c&originHeight=336&originWidth=1441&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23407&status=done&style=none&taskId=u331e78b2-78dc-432e-b878-150a2902d1f&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685536716370-86581a2a-92d6-4d99-9239-5913feb22244.png#averageHue=%23faf9f9&clientId=ucb142d16-5477-4&from=ui&id=u21478c5c&originHeight=336&originWidth=1441&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23407&status=done&style=none&taskId=u331e78b2-78dc-432e-b878-150a2902d1f&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1591959569463.png"></p>
<h4 id="步骤实现"><a href="#步骤实现" class="headerlink" title="步骤实现"></a>步骤实现</h4><p>1.环境准备<br>应用服务器的环境准备<br>（1）在192.168.200.146服务器上的tomcat的webapps下面添加一个js目录，并在js目录中添加一个jquery.js文件<br>（2）启动tomcat<br>（3）访问测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.146:8080/js/jquery.js</span><br></pre></td></tr></table></figure>

<p>Nginx的环境准备<br>（1）完成Nginx反向代理配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	upstream backend&#123;</span><br><span class="line">		server 192.168.200.146:8080;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen       8080;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">        	proxy_pass http://backend/js/;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）完成Nginx缓存配置</p>
<p>4.添加缓存配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	proxy_cache_path /usr/local/proxy_cache levels=2:1 keys_zone=itcast:200m inactive=1d max_size=20g;</span><br><span class="line">	upstream backend&#123;</span><br><span class="line">		server 192.168.200.146:8080;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen       8080;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">        	proxy_cache itcast;</span><br><span class="line">            proxy_cache_key itheima;</span><br><span class="line">            proxy_cache_min_uses 5;</span><br><span class="line">            proxy_cache_valid 200 5d;</span><br><span class="line">            proxy_cache_valid 404 30s;</span><br><span class="line">            proxy_cache_valid any 1m;</span><br><span class="line">            add_header nginx-cache &quot;$upstream_cache_status&quot;;</span><br><span class="line">        	proxy_pass http://backend/js/;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx缓存的清除"><a href="#Nginx缓存的清除" class="headerlink" title="Nginx缓存的清除"></a>Nginx缓存的清除</h2><h3 id="方式一-删除对应的缓存目录"><a href="#方式一-删除对应的缓存目录" class="headerlink" title="方式一:删除对应的缓存目录"></a>方式一:删除对应的缓存目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/local/proxy_cache/......</span><br></pre></td></tr></table></figure>
<h3 id="方式二-使用第三方扩展模块"><a href="#方式二-使用第三方扩展模块" class="headerlink" title="方式二:使用第三方扩展模块"></a>方式二:使用第三方扩展模块</h3><h4 id="ngx-cache-purge"><a href="#ngx-cache-purge" class="headerlink" title="ngx_cache_purge"></a>ngx_cache_purge</h4><p>（1）下载ngx_cache_purge模块对应的资源包，并上传到服务器上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>（2）对资源文件进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>（3）修改文件夹名称，方便后期配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ngx_cache_purge-2.3 purge</span><br></pre></td></tr></table></figure>

<p>（4）查询Nginx的配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>

<p>（5）进入Nginx的安装目录，使用.&#x2F;configure进行参数配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --add-module=/root/nginx/module/purge</span><br></pre></td></tr></table></figure>

<p>（6）使用make进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>（7）将nginx安装目录的nginx二级制可执行文件备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginxold</span><br></pre></td></tr></table></figure>

<p>（8）将编译后的objs中的nginx拷贝到nginx的sbin目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>（9）使用make进行升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<p>（10）在nginx配置文件中进行如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	location ~/purge(/.*) &#123;</span><br><span class="line">		proxy_cache_purge itcast itheima;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx设置资源不缓存"><a href="#Nginx设置资源不缓存" class="headerlink" title="Nginx设置资源不缓存"></a>Nginx设置资源不缓存</h2><p>前面咱们已经完成了Nginx作为web缓存服务器的使用。但是我们得思考一个问题就是不是所有的数据都适合进行缓存。比如说对于一些经常发生变化的数据。如果进行缓存的话，就很容易出现用户访问到的数据不是服务器真实的数据。所以对于这些资源我们在缓存的过程中就需要进行过滤，不进行缓存。<br>Nginx也提供了这块的功能设置，需要使用到如下两个指令</p>
<p>proxy_no_cache<br>该指令是用来定义不将数据进行缓存的条件。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_no_cache string …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>配置实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_no_cache $cookie_nocache $arg_nocache $arg_comment;</span><br></pre></td></tr></table></figure>
<p>proxy_cache_bypass<br>该指令是用来设置不从缓存中获取数据的条件。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_bypass string …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>配置实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_bypass $cookie_nocache $arg_nocache $arg_comment;</span><br></pre></td></tr></table></figure>
<p>上述两个指令都有一个指定的条件，这个条件可以是多个，并且多个条件中至少有一个不为空且不等于”0”,则条件满足成立。上面给的配置实例是从官方网站获取的，里面使用到了三个变量，分别是$cookie_nocache、$arg_nocache、$arg_comment</p>
<h3 id="cookie-nocache、-arg-nocache、-arg-comment"><a href="#cookie-nocache、-arg-nocache、-arg-comment" class="headerlink" title="$cookie_nocache、$arg_nocache、$arg_comment"></a>$cookie_nocache、$arg_nocache、$arg_comment</h3><p>这三个参数分别代表的含义是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$cookie_nocache</span><br><span class="line">指的是当前请求的cookie中键的名称为nocache对应的值</span><br><span class="line">$arg_nocache和$arg_comment</span><br><span class="line">指的是当前请求的参数中属性名为nocache和comment对应的属性值</span><br></pre></td></tr></table></figure>

<p>案例演示下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log_format params $cookie_nocache | $arg_nocache | $arg_comment；</span><br><span class="line">server&#123;</span><br><span class="line">	listen	8081;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location /&#123;</span><br><span class="line">		access_log logs/access_params.log params;</span><br><span class="line">		add_header Set-Cookie &#x27;nocache=999&#x27;;</span><br><span class="line">		root html;</span><br><span class="line">		index index.html;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="案例实现"><a href="#案例实现" class="headerlink" title="案例实现"></a>案例实现</h3><p>设置不缓存资源的配置方案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen	8080;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location / &#123;</span><br><span class="line">		if ($request_uri ~ /.*\.js$)&#123;</span><br><span class="line">           set $nocache 1;</span><br><span class="line">        &#125;</span><br><span class="line">		proxy_no_cache $nocache $cookie_nocache $arg_nocache $arg_comment;</span><br><span class="line">        proxy_cache_bypass $nocache $cookie_nocache $arg_nocache $arg_comment;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx高可用解决方案"><a href="#Nginx高可用解决方案" class="headerlink" title="Nginx高可用解决方案 ***"></a>Nginx高可用解决方案 ***</h2><p>nginx宕机怎么办？</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685544861624-b8a74f2f-9942-46d1-a442-a23249f81e28.png#averageHue=%23fcfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u8e10f4f5&originHeight=404&originWidth=1003&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32767&status=done&style=none&taskId=u88f19796-be6d-4f6e-bc7c-d662a3d2da0&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685544861624-b8a74f2f-9942-46d1-a442-a23249f81e28.png#averageHue=%23fcfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u8e10f4f5&originHeight=404&originWidth=1003&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32767&status=done&style=none&taskId=u88f19796-be6d-4f6e-bc7c-d662a3d2da0&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1604495169905.png"><br>需要两台以上的Nginx服务器对外提供服务，这样的话就可以解决其中一台宕机了，另外一台还能对外提供服务，但是如果是两台Nginx服务器的话，会有两个IP地址，用户该访问哪台服务器，用户怎么知道哪台是好的，哪台是宕机了的?</p>
<h3 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived ***"></a>Keepalived ***</h3><p>使用Keepalived来解决，Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，<strong>Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</strong></p>
<h3 id="VRRP介绍"><a href="#VRRP介绍" class="headerlink" title="VRRP介绍"></a>VRRP介绍</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685545092586-0f4ae85d-f52c-4dc2-9c8f-4aef0e489ac2.png#averageHue=%23fdfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u8529f4b9&originHeight=294&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=24896&status=done&style=none&taskId=uc96f41e9-44f2-4387-b6e0-596c989f804&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685545092586-0f4ae85d-f52c-4dc2-9c8f-4aef0e489ac2.png#averageHue=%23fdfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u8529f4b9&originHeight=294&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=24896&status=done&style=none&taskId=uc96f41e9-44f2-4387-b6e0-596c989f804&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1604495824757.png"><br><strong>说白了 以上两个路由虚拟出来一个路由 这个虚拟的路由有自己的ip地址 用户访问的就是这虚拟的ip地址 最终还是到真实路由上（真是路由会分为 主节点master 次节点backup） 主节点挂了 次节点补上 并且次节点会竞争谁来补上 （backup就是和master节点有联系 用来接收master的信息 如果某个时间段内没收到这样的信息 master就是G了 就需要补上） 这就是nginx的宕机的解决原理</strong><br>VRRP（Virtual Route Redundancy Protocol）协议，翻译过来为虚拟路由冗余协议。VRRP协议将两台或多台路由器设备虚拟成一个设备，对外提供虚拟路由器IP,而在路由器组内部，如果实际拥有这个对外IP的路由器如果工作正常的话就是MASTER,MASTER实现针对虚拟路由器IP的各种网络功能。其他设备不拥有该虚拟IP，状态为BACKUP,处了接收MASTER的VRRP状态通告信息以外，不执行对外的网络功能。当主机失效时，BACKUP将接管原先MASTER的网络功能。<br>从上面的介绍信息获取到的内容就是VRRP是一种协议，那这个协议是用来干什么的？<br>1.选择协议<br>VRRP可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由1和VRRP路由2之间会有竞争选择，通过选择会产生一个Master路由和一个Backup路由。<br>2.路由容错协议<br>Master路由和Backup路由之间会有一个心跳检测，Master会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代Master成为新的Master。Master路由有一个特权就是虚拟路由和后端服务器都是通过Master进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听Master的状态<br>用了Keepalived后，解决方案如下:</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685545381988-b7d27b41-02fc-4829-90b5-c6d126f46e32.png#averageHue=%23fcfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u45cbae62&originHeight=431&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50152&status=done&style=none&taskId=u5c54fb4a-ce4d-4fce-bedd-ca08e7a213a&title=" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685545381988-b7d27b41-02fc-4829-90b5-c6d126f46e32.png#averageHue=%23fcfcfc&clientId=u0bf6409a-e8c8-4&from=ui&id=u45cbae62&originHeight=431&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50152&status=done&style=none&taskId=u5c54fb4a-ce4d-4fce-bedd-ca08e7a213a&title=" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="1604495442179.png"><br>用户访问以上的vip虚拟 它在给master 如果master挂了 备份补上</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>环境准备</p>
<table>
<thead>
<tr>
<th><strong>VIP</strong></th>
<th><strong>IP</strong></th>
<th><strong>主机名</strong></th>
<th><strong>主&#x2F;从</strong></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>192.168.200.133</td>
<td>keepalived1</td>
<td>Master</td>
</tr>
<tr>
<td>192.168.200.222</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>192.168.200.122</td>
<td>keepalived2</td>
<td>Backup</td>
</tr>
</tbody></table>
<p>keepalived的安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">步骤1:从官方网站下载keepalived,官网地址https://keepalived.org/</span><br><span class="line">步骤2:将下载的资源上传到服务器</span><br><span class="line">    keepalived-2.0.20.tar.gz</span><br><span class="line">步骤3:创建keepalived目录，方便管理资源</span><br><span class="line">    mkdir keepalived</span><br><span class="line">步骤4:将压缩文件进行解压缩，解压缩到指定的目录</span><br><span class="line">    tar -zxf keepalived-2.0.20.tar.gz -C keepalived/</span><br><span class="line">步骤5:对keepalived进行配置，编译和安装</span><br><span class="line">    cd keepalived/keepalived-2.0.20</span><br><span class="line">    ./configure --sysconf=/etc --prefix=/usr/local</span><br><span class="line">    make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>安装完成后，有两个文件需要我们认识下，一个是 &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf(keepalived的系统配置文件，我们主要操作的就是该文件)，一个是&#x2F;usr&#x2F;local&#x2F;sbin目录下的keepalived,是系统配置脚本，用来启动和关闭keepalived</p>
<h3 id="Keepalived配置文件介绍"><a href="#Keepalived配置文件介绍" class="headerlink" title="Keepalived配置文件介绍"></a>Keepalived配置文件介绍</h3><p>打开keepalived.conf配置文件<br>这里面会分三部，<strong>第一部分是global全局配置、第二部分是vrrp相关配置、第三部分是LVS相关配置。</strong>本次课程主要是使用keepalived实现高可用部署，没有用到LVS，所以我们重点关注的是前两部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">global全局部分：</span><br><span class="line">global_defs &#123;</span><br><span class="line">   #通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     tom@itcast.cn</span><br><span class="line">     jerry@itcast.cn</span><br><span class="line">   &#125;</span><br><span class="line">   #设置发件人的邮箱信息</span><br><span class="line">   notification_email_from zhaomin@itcast.cn</span><br><span class="line">   #指定smpt服务地址</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   #指定smpt服务连接超时时间</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   #运行keepalived服务器的一个标识，可以用作发送邮件的主题信息</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   </span><br><span class="line">   #默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   #严格遵守VRRP协议。</span><br><span class="line">   vrrp_strict</span><br><span class="line">   #在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   #在一个网卡上每组na消息之间的延迟时间，默认为0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">VRRP部分，该部分可以包含以下四个子模块</span><br><span class="line">1. vrrp_script</span><br><span class="line">2. vrrp_sync_group</span><br><span class="line">3. garp_group</span><br><span class="line">4. vrrp_instance</span><br><span class="line">我们会用到第一个和第四个，</span><br><span class="line">#设置keepalived实例的相关信息，VI_1为VRRP实例名称</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER        #有两个值可选MASTER主 BACKUP备</span><br><span class="line">    interface ens33     #vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]</span><br><span class="line">    virtual_router_id 51#指定VRRP实例ID，范围是0-255</span><br><span class="line">    priority 100        #指定优先级，优先级高的将成为MASTER</span><br><span class="line">    advert_int 1        #指定发送VRRP通告的间隔，单位是秒</span><br><span class="line">    authentication &#123;    #vrrp之间通信的认证信息</span><br><span class="line">        auth_type PASS  #指定认证方式。PASS简单密码认证(推荐)</span><br><span class="line">        auth_pass 1111  #指定认证使用的密码，最多8位</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123; #虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个</span><br><span class="line">        192.168.200.222</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置内容如下:<br>服务器1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        tom@itcast.cn</span><br><span class="line">        jerry@itcast.cn</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from zhaomin@itcast.cn</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id keepalived1</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.222</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务器2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        tom@itcast.cn</span><br><span class="line">        jerry@itcast.cn</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from zhaomin@itcast.cn</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id keepalived2</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.222</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h3><ol>
<li><p>启动keepalived之前，咱们先使用命令 ip a,查看192.168.200.133和192.168.200.122这两台服务器的IP情况。</p>
</li>
<li><p>分别启动两台服务器的keepalived</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/sbin</span><br><span class="line">./keepalived</span><br></pre></td></tr></table></figure>
<p>再次通过 ip a查看ip</p>
</li>
<li><p>当把192.168.200.133服务器上的keepalived关闭后，再次查看ip</p>
</li>
<li><p>通过上述的测试，我们会发现，虚拟IP(VIP)会在MASTER节点上，当MASTER节点上的keepalived出问题以后，因为BACKUP无法收到MASTER发出的VRRP状态通过信息，就会直接升为MASTER。VIP也会”漂移”到新的MASTER。</p>
</li>
</ol>
<p>上面测试和Nginx有什么关系?<br>我们把192.168.200.133服务器的keepalived再次启动下，由于它的优先级高于服务器192.168.200.122的，所有它会再次成为MASTER，VIP也会”漂移”过去，然后我们再次通过浏览器访问:<a target="_blank" rel="noopener" href="http://192.168.200.222/">http://192.168.200.222/</a><br>如果把192.168.200.133服务器的keepalived关闭掉，再次访问相同的地址<br>效果实现了以后， 我们会发现要想让vip进行切换，就必须要把服务器上的keepalived进行关闭，而什么时候关闭keepalived呢?应该是在keepalived所在服务器的nginx出现问题后，把keepalived关闭掉，就可以让VIP执行另外一台服务器，但是现在这所有的操作都是通过手动来完成的，我们如何能让系统自动判断当前服务器的nginx是否正确启动，如果没有，要能让VIP自动进行”漂移”，这个问题该如何解决?</p>
<h3 id="keepalived之vrrp-script"><a href="#keepalived之vrrp-script" class="headerlink" title="keepalived之vrrp_script"></a>keepalived之vrrp_script</h3><p>keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务，比如Nginx,如果Nginx出现异常了，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。<br>实现步骤:</p>
<ol>
<li><p>在keepalived配置文件中添加对应的配置像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script 脚本名称</span><br><span class="line">&#123;</span><br><span class="line">    script &quot;脚本位置&quot;</span><br><span class="line">    interval 3 #执行时间间隔</span><br><span class="line">    weight -20 #动态调整vrrp_instance的优先级</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写脚本</p>
</li>
</ol>
<p>ck_nginx.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">num=`ps -C nginx --no-header | wc -l`</span><br><span class="line">if [ $num -eq 0 ];then</span><br><span class="line"> /usr/local/nginx/sbin/nginx</span><br><span class="line"> sleep 2</span><br><span class="line"> if [ `ps -C nginx --no-header | wc -l` -eq 0 ]; then</span><br><span class="line">  killall keepalived</span><br><span class="line"> fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>Linux ps命令用于显示当前进程 (process) 的状态。<br>-C(command) :指定命令的所有进程<br>–no-header 排除标题</p>
<ol start="3">
<li>为脚本文件设置权限</li>
</ol>
<p>chmod 755 ck_nginx.sh</p>
<ol start="4">
<li><p>将脚本添加到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script ck_nginx &#123;</span><br><span class="line">   script &quot;/etc/keepalived/ck_nginx.sh&quot; #执行脚本的位置</span><br><span class="line">   interval 2       #执行脚本的周期，秒为单位</span><br><span class="line">   weight -20       #权重的计算方式</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 10</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      ck_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果效果没有出来，可以使用 tail -f &#x2F;var&#x2F;log&#x2F;messages查看日志信息，找对应的错误信息。</p>
</li>
<li><p>测试</p>
</li>
</ol>
<p>问题思考:<br>通常如果master服务死掉后backup会变成master，但是当master服务又好了的时候 master此时会抢占VIP，这样就会发生两次切换对业务繁忙的网站来说是不好的。所以我们要在配置文件加入 nopreempt 非抢占，但是这个参数只能用于state 为backup，故我们在用HA的时候最好master 和backup的state都设置成backup 让其通过priority来竞争。</p>
<h1 id="Nginx制作下载站点"><a href="#Nginx制作下载站点" class="headerlink" title="Nginx制作下载站点"></a>Nginx制作下载站点</h1><p>首先我们先要清楚什么是下载站点?<br>我们先来看一个网站<a target="_blank" rel="noopener" href="http://nginx.org/download/%E8%BF%99%E4%B8%AA%E6%88%91%E4%BB%AC%E5%88%9A%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0Nginx%E7%9A%84%E6%97%B6%E5%80%99%E7%BB%99%E5%A4%A7%E5%AE%B6%E7%9C%8B%E8%BF%87%E8%BF%99%E6%A0%B7%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%8C%E8%AF%A5%E7%BD%91%E7%AB%99%E4%B8%BB%E8%A6%81%E5%B0%B1%E6%98%AF%E7%94%A8%E6%9D%A5%E6%8F%90%E4%BE%9B%E7%94%A8%E6%88%B7%E6%9D%A5%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%8C%E5%B0%B1%E5%8F%AB%E5%81%9A%E4%B8%8B%E8%BD%BD%E7%BD%91%E7%AB%99%E3%80%82">http://nginx.org/download/这个我们刚开始学习Nginx的时候给大家看过这样的网站，该网站主要就是用来提供用户来下载相关资源的网站，就叫做下载网站。</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685546253818-ab1e75db-5ec4-4301-a441-0ace50325cc8.png#averageHue=%23f6f6f6&clientId=u0bf6409a-e8c8-4&from=paste&height=525&id=u5e2110d0&originHeight=656&originWidth=765&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=29755&status=done&style=none&taskId=uc37f4248-58d7-4328-b9f8-27b5c45b78e&title=&width=612" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2023/png/33777315/1685546253818-ab1e75db-5ec4-4301-a441-0ace50325cc8.png#averageHue=%23f6f6f6&clientId=u0bf6409a-e8c8-4&from=paste&height=525&id=u5e2110d0&originHeight=656&originWidth=765&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=29755&status=done&style=none&taskId=uc37f4248-58d7-4328-b9f8-27b5c45b78e&title=&width=612" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image.png"><br>如何制作一个下载站点:<br>nginx使用的是模块ngx_http_autoindex_module来实现的，该模块处理以斜杠(“&#x2F;“)结尾的请求，并生成目录列表。<br>nginx编译的时候会自动加载该模块，但是该模块默认是关闭的，我们需要使用下来指令来完成对应的配置<br>（1）autoindex:启用或禁用目录列表输出</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>autoindex on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（2）autoindex_exact_size:对应HTLM格式，指定是否在目录列表展示文件的详细大小<br>默认为on，显示出文件的确切大小，单位是bytes。改为off后，显示出文件的大概大小，单位是kB或者MB或者GB</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>autoindex_exact_size on&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_exact_size on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（3）autoindex_format：设置目录列表的格式</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>autoindex_format html&#124;xml&#124;json&#124;jsonp;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_format html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>注意:该指令在1.7.9及以后版本中出现<br>（4）autoindex_localtime:对应HTML格式，是否在目录列表上显示时间。<br>默认为off，显示的文件时间为GMT时间。改为on后，显示的文件时间为文件的服务器时间</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>autoindex_localtime on &#124; off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_localtime off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>配置方式如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /download&#123;</span><br><span class="line">    root /usr/local;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size on;</span><br><span class="line">    autoindex_format html;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XML&#x2F;JSON格式[一般不用这两种方式]</p>
<h1 id="Nginx的用户认证模块"><a href="#Nginx的用户认证模块" class="headerlink" title="Nginx的用户认证模块"></a>Nginx的用户认证模块</h1><p>对应系统资源的访问，我们往往需要限制谁能访问，谁不能访问。这块就是我们通常所说的认证部分，认证需要做的就是根据用户输入的用户名和密码来判定用户是否为合法用户，如果是则放行访问，如果不是则拒绝访问。<br>Nginx对应用户认证这块是通过ngx_http_auth_basic_module模块来实现的，它允许通过使用”HTTP基本身份验证”协议验证用户名和密码来限制对资源的访问。默认情况下nginx是已经安装了该模块，如果不需要则使用–without-http_auth_basic_module。<br>该模块的指令比较简单，<br>（1）auth_basic:使用“ HTTP基本认证”协议启用用户名和密码的验证</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>auth_basic string&#124;off;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>auth_basic off;</td>
</tr>
<tr>
<td>位置</td>
<td>http,server,location,limit_except</td>
</tr>
</tbody></table>
<p>开启后，服务端会返回401，指定的字符串会返回到客户端，给用户以提示信息，但是不同的浏览器对内容的展示不一致。<br>（2）auth_basic_user_file:指定用户名和密码所在文件</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>auth_basic_user_file file;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http,server,location,limit_except</td>
</tr>
</tbody></table>
<p>指定文件路径，该文件中的用户名和密码的设置，密码需要进行加密。可以采用工具自动生成<br>实现步骤:<br>1.nginx.conf添加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /download&#123;</span><br><span class="line">    root /usr/local;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size on;</span><br><span class="line">    autoindex_format html;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">    auth_basic &#x27;please input your auth&#x27;;</span><br><span class="line">    auth_basic_user_file htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.我们需要使用htpasswd工具生成<br>yum install -y httpd-tools</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c /usr/local/nginx/conf/htpasswd username //创建一个新文件记录用户名和密码</span><br><span class="line">htpasswd -b /usr/local/nginx/conf/htpasswd username password //在指定文件新增一个用户名和密码</span><br><span class="line">htpasswd -D /usr/local/nginx/conf/htpasswd username //从指定文件删除一个用户信息</span><br><span class="line">htpasswd -v /usr/local/nginx/conf/htpasswd username //验证用户名和密码是否正确</span><br></pre></td></tr></table></figure>
<p>上述方式虽然能实现用户名和密码的验证，但是大家也看到了，所有的用户名和密码信息都记录在文件里面，如果用户量过大的话，这种方式就显得有点麻烦了，这时候我们就得通过后台业务代码来进行用户权限的校验了。</p>

  </div>
  
  
    
    <div class='footer'>
       <!-- 参考资料、相关资料等 -->
      
       <!-- 相关文章 -->
      
      <!-- 版权声明组件 -->
      
      <!-- 打赏组件 -->
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateModified" datetime="2023-07-31T17:58:44+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2023年7月31日</p>
  </a>
</div>

        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://example.com/2023/07/31/Nginx/&title=Nginx - 天天&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://example.com/2023/07/31/Nginx/&title=Nginx - 天天&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://service.weibo.com/share/share.php?url=http://example.com/2023/07/31/Nginx/&title=Nginx - 天天&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
    
      
    
  </div>
</div>



        
      
    </div>
    <!-- Custom Files bottomMeta begin -->
    
    <!-- Custom Files bottomMeta end -->
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2023/07/31/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/'>
          <p class='title'><i class="fa-solid fa-chevron-left" aria-hidden="true"></i>设计模式</p>
          <p class='content'>前言关于设计模式

独立于语言，是一门单独的知识，
接口（interface）和API（项目对外提供 供外部访问的接口）
在代码中加入设计模式 可以提高代码的健壮性 可读性等等提高 
并不是所有...</p>
        </a>
      
      
        <a class='next' href='/2023/07/31/redis/'>
          <p class='title'>redis<i class="fa-solid fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>基础篇线上运行网站：https://try.redis.io/ 
sql和nosqlsql(Structured Query Language)：关系型数据库NoSql（Not Only Sql...</p>
        </a>
      
    </div>
  
  <!-- Custom Files postEnd begin-->
  
  <!-- Custom Files postEnd end-->
</article>


  


  <article class="post white-box shadow floatable blur" id="comments">
    <span hidden>
      <meta itemprop="discussionUrl" content="/2023/07/31/Nginx/index.html#comments">
    </span>
    <p ct><i class='fa-solid fa-comments'></i> 评论</p>
    

    <div id="layoutHelper-comments"></div>

  </article>






</div>
<aside id='l_side' itemscope itemtype="http://schema.org/WPSideBar">
  

  
    
    
      
    
  


<div class="widget-sticky pjax">

  
  


  <section class="widget toc-wrapper desktop mobile " id="toc-div" >
    
  <header>
    
      <i class="fa-solid fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%AE%80%E4%BB%8B"><span class="toc-text">Nginx简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-text">背景介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-text">名词解释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9%E6%AF%94"><span class="toc-text">常见服务器对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IIS"><span class="toc-text">IIS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat"><span class="toc-text">Tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache"><span class="toc-text">Apache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lighttpd"><span class="toc-text">Lighttpd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">其他的服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-text">Nginx的优点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E9%80%9F%E5%BA%A6%E6%9B%B4%E5%BF%AB%E3%80%81%E5%B9%B6%E5%8F%91%E6%9B%B4%E9%AB%98"><span class="toc-text">(1)速度更快、并发更高</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E7%AE%80%E5%8D%95%EF%BC%8C%E6%89%A9%E5%B1%95%E6%80%A7%E5%BC%BA"><span class="toc-text">(2)配置简单，扩展性强</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%AB%98%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-text">(3)高可靠性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E7%83%AD%E9%83%A8%E7%BD%B2"><span class="toc-text">(4)热部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%88%90%E6%9C%AC%E4%BD%8E%E3%80%81BSD%E8%AE%B8%E5%8F%AF%E8%AF%81"><span class="toc-text">(5)成本低、BSD许可证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">Nginx的功能特性及常用功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%ACHTTP%E6%9C%8D%E5%8A%A1"><span class="toc-text">基本HTTP服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7HTTP%E6%9C%8D%E5%8A%A1"><span class="toc-text">高级HTTP服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1"><span class="toc-text">邮件服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E5%B8%B8%E7%94%A8%E7%9A%84%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-text">Nginx常用的功能模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">Nginx环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%89%88%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">Nginx版本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96Nginx%E6%BA%90%E7%A0%81"><span class="toc-text">获取Nginx源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F"><span class="toc-text">准备服务器系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="toc-text">Nginx安装方式介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GCC%E7%BC%96%E8%AF%91%E5%99%A8"><span class="toc-text">GCC编译器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PCRE"><span class="toc-text">PCRE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zlib"><span class="toc-text">zlib</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OpenSSL"><span class="toc-text">OpenSSL</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9ANginx%E7%9A%84%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E5%AE%89%E8%A3%85"><span class="toc-text">方案一：Nginx的源码简单安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9Ayum%E5%AE%89%E8%A3%85"><span class="toc-text">方案二：yum安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E5%AE%89%E8%A3%85%E5%92%8Cyum%E5%AE%89%E8%A3%85%E7%9A%84%E5%B7%AE%E5%BC%82%EF%BC%9A"><span class="toc-text">源码简单安装和yum安装的差异：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8BNginx%E7%9B%AE%E5%BD%95"><span class="toc-text">解压Nginx目录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89-Nginx%E7%9A%84%E6%BA%90%E7%A0%81%E5%A4%8D%E6%9D%82%E5%AE%89%E8%A3%85"><span class="toc-text">方案三:Nginx的源码复杂安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-text">Nginx目录结构分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%81%9C%E5%91%BD%E4%BB%A4"><span class="toc-text">Nginx服务器启停命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-Nginx%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BF%A1%E5%8F%B7%E6%8E%A7%E5%88%B6"><span class="toc-text">方式一:Nginx服务的信号控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-Nginx%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A7%E5%88%B6"><span class="toc-text">方式二:Nginx的命令行控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E5%92%8C%E6%96%B0%E5%A2%9E%E6%A8%A1%E5%9D%97"><span class="toc-text">Nginx服务器版本升级和新增模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80-%E4%BD%BF%E7%94%A8Nginx%E6%9C%8D%E5%8A%A1%E4%BF%A1%E5%8F%B7%E8%BF%9B%E8%A1%8C%E5%8D%87%E7%BA%A7"><span class="toc-text">方案一:使用Nginx服务信号进行升级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C-%E4%BD%BF%E7%94%A8Nginx%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95%E7%9A%84make%E5%91%BD%E4%BB%A4%E5%AE%8C%E6%88%90%E5%8D%87%E7%BA%A7"><span class="toc-text">方案二:使用Nginx安装目录的make命令完成升级</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">Nginx核心配置文件结构***</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%9D%97"><span class="toc-text">全局块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#user%E6%8C%87%E4%BB%A4"><span class="toc-text">user指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#work-process%E6%8C%87%E4%BB%A4"><span class="toc-text">work process指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8C%87%E4%BB%A4"><span class="toc-text">其他指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#events%E5%9D%97"><span class="toc-text">events块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#events%E6%8C%87%E4%BB%A4%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><span class="toc-text">events指令配置实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E5%9D%97"><span class="toc-text">http块 *********</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89MIME-Type"><span class="toc-text">定义MIME-Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="toc-text">自定义服务日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-text">其他配置指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server%E5%9D%97%E5%92%8Clocation%E5%9D%97-%E8%BF%99%E9%87%8C%E5%8F%AA%E6%98%AF%E7%AE%80%E5%8D%95%E7%9A%84%E4%BD%BF%E7%94%A8-%E5%85%B7%E4%BD%93%E9%9C%80%E8%A6%81%E7%AD%89%E5%88%B0%E5%90%8E%E9%9D%A2"><span class="toc-text">server块和location块 这里只是简单的使用 具体需要等到后面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><span class="toc-text">Nginx服务器基础配置实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E6%93%8D%E4%BD%9C%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">Nginx服务操作的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%88%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-text">Nginx配置成系统服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%91%BD%E4%BB%A4%E9%85%8D%E7%BD%AE%E5%88%B0%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83"><span class="toc-text">Nginx命令配置到系统环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%83%A8%E7%BD%B2"><span class="toc-text">Nginx静态资源部署 ***</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%A6%82%E8%BF%B0"><span class="toc-text">Nginx静态资源概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-text">Nginx静态资源的配置指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#listen%E6%8C%87%E4%BB%A4"><span class="toc-text">listen指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server-name%E6%8C%87%E4%BB%A4"><span class="toc-text">server_name指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">匹配执行顺序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#location%E6%8C%87%E4%BB%A4"><span class="toc-text">location指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AF%B7%E6%B1%82%E8%B5%84%E6%BA%90%E7%9A%84%E7%9B%AE%E5%BD%95root-alias"><span class="toc-text">设置请求资源的目录root &#x2F; alias</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#index%E6%8C%87%E4%BB%A4"><span class="toc-text">index指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#error-page%E6%8C%87%E4%BB%A4"><span class="toc-text">error_page指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-text">静态资源优化配置语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%8E%8B%E7%BC%A9%E5%AE%9E%E6%88%98"><span class="toc-text">Nginx静态资源压缩实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gzip%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-text">Gzip模块配置指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gzip%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="toc-text">Gzip压缩功能的实例配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gzip%E5%92%8Csendfile%E5%85%B1%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-text">Gzip和sendfile共存问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#gzip-static%E6%8C%87%E4%BB%A4"><span class="toc-text">gzip_static指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97%E5%88%B0Nginx%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-text">添加模块到Nginx的实现步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gzip-static%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8"><span class="toc-text">gzip_static测试使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86"><span class="toc-text">静态资源的缓存处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-text">什么是缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFweb%E7%BC%93%E5%AD%98"><span class="toc-text">什么是web缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E7%BC%93%E5%AD%98%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-text">web缓存的种类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-text">浏览器缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-text">为什么要用浏览器缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">浏览器缓存的执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-text">浏览器缓存相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#expires%E6%8C%87%E4%BB%A4"><span class="toc-text">expires指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#add-header%E6%8C%87%E4%BB%A4"><span class="toc-text">add_header指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">Nginx的跨域问题解决</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5"><span class="toc-text">同源策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-text">跨域问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%98%B2%E7%9B%97%E9%93%BE-%E4%BF%9D%E8%AF%81%E8%87%AA%E5%B7%B1%E7%9A%84%E8%B5%84%E6%BA%90%E4%B8%8D%E8%A2%AB%E5%88%AB%E4%BA%BA%E9%9A%8F%E6%84%8F%E4%BD%BF%E7%94%A8"><span class="toc-text">静态资源防盗链 保证自己的资源不被别人随意使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B5%84%E6%BA%90%E7%9B%97%E9%93%BE"><span class="toc-text">什么是资源盗链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E9%98%B2%E7%9B%97%E9%93%BE%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-text">Nginx防盗链的实现原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E7%9B%AE%E5%BD%95%E8%BF%9B%E8%A1%8C%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-text">针对目录进行防盗链</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE"><span class="toc-text">Rewrite功能配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99%E2%80%9D%E4%B8%8E%E2%80%9D%E5%9C%B0%E5%9D%80%E8%BD%AC%E5%8F%91%E2%80%9D"><span class="toc-text">“地址重写”与”地址转发”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rewrite%E8%A7%84%E5%88%99"><span class="toc-text">Rewrite规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set%E6%8C%87%E4%BB%A4"><span class="toc-text">set指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rewrite%E5%B8%B8%E7%94%A8%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">Rewrite常用全局变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#if%E6%8C%87%E4%BB%A4"><span class="toc-text">if指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#break%E6%8C%87%E4%BB%A4"><span class="toc-text">break指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#return%E6%8C%87%E4%BB%A4"><span class="toc-text">return指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite%E6%8C%87%E4%BB%A4"><span class="toc-text">rewrite指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite-log%E6%8C%87%E4%BB%A4"><span class="toc-text">rewrite_log指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-text">Rewrite的案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC"><span class="toc-text">域名跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E9%95%9C%E5%83%8F"><span class="toc-text">域名镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E5%9F%9F%E5%90%8D"><span class="toc-text">独立域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E2%80%9D-%E2%80%9C"><span class="toc-text">目录自动添加”&#x2F;“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E7%9B%AE%E5%BD%95"><span class="toc-text">合并目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-text">防盗链</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">Nginx反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-text">Nginx反向代理概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-text">Nginx反向代理的配置语法 ***</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#proxy-pass"><span class="toc-text">proxy_pass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proxy-set-header"><span class="toc-text">proxy_set_header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proxy-redirect"><span class="toc-text">proxy_redirect</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E6%88%98"><span class="toc-text">Nginx反向代理实战***</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6"><span class="toc-text">Nginx的安全控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8SSL%E5%AF%B9%E6%B5%81%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86-https"><span class="toc-text">如何使用SSL对流量进行加密 https</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%8A%AB%E6%8C%81%EF%BC%88DNS%E5%8A%AB%E6%8C%81%EF%BC%89"><span class="toc-text">流量劫持（DNS劫持）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E4%BA%86-%E8%A2%AB%E4%B8%AD%E9%80%94%E6%88%AA%E5%8F%96%E4%BA%86-%E6%8A%8A%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E7%BB%99%E4%BB%96%E6%8C%87%E5%AE%9A%E7%9A%84web%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%E8%BF%99%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%BB%93%E6%9E%9C-%E8%BF%99%E6%A0%B7%E5%AE%89%E5%85%A8%E9%9A%90%E6%82%A3%E5%BE%88%E5%A4%A7"><span class="toc-text">请求发送了 被中途截取了 把这个请求发送给他指定的web服务器 然后返回这个web服务器的结果 这样安全隐患很大</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx%E6%B7%BB%E5%8A%A0SSL%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-text">nginx添加SSL的支持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E7%9A%84SSL%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-text">Nginx的SSL相关指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AFSSL%E5%AE%9E%E4%BE%8B"><span class="toc-text">开启SSL实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E4%BC%98"><span class="toc-text">反向代理系统调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A6%82%E8%BF%B0"><span class="toc-text">负载均衡概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">负载均衡的原理及处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">负载均衡的作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-text">负载均衡常用的处理方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-%E7%94%A8%E6%88%B7%E6%89%8B%E5%8A%A8%E9%80%89%E6%8B%A9"><span class="toc-text">方式一:用户手动选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-DNS%E8%BD%AE%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-text">方式二:DNS轮询方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%89-%E5%9B%9B-%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-%E5%B8%B8%E7%94%A8"><span class="toc-text">方式三:四&#x2F;七层负载均衡 常用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">Nginx七层负载均衡 **************</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-text">Nginx七层负载均衡的指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#upstream%E6%8C%87%E4%BB%A4"><span class="toc-text">upstream指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#server%E6%8C%87%E4%BB%A4"><span class="toc-text">server指令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-text">Nginx七层负载均衡的实现流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%8A%B6%E6%80%81"><span class="toc-text">负载均衡状态</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#down"><span class="toc-text">down</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#backup"><span class="toc-text">backup</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#max-conns"><span class="toc-text">max_conns</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#max-fails%E5%92%8Cfail-timeout"><span class="toc-text">max_fails和fail_timeout</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-text">负载均衡策略 *********</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2"><span class="toc-text">轮询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#weight%E5%8A%A0%E6%9D%83-%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2"><span class="toc-text">weight加权[加权轮询]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ip-hash"><span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#least-conn"><span class="toc-text">least_conn</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#url-hash"><span class="toc-text">url_hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fair%E2%80%93%E5%85%AC%E5%B9%B3%E5%85%AC%E6%AD%A3"><span class="toc-text">fair–公平公正</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A1%88%E4%BE%8B"><span class="toc-text">负载均衡案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%EF%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%80%E8%88%AC%E8%BD%AE%E8%AF%A2%E8%A7%84%E5%88%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">案例一：对所有请求实现一般轮询规则的负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%EF%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2%E8%A7%84%E5%88%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">案例二：对所有请求实现加权轮询规则的负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%AF%B9%E7%89%B9%E5%AE%9A%E8%B5%84%E6%BA%90%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">案例三：对特定资源实现负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%9B%9B%EF%BC%9A%E5%AF%B9%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">案例四：对不同域名实现负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%94%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89URL%E9%87%8D%E5%86%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">案例五：实现带有URL重写的负载均衡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">Nginx四层负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0stream%E6%A8%A1%E5%9D%97%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-text">添加stream模块的支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-text">Nginx四层负载均衡的指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#stream%E6%8C%87%E4%BB%A4"><span class="toc-text">stream指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#upstream%E6%8C%87%E4%BB%A4-1"><span class="toc-text">upstream指令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-text">四层负载均衡的案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">需求分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-text">缓存的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9A%84web%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1"><span class="toc-text">Nginx的web缓存服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-text">Nginx缓存设置的相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-path"><span class="toc-text">proxy_cache_path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache"><span class="toc-text">proxy_cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-key"><span class="toc-text">proxy_cache_key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-valid"><span class="toc-text">proxy_cache_valid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-min-uses"><span class="toc-text">proxy_cache_min_uses</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-methods"><span class="toc-text">proxy_cache_methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E8%AE%BE%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="toc-text">Nginx缓存设置案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E5%AE%9E%E7%8E%B0"><span class="toc-text">步骤实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E9%99%A4"><span class="toc-text">Nginx缓存的清除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-%E5%88%A0%E9%99%A4%E5%AF%B9%E5%BA%94%E7%9A%84%E7%BC%93%E5%AD%98%E7%9B%AE%E5%BD%95"><span class="toc-text">方式一:删除对应的缓存目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%89%A9%E5%B1%95%E6%A8%A1%E5%9D%97"><span class="toc-text">方式二:使用第三方扩展模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ngx-cache-purge"><span class="toc-text">ngx_cache_purge</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%AE%BE%E7%BD%AE%E8%B5%84%E6%BA%90%E4%B8%8D%E7%BC%93%E5%AD%98"><span class="toc-text">Nginx设置资源不缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cookie-nocache%E3%80%81-arg-nocache%E3%80%81-arg-comment"><span class="toc-text">$cookie_nocache、$arg_nocache、$arg_comment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0"><span class="toc-text">案例实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%AB%98%E5%8F%AF%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">Nginx高可用解决方案 ***</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived"><span class="toc-text">Keepalived ***</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VRRP%E4%BB%8B%E7%BB%8D"><span class="toc-text">VRRP介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-text">Keepalived配置文件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">访问测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keepalived%E4%B9%8Bvrrp-script"><span class="toc-text">keepalived之vrrp_script</span></a></li></ol></li></ol>
    </div>
  </section>

  

</div>


<!-- 没有 pjax 占位会报错 万恶的 pjax -->

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <!-- Custom Files side begin -->
  
  <!-- Custom Files side end -->
</aside>



          <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<pjax>
<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  pdata.commentConfig={};
  //  see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs
  
    // header
    var l_header=document.getElementById("l_header");
    
    l_header.classList.add("show");
    
    
      // cover
      var cover_wrapper=document.querySelector('#l_cover .cover-wrapper');
      var scroll_down=document.getElementById('scroll-down');
      cover_wrapper.id="none";
      cover_wrapper.style.display="none";
      scroll_down.style.display="none";
    
  
</script>
</pjax>
        </div>
        
  
  <footer class="footer clearfix"  itemscope itemtype="http://schema.org/WPFooter">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='true'
      volume='0.7'
      loop='all'
      order='list'
      fixed='true'
      list-max-height='320px'
      server='netease'
      type='playlist'
      id='461471417'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper" itemprop="about" itemscope itemtype="http://schema.org/Thing">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer" itemprop="url">
                
              </a>
            
          
            
              <a href="https://github.com/mengxiangzhuifeiji"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer" itemprop="url">
                
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        本站使用
        <a href="https://github.com/volantis-x/hexo-theme-volantis/#5.8.0" target="_blank" class="codename">Volantis</a>
        作为主题
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © 2017-2021 XXX</a></p>

        </div>
      
    
    <!-- Custom Files footer begin-->
    
    <!-- Custom Files footer end-->
  </footer>


        <a id="s-top" class="fa-solid fa-arrow-up fa-fw" href="/" onclick="return false;" title="top"></a>
      </div>
    </div>
    <div>
      <script>
  /******************** volantis.dom ********************************/
  // 页面选择器 将dom对象缓存起来 see: /source/js/app.js etc.
  volantis.dom.bodyAnchor = volantis.dom.$(document.getElementById("safearea")); // 页面主体
  volantis.dom.topBtn = volantis.dom.$(document.getElementById('s-top')); // 向上
  volantis.dom.wrapper = volantis.dom.$(document.getElementById('wrapper')); // 整个导航栏
  volantis.dom.coverAnchor = volantis.dom.$(document.querySelector('#l_cover .cover-wrapper')); // 1个
  volantis.dom.switcher = volantis.dom.$(document.querySelector('#l_header .switcher .s-search')); // 搜索按钮   移动端 1个
  volantis.dom.header = volantis.dom.$(document.getElementById('l_header')); // 移动端导航栏
  volantis.dom.search = volantis.dom.$(document.querySelector('#l_header .m_search')); // 搜索框 桌面端 移动端 1个
  volantis.dom.mPhoneList = volantis.dom.$(document.querySelectorAll('#l_header .m-phone .list-v')); //  手机端 子菜单 多个
</script>

<script>
  
  volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fortawesome/fontawesome-free/css/all.min.css");
  
  
  
</script>

<!-- required -->


<!-- internal -->

<script src="/js/app.js"></script>






<!-- rightmenu要在darkmode之前（ToggleButton） darkmode要在comments之前（volantis.dark.push）-->



<script>
  function loadIssuesJS() {
    
      const sites_api = document.getElementById('sites-api');
      if (sites_api != undefined && typeof SitesJS === 'undefined') {
        volantis.js("/js/plugins/tags/sites.js")
      }
    
    
      const friends_api = document.getElementById('friends-api');
      if (friends_api != undefined && typeof FriendsJS === 'undefined') {
        volantis.js("/js/plugins/tags/friends.js")
      }
    
    
      const contributors_api = document.getElementById('contributors-api');
      if (contributors_api != undefined && typeof ContributorsJS === 'undefined') {
        volantis.js("/js/plugins/tags/contributors.js")
      }
    
  };
  loadIssuesJS()
  volantis.pjax.push(()=>{
    loadIssuesJS();
  })

</script>




  <script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/vanilla-lazyload/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: ["#"],
	maxRPS: 6,
	hoverDelay: 0
  };
</script>
<script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/flying-pages/flying-pages.min.js"></script>







  <script>
  volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/aplayer/dist/APlayer.min.css");
  (async () => {
    // APlayer 需要在  MetingJS 之前加载
    await volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/aplayer/dist/APlayer.min.js")
    await volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/meting/dist/Meting.min.js")
  
  })();

  function SetAPlayerPlugin(){
    let Metings = document.querySelectorAll('meting-js');
    if (Metings.length === 0) {return;};
    if (Metings[0].aplayer && Metings[0].aplayer.on) {
      // improve the accessibility https://web.dev/button-name/
      document.querySelectorAll(".aplayer-icon-menu").forEach(e=>{
        e.setAttribute("aria-label","Aplayer Menu")
      })
      // message see: /layout/_plugins/message/script.ejs
      
        try {
          setTimeout(() => {
            Metings.forEach((item, index) => {
              const aplayerItem = item.aplayer; if(!aplayerItem) return;
              const rightAplayerCheck = 'true' === 'true'
                && item.meta.id === '461471417';
              if(rightAplayerCheck && typeof RightMenuAplayer !="undefined") RightMenuAplayer.checkAPlayer();
              if(aplayerItem.events.events.play.every(item => {return item.name !== 'messagePlay'})) {
                aplayerItem.on('play', function messagePlay() {
                  let index = aplayerItem.list.index;
                  let title = aplayerItem.list.audios[index].title;
                  let artist = aplayerItem.list.audios[index].artist;
                  setTimeout(() => {
                    VolantisApp.message('音乐通知', title + ' - ' + artist, {
                      icon: 'fa-solid fa-play',
                      transitionIn: 'flipInX',
                      transitionOut: 'flipOutX'
                    });
                  }, 100)
                });
              }
              if(aplayerItem.events.events.pause.every(item => {return item.name !== 'messagePause'})) {
                aplayerItem.on('pause', function messagePause() {
                  let index = aplayerItem.list.index;
                  let title = aplayerItem.list.audios[index].title;
                  let artist = aplayerItem.list.audios[index].artist;
                  setTimeout(() => {
                    // 歌曲播放结束也会触发 pause 事件，为了避免错误提示，等待一会儿
                    if(aplayerItem.paused) {
                      VolantisApp.message('音乐通知', title + ' - ' + artist, {
                        icon: 'fa-solid fa-pause',
                        transitionIn: 'flipInX',
                        transitionOut: 'flipOutX'
                      });
                    }
                  }, 100)
                });
              }
            });
          }, 500)
        } catch (error) { console.error(error); }
      
    }else{
      volantis.requestAnimationFrame(SetAPlayerPlugin)
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    SetAPlayerPlugin();
  });
  volantis.pjax.push(SetAPlayerPlugin);
</script>




      <script>
  volantis.layoutHelper("comments",`<div id="giscus_container"></div>`)

  volantis.giscus = {};

  function check_giscus() {
    if (volantis.dark.mode === "dark") {
      volantis.giscus.Theme = 'dark';
    } else {
      volantis.giscus.Theme = 'light';
    }

    return document.getElementById("giscus_container");
  }

  function pjax_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;
    let cfg = Object.assign({"theme":{"light":"light","dark":"dark"}},pdata.commentConfig)
    const script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    Object.keys(cfg).forEach(k=>{
      if (k != "theme") {
        script.setAttribute('data-'+k, cfg[k]);
      }
    })
    script.setAttribute('data-theme', volantis.giscus.Theme);
    script.setAttribute('crossorigin', "anonymous");
    HEAD.appendChild(script);
  }

  function dark_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;

    const message = {
      setConfig: {
        theme: volantis.giscus.Theme
      }
    };
    const giscusIframe = document.querySelector('iframe.giscus-frame');
    giscusIframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }
  pjax_giscus();
  volantis.pjax.push(pjax_giscus);
  volantis.dark.push(dark_giscus);
</script>

    





<!-- optional -->

  <script>
  const SearchServiceDataPathRoot = ("/" || "/").endsWith("/") ?
    "/" || "/" :
    "//" || "/";
  const SearchServiceDataPath = SearchServiceDataPathRoot + "content.json";

  function loadSearchScript() {
    // see: layout/_partial/scripts/_ctrl/cdnCtrl.ejs
    return volantis.js("/js/search/hexo.js");
  }

  function loadSearchService() {
    loadSearchScript();
    document.querySelectorAll(".input.u-search-input").forEach((e) => {
      e.removeEventListener("focus", loadSearchService, false);
    });

    document.querySelectorAll(".u-search-form").forEach((e) => {
      e.addEventListener("submit", (event) => {
        event.preventDefault();
      }, false);
    });
  }

  // 打开并搜索 字符串 s
  function OpenSearch(s) {
    if (typeof SearchService === 'undefined')
      loadSearchScript().then(() => {
        SearchService.setQueryText(s);
        SearchService.search();
      });
    else {
      SearchService.setQueryText(s);
      SearchService.search();
    }
  }

  // 访问含有 ?s=xxx  的链接时打开搜索 // 与搜索引擎 structured data 相关: /scripts/helpers/structured-data/lib/config.js
  if (window.location.search && /^\?s=/g.test(window.location.search)) {
    let queryText = decodeURI(window.location.search)
      .replace(/\ /g, "-")
      .replace(/^\?s=/g, "");
    OpenSearch(queryText);
  }

  // 搜索输入框获取焦点时加载搜索
  document.querySelectorAll(".input.u-search-input").forEach((e) => {
    e.addEventListener("focus", loadSearchService, false);
  });
</script>







  <script>



  function pjax_highlightjs_copyCode(){
    if (!(document.querySelector(".highlight .code pre") ||
      document.querySelector(".article pre code"))) {
      return;
    }
    VolantisApp.utilCopyCode(".highlight .code pre, .article pre code")
  }
  volantis.requestAnimationFrame(pjax_highlightjs_copyCode)
  volantis.pjax.push(pjax_highlightjs_copyCode)

</script>












  <script>
  function load_swiper() {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.css");
    volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    volantis.swiper = new Swiper('.swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
    });
  }

  volantis.pjax.push(() => {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    if (typeof volantis.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>


<!-- pjax 标签必须存在于所有页面 否则 pjax error -->
<pjax>

</pjax>

<script>
  function listennSidebarTOC() {
    const navItems = document.querySelectorAll(".toc li");
    if (!navItems.length) return;
    let targets = []
    const sections = [...navItems].map((element) => {
      const link = element.querySelector(".toc-link");
      const target = document.getElementById(
        decodeURI(link.getAttribute("href")).replace("#", "")
      );
      targets.push(target)
      // 解除 a 标签 href 的 锚点定位, a 标签 href 的 锚点定位 会随机启用?? 产生错位???
      link.setAttribute("onclick","return false;")
      link.setAttribute("toc-action","toc-"+decodeURI(link.getAttribute("href")).replace("#", ""))
      link.setAttribute("href","/")
      // 配置 点击 触发新的锚点定位
      link.addEventListener("click", (event) => {
        event.preventDefault();
        // 这里的 addTop 是通过错位使得 toc 自动展开.
        volantis.scroll.to(target,{addTop: 5, observer:true})
        // Anchor id
        history.pushState(null, document.title, "#" + target.id);
      });
      return target;
    });

    function activateNavByIndex(target) {
      if (target.classList.contains("active-current")) return;

      document.querySelectorAll(".toc .active").forEach((element) => {
        element.classList.remove("active", "active-current");
      });
      target.classList.add("active", "active-current");
      let parent = target.parentNode;
      while (!parent.matches(".toc")) {
        if (parent.matches("li")) parent.classList.add("active");
        parent = parent.parentNode;
      }
    }

    // 方案一：
    volantis.activateNavIndex=0
    activateNavByIndex(navItems[volantis.activateNavIndex])
    volantis.scroll.push(()=>{
      if (targets[0].getBoundingClientRect().top >= 0) {
        volantis.activateNavIndex = 0
      }else if (targets[targets.length-1].getBoundingClientRect().top < 0) {
        volantis.activateNavIndex = targets.length-1
      } else {
        for (let index = 0; index < targets.length; index++) {
          const target0 = targets[index];
          const target1 = targets[(index+1)%targets.length];
          if (target0.getBoundingClientRect().top < 0&&target1.getBoundingClientRect().top >= 0) {
            volantis.activateNavIndex=index
            break;
          }
        }
      }
      activateNavByIndex(navItems[volantis.activateNavIndex])
    })

    // 方案二：
    // IntersectionObserver 不是完美精确到像素级别 也不是低延时性的
    // function findIndex(entries) {
    //   let index = 0;
    //   let entry = entries[index];
    //   if (entry.boundingClientRect.top > 0) {
    //     index = sections.indexOf(entry.target);
    //     return index === 0 ? 0 : index - 1;
    //   }
    //   for (; index < entries.length; index++) {
    //     if (entries[index].boundingClientRect.top <= 0) {
    //       entry = entries[index];
    //     } else {
    //       return sections.indexOf(entry.target);
    //     }
    //   }
    //   return sections.indexOf(entry.target);
    // }
    // function createIntersectionObserver(marginTop) {
    //   marginTop = Math.floor(marginTop + 10000);
    //   let intersectionObserver = new IntersectionObserver(
    //     (entries, observe) => {
    //       let scrollHeight = document.documentElement.scrollHeight;
    //       if (scrollHeight > marginTop) {
    //         observe.disconnect();
    //         createIntersectionObserver(scrollHeight);
    //         return;
    //       }
    //       let index = findIndex(entries);
    //       activateNavByIndex(navItems[index]);
    //     }, {
    //       rootMargin: marginTop + "px 0px -100% 0px",
    //       threshold: 0,
    //     }
    //   );
    //   sections.forEach((element) => {
    //     element && intersectionObserver.observe(element);
    //   });
    // }
    // createIntersectionObserver(document.documentElement.scrollHeight);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
  document.addEventListener("pjax:success", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
</script>



<script>
  document.onreadystatechange = function () {
    if (document.readyState == 'complete') {
      // 页面加载完毕 样式加载失败，或是当前网速慢，或是开启了省流模式
      const { saveData, effectiveType } = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {}
      if (getComputedStyle(document.querySelector("#safearea"), null)["display"] == "none" || saveData || /2g/.test(effectiveType)) {
        document.querySelectorAll(".reveal").forEach(function (e) {
          e.style["opacity"] = "1";
        });
        document.querySelector("#safearea").style["display"] = "block";
      }
    }
  }
</script>


  <script type="application/ld+json">[{"@context":"http://schema.org","@type":"Organization","name":"天天","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},{"@context":"http://schema.org","@type":"Person","name":"Luhumu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","sameAs":["https://github.com/volantis-x"],"description":"blog"},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"http://example.com/","name":"天天"}},{"@type":"ListItem","position":2,"item":{"@id":"http://example.com/categories/中间件/","name":"中间件"}},{"@type":"ListItem","position":3,"item":{"@id":"http://example.com/2023/07/31/Nginx/","name":"Nginx"}}]},{"@context":"http://schema.org","@type":"WebSite","name":"天天","url":"http://example.com/","keywords":null,"description":"blog","author":{"@type":"Person","name":"Luhumu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","description":"blog"},"publisher":{"@type":"Organization","name":"天天","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"potentialAction":{"@type":"SearchAction","name":"Site Search","target":{"@type":"EntryPoint","urlTemplate":"http://example.com?s={search_term_string}"},"query-input":"required name=search_term_string"}},{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nginx","description":"blog","inLanguage":["zh-CN","en","zh-TW","default"],"mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2023/07/31/Nginx/"},"author":{"@type":"Person","name":"Luhumu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/"},"publisher":{"@type":"Organization","name":"天天","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"url":"http://example.com/2023/07/31/Nginx/","wordCount":0,"datePublished":"2023-07-31T09:31:12.711Z","dateModified":"2023-07-31T09:58:44.362Z","articleSection":"中间件","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}}]</script>



      
        <!--
  pjax重载区域接口：
  1.  <pjax></pjax> 标签 pjax 标签必须存在于所有页面 否则 pjax error
  2.  script[data-pjax]
  3.  .pjax-reload script
  4.  .pjax
-->



<script src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/pjax/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox]):not([onclick="return false;"]):not([onclick="return!1"]):not([target="_blank"]):not([target="view_window"]):not([href$=".xml"])',
        selectors: [
          "head title",
          "head meta[name=keywords]",
          "head meta[name=description]",
          
          "#l_main",
          "#pjax-header-nav-list",
          ".pjax",
          "pjax", // <pjax></pjax> 标签
          "script[data-pjax], .pjax-reload script" // script标签添加data-pjax 或 script标签外层添加.pjax-reload 的script代码段重载
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000,
        
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      // 使用 volantis.pjax.send 方法传入pjax:send回调函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      // 使用 volantis.pjax.push 方法传入重载函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.complete.start();
    });

    document.addEventListener('pjax:error', function (e) {
      if(volantis.debug) {
        console.error(e);
        console.log('pjax error: \n' + JSON.stringify(e));
      }else{
        // 使用 volantis.pjax.error 方法传入pjax:error回调函数 参见layout/_partial/scripts/global.ejs
        volantis.pjax.method.error.start();
        window.location.href = e.triggerElement.href;
      }
    });
</script>

      
    </div>
    <!-- import body_end begin-->
    <!-- import body_end end-->
    <!-- Custom Files bodyEnd begin-->
    
    <!-- Custom Files bodyEnd end-->
    <!-- front-matter body_end begin -->
    <!-- front-matter body_end end -->
  </body>
</html>
